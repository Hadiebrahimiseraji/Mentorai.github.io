<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MentorAI - Platform CXR</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #0066cc;
            --success: #00c853;
            --danger: #d32f2f;
            --warning: #ff6d00;
            --gray-800: #1f2937;
        }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: var(--gray-800); min-height: 100vh; }
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-card { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); width: 100%; max-width: 450px; padding: 3.5rem 2.5rem; text-align: center; }
        .login-icon { font-size: 5rem; margin-bottom: 1.5rem; }
        .login-card h1 { color: var(--primary); font-size: 2.5rem; margin-bottom: 0.5rem; font-weight: 700; }
        .login-card p { color: var(--gray-800); font-size: 1rem; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; text-align: right; }
        .form-group label { display: block; margin-bottom: 0.8rem; font-weight: 600; color: var(--gray-800); }
        .form-control { width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; font-family: inherit; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1); }
        .login-btn { width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--primary) 0%, #0052a3 100%); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4); }
        .error-message { background: #ffebee; color: var(--danger); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid var(--danger); display: none; }
        .app-wrapper { display: none; background: #f8f9fa; min-height: 100vh; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, #0052a3 100%); color: white; padding: 1.5rem 2rem; position: sticky; top: 0; z-index: 1000; }
        .header-content { max-width: 1600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 2rem; font-weight: 800; }
        .logout-btn { background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; padding: 0.7rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; }
        .logout-btn:hover { background: white; color: var(--primary); }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        .progress-bar { width: 100%; height: 10px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin-bottom: 1rem; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); transition: width 0.5s ease; }
        .main-grid { display: grid; grid-template-columns: 1.3fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
        .card { background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        .card h2 { color: var(--primary); font-size: 1.5rem; margin-bottom: 1.5rem; }
        .clinical-section { background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border: 2px solid var(--primary); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .clinical-item { margin-bottom: 1.2rem; }
        .clinical-label { font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; font-size: 0.95rem; text-transform: uppercase; }
        .clinical-content { color: var(--gray-800); line-height: 1.8; font-size: 0.95rem; }
        .vitals-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
        .vital { background: white; padding: 1rem; border-radius: 10px; border-left: 4px solid var(--primary); text-align: center; }
        .vital-value { font-weight: 700; color: var(--primary); font-size: 1.2rem; }
        .vital-label { font-size: 0.8rem; color: var(--gray-800); }
        .image-viewer { background: #1f2937; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; }
        .image-container { position: relative; display: flex; align-items: center; justify-content: center; min-height: 500px; background: #1f2937; border-radius: 8px; }
        .image-wrapper { position: relative; display: inline-block; max-width: 100%; }
        .cxr-image { max-width: 100%; max-height: 500px; border-radius: 6px; display: block; filter: brightness(1); }
        .heatmap-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 100%; max-height: 500px; border-radius: 6px; display: none; pointer-events: none; }
        .image-tools { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.8rem; margin-bottom: 1.5rem; }
        .tool-btn { background: linear-gradient(135deg, #00a8e8 0%, var(--primary) 100%); color: white; border: none; padding: 0.8rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .tool-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3); }
        .tool-btn.active { background: linear-gradient(135deg, var(--success) 0%, #00a152 100%); }
        .slider-control { margin-bottom: 1rem; }
        .slider-label { font-size: 0.85rem; font-weight: 600; color: var(--gray-800); margin-bottom: 0.5rem; display: flex; justify-content: space-between; }
        input[type="range"] { width: 100%; height: 6px; border-radius: 3px; background: #e5e7eb; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; }
        .answer-section { display: none; }
        .answer-section.active { display: block; }
        .options-group { margin-bottom: 1.5rem; }
        .options-group label { display: block; margin-bottom: 1rem; font-weight: 600; color: var(--gray-800); }
        .option-item { display: flex; align-items: center; padding: 1rem; background: #f8f9fa; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 0.8rem; cursor: pointer; transition: all 0.3s ease; }
        .option-item:hover { background: #f3f4f6; border-color: var(--primary); transform: translateX(-5px); }
        .option-item input[type="radio"] { margin-left: 1rem; width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        .option-label { flex: 1; cursor: pointer; color: var(--gray-800); font-weight: 500; }
        .form-label { display: block; margin-bottom: 0.8rem; font-weight: 600; color: var(--gray-800); }
        textarea { width: 100%; min-height: 100px; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 10px; font-family: inherit; font-size: 0.95rem; }
        textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1); }
        .btn { padding: 1rem 1.5rem; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #0052a3 100%); color: white; width: 100%; margin-bottom: 1rem; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4); }
        .btn-secondary { background: #f3f4f6; color: var(--gray-800); border: 2px solid #e5e7eb; width: 100%; }
        .feedback-section { display: none; animation: slideIn 0.5s ease; }
        .feedback-section.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .ai-insights { background: linear-gradient(135deg, #fff8e1 0%, #fff3e0 100%); border: 2px solid var(--warning); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .ai-insights h3 { color: #e65100; margin-bottom: 1rem; font-size: 1.1rem; }
        .insight-item { background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem; border-right: 4px solid var(--warning); }
        .insight-title { font-weight: 700; color: #1f2937; margin-bottom: 0.4rem; }
        .insight-detail { color: var(--gray-800); font-size: 0.9rem; line-height: 1.6; }
        .teaching-box { background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); border: 2px solid var(--success); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .teaching-box h4 { color: #2e7d32; margin-bottom: 1rem; }
        .teaching-content { color: var(--gray-800); font-size: 0.95rem; white-space: pre-wrap; }
        .explainability-note { background: #e3f2fd; border-left: 4px solid var(--primary); padding: 1rem; border-radius: 8px; font-size: 0.85rem; color: #1565c0; margin-bottom: 1rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-box { background: linear-gradient(135deg, #f5f7fa 0%, #e8eef2 100%); padding: 1.5rem; border-radius: 10px; text-align: center; border-top: 3px solid var(--primary); }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--primary); margin-bottom: 0.4rem; }
        .stat-label { font-size: 0.8rem; color: var(--gray-800); font-weight: 600; text-transform: uppercase; }
        .summary-panel { background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); display: none; }
        .summary-panel.active { display: block; }
    </style>
</head>
<body>
    <div class="login-container" id="loginPage">
        <div class="login-card">
            <div class="login-icon">ğŸ¥</div>
            <h1>MentorAI</h1>
            <p>Ù¾Ù„ØªÙØ±Ù… ØªÙØ³ÛŒØ± Ø±Ø§Ø¯ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</p>
            <div class="error-message" id="errorMessage"></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                    <input type="text" id="username" class="form-control" placeholder="pilot2025" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input type="password" id="password" class="form-control" placeholder="..." required>
                </div>
                <button type="submit" class="login-btn">ğŸ” ÙˆØ±ÙˆØ¯</button>
            </form>
        </div>
    </div>

    <div class="app-wrapper" id="appWrapper">
        <header class="header">
            <div class="header-content">
                <div class="logo">ğŸ¥ MentorAI</div>
                <button class="logout-btn" onclick="handleLogout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <div class="container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div style="text-align: left; margin-bottom: 2rem; font-weight: 600; color: #1f2937;">Ù…ÙˆØ±Ø¯ <strong id="caseNum">1</strong> Ø§Ø² <strong id="totalCases">5</strong></div>

            <div class="main-grid">
                <div>
                    <div class="card" id="questionCard">
                        <h2 id="caseTitle"></h2>
                        <div class="clinical-section">
                            <div class="clinical-item">
                                <div class="clinical-label">ğŸ”´ Ø´Ú©Ø§ÛŒØª Ø§ØµÙ„ÛŒ</div>
                                <div class="clinical-content" id="chiefComplaint"></div>
                            </div>
                            <div class="clinical-item">
                                <div class="clinical-label">ğŸ“ ØªØ§Ø±ÛŒØ® Ø¨ÛŒÙ…Ø§Ø±ÛŒ</div>
                                <div class="clinical-content" id="hpi"></div>
                            </div>
                            <div class="clinical-item">
                                <div class="clinical-label">ğŸ“Š Ø¹Ú©Ø³ Ø­ÛŒØ§ØªÛŒ</div>
                                <div class="vitals-grid" id="vitals"></div>
                            </div>
                            <div class="clinical-item">
                                <div class="clinical-label">ğŸ©º Ù…Ø¹Ø§ÛŒØ¯Ù‡ ÙÛŒØ²ÛŒÚ©ÛŒ</div>
                                <div class="clinical-content" id="pe"></div>
                            </div>
                        </div>

                        <div class="image-viewer">
                            <div class="image-tools">
                                <button class="tool-btn" onclick="toggleHeatmap()" id="heatmapBtn">ğŸ”¥ Grad-CAM</button>
                                <button class="tool-btn" onclick="zoomIn()">ğŸ”+ Ø¨Ø²Ø±Ú¯</button>
                                <button class="tool-btn" onclick="zoomOut()">ğŸ”- Ú©ÙˆÚ†Ú©</button>
                            </div>
                            <div class="slider-control" id="opacityControl" style="display:none;">
                                <div class="slider-label">
                                    <span>ğŸ” Ø´ÙØ§ÙÛŒØª</span>
                                    <span id="opacityValue">60%</span>
                                </div>
                                <input type="range" id="opacity" min="0" max="100" value="60" onchange="updateOpacity()">
                            </div>
                            <div class="slider-control">
                                <div class="slider-label">
                                    <span>ğŸ’¡ Ø±ÙˆØ´Ù†Ø§ÛŒÛŒ</span>
                                    <span id="brightnessValue">100%</span>
                                </div>
                                <input type="range" id="brightness" min="50" max="150" value="100" onchange="updateImage()">
                            </div>
                            <div class="image-container">
                                <div class="image-wrapper">
                                    <img id="cxrImage" class="cxr-image" src="" alt="CXR">
                                    <canvas id="heatmapCanvas" class="heatmap-overlay"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card answer-section active" id="answerCard">
                        <h2>âœ… ØªØ´Ø®ÛŒØµ Ùˆ ØªÙØ³ÛŒØ±</h2>
                        <div class="options-group">
                            <label>ğŸ¥ ØªØ´Ø®ÛŒØµ Ø±Ø§Ø¯ÛŒÙˆÙ„ÙˆÚ˜ÛŒ:</label>
                            <div id="optionsContainer"></div>
                        </div>
                        <div class="answer-form">
                            <label class="form-label">ğŸ’¬ ØªÙˆØ¶ÛŒØ­Ø§Øª Ùˆ ÛŒØ§ÙØªÙ‡â€ŒÙ‡Ø§:</label>
                            <textarea id="answerText" placeholder="Ø§ØµÙ„ ÛŒØ§ÙØªÙ‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="submitAnswer()">âœ“ Ø«Ø¨Øª Ù¾Ø§Ø³Ø®</button>
                        <button class="btn btn-secondary" onclick="resetAnswer()">â†» Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                    </div>

                    <div class="feedback-section" id="feedbackCard">
                        <div class="explainability-note">
                            ğŸ” <strong>Ø²ÛŒØ± Ø§ÙÙ‚ Grad-CAM:</strong> Ø§ÛŒÙ† Ù†Ù‚Ø´Ù‡ ØªØ´Ø®ÛŒØµ Ù‚Ø·Ø¹ÛŒ Ù†ÛŒØ³ØªØŒ Ø¨Ù„Ú©Ù‡ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ù…Ø¯Ù„ Ø¨Ù‡ Ú©Ø¯Ø§Ù… Ù†ÙˆØ§Ø­ÛŒ ØªÙˆØ¬Ù‡ Ú©Ø±Ø¯.
                        </div>
                        <div class="card">
                            <div class="ai-insights">
                                <h3>ğŸ¤– ÙˆØ§Ø±ÛŒØ³ AI - Ù†Ù‚Ø§Ø· Ú©Ù„ÛŒØ¯ÛŒ</h3>
                                <div id="aiInsights"></div>
                            </div>
                            <div class="teaching-box">
                                <h4>ğŸ“š Ù†Ú©Ø§Øª Ø¢Ù…ÙˆØ²Ø´ÛŒ</h4>
                                <div class="teaching-content" id="teaching"></div>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <div class="stat-value" id="accuracyScore">-</div>
                                    <div class="stat-label">Ø¯Ù‚Øª %</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="timeScore">-</div>
                                    <div class="stat-label">Ø²Ù…Ø§Ù† (Ø«Ø§)</div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="nextCase()">â†’ Ù…ÙˆØ±Ø¯ Ø¨Ø¹Ø¯ÛŒ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="summary-panel" id="summaryPanel">
                <h2>ğŸ‰ Ø®ÙˆØ¨Ø§Ø²Ù…Ø§Ù†!</h2>
                <div class="stats-grid" style="margin-top: 1.5rem;">
                    <div class="stat-box">
                        <div class="stat-value" id="totalCasesCompleted">-</div>
                        <div class="stat-label">Ù…ÙˆØ§Ø±Ø¯ ØªÚ©Ù…ÛŒÙ„â€ŒØ´Ø¯Ù‡</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgAccuracy">-</div>
                        <div class="stat-label">Ø¯Ù‚Øª Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="totalTime">-</div>
                        <div class="stat-label">Ø²Ù…Ø§Ù† Ú©Ù„</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const users = {
            'pilot2025': { password: 'pilot2025', platform: 'ğŸ“š Ù¾Ù„ØªÙØ±Ù… Ø§ØµÙ„ÛŒ', cases: 5 }
        };

        const optionsPerCase = {
            normal: { correct: 'normal', options: [
                {id: 'normal', label: 'âœ… Ù‚ÙØ³Ù‡ Ø³ÛŒÙ†Ù‡ Ø·Ø¨ÛŒØ¹ÛŒ'},
                {id: 'pneumonia', label: 'Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±ÛŒÙ‡'},
                {id: 'asthma', label: 'Ø¢Ø³Ù…'},
                {id: 'atelectasis', label: 'Ø±ÛŒÙ‡ ÙØ±ÙˆÙ¾Ø§Ø´ÛŒ'}
            ]},
            pneumonia: { correct: 'pneumonia', options: [
                {id: 'pneumonia', label: 'âœ… Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±ÛŒÙ‡'},
                {id: 'normal', label: 'Ù‚ÙØ³Ù‡ Ø·Ø¨ÛŒØ¹ÛŒ'},
                {id: 'tb', label: 'Ø³Ù„'},
                {id: 'carcinoma', label: 'Ø³Ø±Ø·Ø§Ù†'}
            ]},
            pneumothorax: { correct: 'pneumothorax', options: [
                {id: 'pneumothorax', label: 'âœ… Ø±ÛŒÙ‡ ÙØ±ÙˆÙ¾Ø§Ø´ÛŒ'},
                {id: 'pleural_effusion', label: 'Ø¬Ù…Ø¹ Ø³ÛŒØ§Ù„'},
                {id: 'normal', label: 'Ø·Ø¨ÛŒØ¹ÛŒ'},
                {id: 'hemothorax', label: 'Ø®ÙˆÙ†'}
            ]},
            'pleural-effusion': { correct: 'pleural_effusion', options: [
                {id: 'pleural_effusion', label: 'âœ… Ø¬Ù…Ø¹ Ø³ÛŒØ§Ù„'},
                {id: 'pneumothorax', label: 'Ø±ÛŒÙ‡ ÙØ±ÙˆÙ¾Ø§Ø´ÛŒ'},
                {id: 'hernia', label: 'ÙØªÙ‚'},
                {id: 'collapse', label: 'ÙØ±ÙˆÙ¾Ø§Ø´ÛŒ'}
            ]},
            cardiomegaly: { correct: 'cardiomegaly', options: [
                {id: 'cardiomegaly', label: 'âœ… Ø¨Ø²Ø±Ú¯ÛŒ Ù‚Ù„Ø¨'},
                {id: 'pericardial', label: 'Ø¬Ù…Ø¹ Ù¾Ø±ÛŒÚ©Ø§Ø±Ø¯ÛŒØ§Ù„'},
                {id: 'normal', label: 'Ø·Ø¨ÛŒØ¹ÛŒ'},
                {id: 'mediastinal', label: 'ØªÙˆØ¯Ú¯ÛŒ'}
            ]}
        };

        const clinicalData = {
            normal: {
                title: 'Ù…ÙˆØ±Ø¯ 1: Ù‚ÙØ³Ù‡ Ø³ÛŒÙ†Ù‡ Ø·Ø¨ÛŒØ¹ÛŒ',
                chief_complaint: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ',
                hpi: 'Ø¨ÛŒÙ…Ø§Ø± 25 Ø³Ø§Ù„Ù‡ØŒ Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ø¦Ù…',
                vitals: [{label:'Ø¯Ù…Ø§', value:'36.5Â°C'}, {label:'Ø¶Ø±Ø¨Ø§Ù†', value:'72'}, {label:'ØªÙ†ÙØ³', value:'16'}, {label:'ÙØ´Ø§Ø±', value:'120/80'}, {label:'Ø§Ú©Ø³ÛŒÚ˜Ù†', value:'98%'}],
                pe: 'Ø§Ù†ØªØ§Ù†Ù‡ Ø·Ø¨ÛŒØ¹ÛŒ',
                image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a1/Normal_posteroanterior_%28PA%29_chest_radiograph_%28X-ray%29.jpg/512px-Normal_posteroanterior_%28PA%29_chest_radiograph_%28X-ray%29.jpg',
                insights: [{title: 'âœ“ Ø±ÛŒÙ‡â€ŒÙ‡Ø§', detail: 'Ø´ÙØ§Ù'}, {title: 'âœ“ Ù‚Ù„Ø¨', detail: 'CTR < 0.5'}, {title: 'âœ“ Ø±ÙˆØ²Ù†Ù‡', detail: 'Ø·Ø¨ÛŒØ¹ÛŒ'}],
                teaching: 'âœ… ÛŒØ§ÙØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ:\nâ€¢ Ø±ÛŒÙ‡â€ŒÙ‡Ø§ Ø´ÙØ§Ù\nâ€¢ Ù‚Ù„Ø¨ Ø¯Ø± Ø§Ù†Ø¯Ø§Ø²Ù‡\nâ€¢ Ø¯ÛŒØ§ÙØ±Ø§Ú¯Ù… Ù…Ø±Ú©Ø²ÛŒ'
            },
            pneumonia: {
                title: 'Ù…ÙˆØ±Ø¯ 2: Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±ÛŒÙ‡',
                chief_complaint: 'ØªØ¨ØŒ Ø³Ø±ÙÙ‡ØŒ ØªÙ†Ú¯ÛŒ Ù†ÙØ³',
                hpi: 'Ø¨ÛŒÙ…Ø§Ø± 40 Ø³Ø§Ù„Ù‡ØŒ ØªØ¨ 38.5Â°C',
                vitals: [{label:'Ø¯Ù…Ø§', value:'38.5Â°C'}, {label:'Ø¶Ø±Ø¨Ø§Ù†', value:'105'}, {label:'ØªÙ†ÙØ³', value:'24'}, {label:'ÙØ´Ø§Ø±', value:'130/85'}, {label:'Ø§Ú©Ø³ÛŒÚ˜Ù†', value:'92%'}],
                pe: 'Ø®Ø´ Ø±ÛŒÙˆÛŒØŒ ØªØ§Ú©ÛŒâ€ŒÙ¾Ù†Ù‡',
                image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/01/Pneumonia_x_ray.jpg/512px-Pneumonia_x_ray.jpg',
                insights: [{title: 'âš  Opacity', detail: 'ØªÛŒØ±Ú¯ÛŒ Ø¯Ø±Ù„ÙˆØ¨'}, {title: 'âš  Air Bronchogram', detail: 'Ø®Ø·ÙˆØ· Ù‡ÙˆØ§ÛŒÛŒ'}, {title: 'âš  Ú©Ù„ÛŒÙ†ÛŒÚ©ÛŒ', detail: 'ØªØ¨ + Ø±Ø§Øª'}],
                teaching: 'âš  Ø§Ù„ØªÙ‡Ø§Ø¨ Ø±ÛŒÙ‡:\nâ€¢ Opacity\nâ€¢ Air bronchogram\nâ€¢ ØªØ¨ Ø¨Ø§Ù„Ø§'
            },
            pneumothorax: {
                title: 'Ù…ÙˆØ±Ø¯ 3: Ø±ÛŒÙ‡ ÙØ±ÙˆÙ¾Ø§Ø´ÛŒ',
                chief_complaint: 'Ø¯Ø±Ø¯ Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒØŒ ØªÙ†Ú¯ÛŒ Ù†ÙØ³',
                hpi: 'Ø¨ÛŒÙ…Ø§Ø± 28 Ø³Ø§Ù„Ù‡ØŒ Ø¯Ø±Ø¯ ÛŒÚ©Ø¨Ø§Ø±Ù‡',
                vitals: [{label:'Ø¯Ù…Ø§', value:'37.2Â°C'}, {label:'Ø¶Ø±Ø¨Ø§Ù†', value:'110'}, {label:'ØªÙ†ÙØ³', value:'26'}, {label:'ÙØ´Ø§Ø±', value:'128/82'}, {label:'Ø§Ú©Ø³ÛŒÚ˜Ù†', value:'94%'}],
                pe: 'Ú©Ø§Ù‡Ø´ ØµÙˆØª Ø¯Ø± Ø³Ù…Øª Ø±Ø§Ø³Øª',
                image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Pneumothorax_CXR.jpg/512px-Pneumothorax_CXR.jpg',
                insights: [{title: 'ğŸ”´ Pleural Line', detail: 'Ø®Ø· Ø³ÙÛŒØ¯'}, {title: 'ğŸ”´ Collapsed Lung', detail: 'Ø±ÛŒÙ‡ ÙØ±ÙˆÙ¾Ø§Ø´ÛŒ'}, {title: 'ğŸ”´ Absent', detail: 'Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Øª'}],
                teaching: 'ğŸ”´ Ø±ÛŒÙ‡ ÙØ±ÙˆÙ¾Ø§Ø´ÛŒ:\nâ€¢ Pleural line\nâ€¢ Collapsed lung\nâ€¢ Absent vascular'
            },
            'pleural-effusion': {
                title: 'Ù…ÙˆØ±Ø¯ 4: Ø¬Ù…Ø¹ Ø³ÛŒØ§Ù„',
                chief_complaint: 'ØªÙ†Ú¯ÛŒ Ù†ÙØ³ ØªØ¯Ø±ÛŒØ¬ÛŒ',
                hpi: 'Ø¨ÛŒÙ…Ø§Ø± 55 Ø³Ø§Ù„Ù‡ØŒ ØªØ§Ø±ÛŒØ® Ù†Ø§Ø±Ø³Ø§ÛŒÛŒ Ù‚Ù„Ø¨',
                vitals: [{label:'Ø¯Ù…Ø§', value:'37.0Â°C'}, {label:'Ø¶Ø±Ø¨Ø§Ù†', value:'98'}, {label:'ØªÙ†ÙØ³', value:'22'}, {label:'ÙØ´Ø§Ø±', value:'140/90'}, {label:'Ø§Ú©Ø³ÛŒÚ˜Ù†', value:'93%'}],
                pe: 'Ú©Ø§Ù‡Ø´ Ø´Ù†ÙˆØ§ÛŒÛŒ Ù¾Ø§ÛŒÛŒÙ†',
                image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Pleural_effusion.jpg/512px-Pleural_effusion.jpg',
                insights: [{title: 'âš  Blunting', detail: 'Ù…Ø­Ùˆ Ø´Ø¯Ù† Ø²Ø§ÙˆÛŒÙ‡'}, {title: 'âš  Meniscus', detail: 'Ø³Ø§ÛŒÙ‡ Ø³ÛŒØ§Ù„ÛŒ'}, {title: 'âš  Fluid', detail: 'Ø³ÛŒØ§Ù„ Ù¾Ù„ÙˆØ±Ø§Ù„'}],
                teaching: 'âš  Ø¬Ù…Ø¹ Ø³ÛŒØ§Ù„:\nâ€¢ Blunting\nâ€¢ Meniscus\nâ€¢ Light criteria'
            },
            cardiomegaly: {
                title: 'Ù…ÙˆØ±Ø¯ 5: Ø¨Ø²Ø±Ú¯ÛŒ Ù‚Ù„Ø¨',
                chief_complaint: 'Ø®Ø³ØªÚ¯ÛŒØŒ ØªÙ†Ú¯ÛŒ Ù†ÙØ³',
                hpi: 'Ø¨ÛŒÙ…Ø§Ø± 60 Ø³Ø§Ù„Ù‡ØŒ ØªØ§Ø±ÛŒØ® ÙØ´Ø§Ø± Ø®ÙˆÙ†',
                vitals: [{label:'Ø¯Ù…Ø§', value:'37.1Â°C'}, {label:'Ø¶Ø±Ø¨Ø§Ù†', value:'92'}, {label:'ØªÙ†ÙØ³', value:'20'}, {label:'ÙØ´Ø§Ø±', value:'155/95'}, {label:'Ø§Ú©Ø³ÛŒÚ˜Ù†', value:'95%'}],
                pe: 'Ø¶Ø¬Ù‡ Ø³ÛŒØ³ØªÙˆÙ„ÛŒØŒ Ù†Ø¨Ø¶ Ø¶Ø¹ÛŒÙ',
                image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7a/Cardiomegally.PNG/512px-Cardiomegally.PNG',
                insights: [{title: 'ğŸ”´ CTR', detail: 'CTR > 0.5'}, {title: 'ğŸ”´ Enlarged', detail: 'Ù‚Ù„Ø¨ Ø¨Ø²Ø±Ú¯'}, {title: 'ğŸ”´ Silhouette', detail: 'ØªØºÛŒÛŒØ± Ø´Ú©Ù„'}],
                teaching: 'ğŸ”´ Ø¨Ø²Ø±Ú¯ÛŒ Ù‚Ù„Ø¨:\nâ€¢ CTR > 0.5\nâ€¢ Enlarged cardiac\nâ€¢ Dilated cardiomyopathy'
            }
        };

        let currentUser = null, caseIndex = 0, responses = [], startTime = null, zoomLevel = 1, showingHeatmap = false, selectedOption = null, maxCases = 5;
        const caseOrder = ['normal', 'pneumonia', 'pneumothorax', 'pleural-effusion', 'cardiomegaly'];

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value, p = document.getElementById('password').value, err = document.getElementById('errorMessage');
            if (users[u] && users[u].password === p) {
                currentUser = u;
                maxCases = users[u].cases;
                document.getElementById('totalCases').textContent = maxCases;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appWrapper').style.display = 'block';
                loadCase();
            } else {
                err.style.display = 'block';
                err.textContent = 'âŒ Ù†Ø§Ù… ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡';
            }
        }

        function handleLogout() { if (confirm('Ø§Ø² Ø®Ø±ÙˆØ¬ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) location.reload(); }

        function loadCase() {
            if (caseIndex >= maxCases) { showSummary(); return; }
            const caseId = caseOrder[caseIndex], data = clinicalData[caseId], opts = optionsPerCase[caseId];
            startTime = Date.now(); selectedOption = null;
            document.getElementById('caseNum').textContent = caseIndex + 1;
            document.getElementById('caseTitle').textContent = data.title;
            document.getElementById('chiefComplaint').textContent = data.chief_complaint;
            document.getElementById('hpi').textContent = data.hpi;
            document.getElementById('pe').textContent = data.pe;
            document.getElementById('vitals').innerHTML = data.vitals.map(v => `<div class="vital"><div class="vital-value">${v.value}</div><div class="vital-label">${v.label}</div></div>`).join('');
            document.getElementById('optionsContainer').innerHTML = opts.options.map(opt => `<div class="option-item" onclick="selectOption('${opt.id}', event)"><input type="radio" name="diagnosis" value="${opt.id}"><label class="option-label">${opt.label}</label></div>`).join('');
            const img = document.getElementById('cxrImage');
            img.src = data.image; img.style.transform = 'scale(1)'; zoomLevel = 1;
            document.getElementById('brightness').value = 100;
            updateImage();
            document.getElementById('answerText').value = '';
            document.getElementById('questionCard').style.display = 'block';
            document.getElementById('answerCard').classList.add('active');
            document.getElementById('feedbackCard').classList.remove('active');
            document.getElementById('heatmapBtn').textContent = 'ğŸ”¥ Grad-CAM';
            document.getElementById('heatmapCanvas').style.display = 'none';
            document.getElementById('opacityControl').style.display = 'none';
            showingHeatmap = false;
            updateProgress();
        }

        function selectOption(id, e) {
            selectedOption = id;
            document.querySelectorAll('input[name="diagnosis"]').forEach(el => el.checked = false);
            e.currentTarget.querySelector('input[type="radio"]').checked = true;
        }

        function submitAnswer() {
            if (!selectedOption) { alert('Ù„Ø·ÙØ§ Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
            const answer = document.getElementById('answerText').value.trim();
            if (!answer) { alert('Ù„Ø·ÙØ§ ØªÙˆØ¶ÛŒØ­ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯'); return; }
            const caseId = caseOrder[caseIndex], opts = optionsPerCase[caseId], time = Math.round((Date.now() - startTime) / 1000), accuracy = selectedOption === opts.correct ? 100 : 40;
            responses.push({caseId, option: selectedOption, answer, time, accuracy});
            document.getElementById('answerCard').classList.remove('active');
            document.getElementById('feedbackCard').classList.add('active');
            const data = clinicalData[caseId];
            document.getElementById('aiInsights').innerHTML = data.insights.map(i => `<div class="insight-item"><div class="insight-title">${i.title}</div><div class="insight-detail">${i.detail}</div></div>`).join('');
            document.getElementById('teaching').textContent = data.teaching;
            document.getElementById('accuracyScore').textContent = accuracy + '%';
            document.getElementById('timeScore').textContent = time;
        }

        function resetAnswer() {
            document.getElementById('answerText').value = '';
            selectedOption = null;
            document.querySelectorAll('input[name="diagnosis"]').forEach(el => el.checked = false);
        }

        function nextCase() { caseIndex++; loadCase(); }
        function updateProgress() { document.getElementById('progressFill').style.width = ((caseIndex + 1) / maxCases) * 100 + '%'; }

        function toggleHeatmap() {
            showingHeatmap = !showingHeatmap;
            const canvas = document.getElementById('heatmapCanvas'), img = document.getElementById('cxrImage'), opacityControl = document.getElementById('opacityControl');
            if (showingHeatmap) {
                opacityControl.style.display = 'block';
                canvas.width = img.offsetWidth || 400; canvas.height = img.offsetHeight || 400;
                const ctx = canvas.getContext('2d'), grad = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width);
                grad.addColorStop(0, 'rgba(255, 0, 0, 0.6)');
                grad.addColorStop(0.4, 'rgba(255, 165, 0, 0.4)');
                grad.addColorStop(0.7, 'rgba(0, 255, 255, 0.2)');
                grad.addColorStop(1, 'rgba(0, 0, 255, 0.1)');
                ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height);
                canvas.style.display = 'block';
                document.getElementById('heatmapBtn').classList.add('active');
            } else {
                opacityControl.style.display = 'none';
                canvas.style.display = 'none';
                document.getElementById('heatmapBtn').classList.remove('active');
            }
        }

        function updateOpacity() { const opacity = document.getElementById('opacity').value; document.getElementById('opacityValue').textContent = opacity + '%'; document.getElementById('heatmapCanvas').style.opacity = opacity / 100; }
        function zoomIn() { zoomLevel = Math.min(zoomLevel + 0.2, 3); document.getElementById('cxrImage').style.transform = `scale(${zoomLevel})`; }
        function zoomOut() { zoomLevel = Math.max(zoomLevel - 0.2, 1); document.getElementById('cxrImage').style.transform = `scale(${zoomLevel})`; }
        function updateImage() { const b = document.getElementById('brightness').value; document.getElementById('cxrImage').style.filter = `brightness(${b}%)`; document.getElementById('brightnessValue').textContent = b + '%'; }

        function showSummary() {
            document.getElementById('questionCard').style.display = 'none';
            document.getElementById('answerCard').classList.remove('active');
            document.getElementById('feedbackCard').classList.remove('active');
            document.getElementById('summaryPanel').classList.add('active');
            const avg = responses.length > 0 ? Math.round(responses.reduce((s, r) => s + r.accuracy, 0) / responses.length) : 0, time = Math.round(responses.reduce((s, r) => s + r.time, 0) / 60);
            document.getElementById('totalCasesCompleted').textContent = responses.length;
            document.getElementById('avgAccuracy').textContent = avg + '%';
            document.getElementById('totalTime').textContent = time + ' Ø¯Ù‚ÛŒÙ‚Ù‡';
        }
    </script>
</body>
</html>