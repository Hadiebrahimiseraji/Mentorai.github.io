<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="پلتفرم آموزشی–پژوهشی تفسیر CXR (صرفاً آموزشی/پژوهشی؛ غیرقابل استفاده بالینی)" />
  <title>پلتفرم آموزشی–پژوهشی تفسیر CXR | RCT</title>

  <!-- TailwindCSS CDN (برای استقرار تولیدی، پیشنهاد می‌شود نسخه build شده استفاده شود) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* بهبودهای کوچک RTL/خوانایی */
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .focus-ring:focus { outline: 3px solid rgba(59,130,246,.6); outline-offset: 2px; }
    .kbd { border: 1px solid rgb(203,213,225); border-bottom-width: 2px; padding: 0 .4rem; border-radius: .4rem; background: rgb(248,250,252); }
    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .6rem; border-radius:999px; font-size:.75rem; border:1px solid; }
    .hidden-print { display: block; }
    @media print {
      .hidden-print { display: none !important; }
      a:after { content: " (" attr(href) ")"; font-size: 10px; color: #555; }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- Top Warning Banner -->
  <div class="hidden-print bg-rose-700 text-white">
    <div class="max-w-7xl mx-auto px-4 py-2 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div class="font-semibold">
        هشدار: این سامانه «صرفاً آموزشی و پژوهشی» است و برای تصمیم‌گیری بالینی/درمانی استفاده نمی‌شود.
      </div>
      <div class="text-sm opacity-95">
        استفاده از داده بیمار واقعی، PHI، یا توصیه درمانی در این سامانه ممنوع است.
      </div>
    </div>
  </div>

  <!-- App Shell -->
  <header class="hidden-print bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h1 class="text-lg md:text-xl font-bold">پلتفرم آموزشی–پژوهشی تفسیر رادیوگرافی قفسه سینه (CXR)</h1>
          <p class="text-sm text-slate-600">طراحی‌شده برای اجرای کارآزمایی تصادفی‌سازی‌شده آموزشی (Pilot + Main RCT) — غیرقابل استفاده بالینی</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <span id="badgeRole" class="badge border-slate-300 text-slate-700 bg-slate-100">نقش: <b>میهمان</b></span>
        <span id="badgeArm" class="badge border-slate-300 text-slate-700 bg-slate-100">گروه: <b>نامشخص</b></span>
        <span id="badgePhase" class="badge border-slate-300 text-slate-700 bg-slate-100">فاز: <b>—</b></span>
        <span id="badgeAI" class="badge border-slate-300 text-slate-700 bg-slate-100">AI: <b>—</b></span>
        <button id="btnOpenConsent" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800 focus-ring">نمایش اطلاعیه اخلاقی</button>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white">
      <div class="max-w-7xl mx-auto px-4 pb-4 flex flex-wrap gap-2">
        <button data-route="home" class="navbtn px-3 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 text-sm focus-ring">صفحه اصلی و پروتکل</button>
        <button data-route="login" class="navbtn px-3 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 text-sm focus-ring">ورود/پروفایل پژوهش</button>
        <button data-route="pretest" class="navbtn px-3 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 text-sm focus-ring">پیش‌آزمون</button>
        <button data-route="training" class="navbtn px-3 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 text-sm focus-ring">آموزش</button>
        <button data-route="posttest" class="navbtn px-3 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 text-sm focus-ring">پس‌آزمون</button>
        <button data-route="surveys" class="navbtn px-3 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 text-sm focus-ring">SUS / NPS</button>
        <button data-route="research" class="navbtn px-3 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 text-sm focus-ring">داشبورد پژوهشگر</button>
        <button data-route="admin" class="navbtn px-3 py-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 text-sm focus-ring">ادمین/پیکربندی</button>
      </div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Consent / Ethics Modal -->
    <section id="consentModal" class="hidden fixed inset-0 bg-black/50 z-50">
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
          <div class="p-4 border-b border-slate-200 flex items-center justify-between gap-3">
            <h2 class="text-lg font-bold">اطلاعیه اخلاقی، حریم خصوصی و محدودیت استفاده</h2>
            <button id="btnCloseConsent" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm focus-ring">بستن</button>
          </div>
          <div class="p-5 space-y-4 text-sm leading-7">
            <div class="p-4 rounded-xl bg-rose-50 border border-rose-200">
              <p class="font-semibold text-rose-800">این سامانه صرفاً برای آموزش و پژوهش طراحی شده است.</p>
              <ul class="mt-2 list-disc pr-6 text-rose-900">
                <li>استفاده برای تصمیم‌گیری بالینی، تشخیص واقعی بیمار، یا توصیه درمانی ممنوع است.</li>
                <li>خروجی «هوش مصنوعی» در صورت نمایش، کمک‌یار آموزشی است و جایگزین قضاوت انسانی نیست.</li>
                <li>هیچ داده‌ی شناسایی‌کننده بیمار (PHI) و هیچ داده حساس فردی نباید وارد سامانه شود.</li>
              </ul>
            </div>

            <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
              <p class="font-semibold">حداقل‌گرایی داده و شبه‌ناشناس‌سازی</p>
              <p>شناسه‌ها به‌صورت مستعار (Pseudonymized) ذخیره می‌شوند. سامانه از شما نام/کدملی/اطلاعات تماس را درخواست نمی‌کند. پاسخ‌ها برای تحلیل پژوهشی و مطابق پروتکل استفاده می‌شوند.</p>
            </div>

            <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
              <p class="font-semibold">حقوق شرکت‌کننده</p>
              <ul class="mt-2 list-disc pr-6">
                <li>مشارکت داوطلبانه است و عدم مشارکت نباید پیامد آموزشی/اداری برای شما داشته باشد.</li>
                <li>می‌توانید در هر زمان از ادامه خارج شوید (طبق سازوکار تعریف‌شده در پروتکل مرکز).</li>
                <li>تمام تعاملات کلیدی برای ممیزی پژوهشی ثبت می‌شود (Audit Log).</li>
              </ul>
            </div>

            <div class="flex items-center gap-3 justify-end">
              <label class="flex items-center gap-2 select-none">
                <input id="chkConsent" type="checkbox" class="w-4 h-4" />
                <span>مطالب بالا را خواندم و می‌پذیرم (صرفاً آموزشی/پژوهشی).</span>
              </label>
              <button id="btnAcceptConsent" class="px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 focus-ring disabled:opacity-50" disabled>
                ثبت پذیرش
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- HOME / PROTOCOL -->
    <section id="route-home" class="route space-y-6">
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <h2 class="text-xl font-bold">پروتکل مطالعه و منطق سامانه</h2>
        <p class="mt-2 text-slate-700 leading-7">
          این پلتفرم برای اجرای کارآزمایی آموزشی–بالینی تصادفی‌سازی‌شده در حوزه تفسیر CXR طراحی شده است. مسیر استاندارد شامل
          <b>پیش‌آزمون</b>، <b>مرحله آموزش</b> و <b>پس‌آزمون</b> است. در آزمون‌ها، هوش مصنوعی طبق پروتکل <b>قفل</b> است.
        </p>

        <div class="mt-4 grid md:grid-cols-3 gap-4">
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">هدف پژوهشی</h3>
            <p class="mt-2 text-sm text-slate-700 leading-7">
              سنجش اثر «کمک‌یار آموزشی مبتنی بر AI» در مقایسه با آموزش استاندارد بر عملکرد تفسیر CXR، زمان تفسیر، کیفیت گزارش و تجربه کاربری.
            </p>
          </div>
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">منع استفاده بالینی</h3>
            <p class="mt-2 text-sm text-slate-700 leading-7">
              سامانه برای تصمیم‌گیری بالینی طراحی نشده است. هرگونه استفاده درمانی/تشخیصی واقعی ممنوع است و در UI به‌صورت مستمر یادآوری می‌شود.
            </p>
          </div>
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">قفل نسخه (Locked)</h3>
            <p class="mt-2 text-sm text-slate-700 leading-7">
              در طول جمع‌آوری داده‌های RCT، نسخه منطق سامانه و تنظیمات AI باید ثابت بماند؛ هر تغییر پس از پایان داده‌گیری اعمال می‌شود.
            </p>
          </div>
        </div>

        <div class="mt-6 p-4 rounded-xl bg-amber-50 border border-amber-200">
          <p class="font-semibold text-amber-900">راهنمای سریع برای فراگیر</p>
          <ol class="mt-2 list-decimal pr-6 text-sm leading-7 text-amber-950">
            <li>ابتدا در بخش «ورود/پروفایل پژوهش» شناسه مستعار خود را بسازید و پذیرش اخلاقی را ثبت کنید.</li>
            <li>در «پیش‌آزمون» بدون AI پاسخ دهید (زمان به‌صورت خودکار ثبت می‌شود).</li>
            <li>در «آموزش» بسته به گروه مطالعه، AI ممکن است برای یادگیری فعال باشد (در آزمون‌ها همیشه قفل است).</li>
            <li>در «پس‌آزمون» مجدداً بدون AI پاسخ دهید.</li>
            <li>در پایان، پرسشنامه‌های SUS و NPS را تکمیل کنید.</li>
          </ol>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <h3 class="text-lg font-bold">چارچوب آموزشی استاندارد: ABCDE در CXR (راهنمای آموزشی)</h3>
        <p class="mt-2 text-slate-700 text-sm leading-7">
          این سامانه برای استانداردسازی فرایند مشاهده و گزارش‌نویسی از رویکرد ABCDE استفاده می‌کند.
          هدف، ایجاد زبان مشترک، کاهش خطاهای غفلت (omission) و افزایش قابلیت اندازه‌گیری عملکرد است.
        </p>

        <div class="mt-4 grid lg:grid-cols-5 gap-3 text-sm">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><b>A</b>: Airway / راه‌های هوایی (تراکئا، انحراف، کارینا)</div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><b>B</b>: Breathing / ریه و پلور (ارتشاح، پنوموتوراکس، افیوژن)</div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><b>C</b>: Circulation / قلب و مدیاستن (اندازه قلب، کانتور، مدیاستن)</div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><b>D</b>: Diaphragm / دیافراگم (زاویه‌ها، گنبدها، هوا زیر دیافراگم)</div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200"><b>E</b>: Everything else / سایر (استخوان، بافت نرم، خطوط/لوله‌ها)</div>
        </div>
      </div>
    </section>

    <!-- LOGIN / PROFILE -->
    <section id="route-login" class="route hidden space-y-6">
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <h2 class="text-xl font-bold">ورود و پروفایل پژوهشی (بدون اطلاعات شناسایی)</h2>
        <p class="mt-2 text-slate-700 leading-7 text-sm">
          در این نسخه دمو، «ورود» به‌صورت ایجاد یک شناسه مستعار انجام می‌شود. در استقرار واقعی، اتصال به سامانه احراز هویت سازمانی با سیاست‌های امنیتی توصیه می‌شود.
        </p>

        <div class="mt-4 grid md:grid-cols-2 gap-4">
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">۱) ایجاد/انتخاب شناسه مستعار</h3>
            <div class="mt-3 space-y-3">
              <label class="block text-sm">
                شناسه شرکت‌کننده (Participant ID) — مستعار
                <input id="inpParticipantId" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 focus-ring" placeholder="مثال: P-9F3A2" />
              </label>
              <label class="block text-sm">
                سطح آموزشی
                <select id="selLevel" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 focus-ring">
                  <option value="">انتخاب…</option>
                  <option>دانشجوی پزشکی</option>
                  <option>اینترن</option>
                  <option>دستیار سال ۱</option>
                  <option>دستیار سال ۲+</option>
                  <option>پزشک عمومی</option>
                  <option>سایر</option>
                </select>
              </label>
              <label class="block text-sm">
                مرکز (کد مرکز پژوهش) — بدون نام
                <input id="inpSiteCode" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 focus-ring" placeholder="مثال: SITE-03" />
              </label>
              <button id="btnSaveProfile" class="w-full px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 focus-ring">ذخیره پروفایل</button>
              <p class="text-xs text-slate-600 leading-6">
                توجه: از واردکردن نام، شماره تماس، ایمیل شخصی یا هر داده شناسایی‌کننده خودداری کنید.
              </p>
            </div>
          </div>

          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">۲) تنظیمات مطالعه (برای دمو)</h3>
            <p class="mt-2 text-sm text-slate-700 leading-7">
              در RCT واقعی، تخصیص گروه توسط سازوکار تصادفی‌سازی و به‌صورت پنهان انجام می‌شود. اینجا صرفاً برای نمایش گردش‌کار دمو است.
            </p>

            <div class="mt-3 space-y-3">
              <label class="block text-sm">
                نقش
                <select id="selRole" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 focus-ring">
                  <option value="student">دانشجو/فراگیر</option>
                  <option value="researcher">پژوهشگر</option>
                  <option value="admin">ادمین</option>
                </select>
              </label>

              <label class="block text-sm">
                بازوی مطالعه (Arm)
                <select id="selArm" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 focus-ring">
                  <option value="">نامشخص</option>
                  <option value="control">کنترل (آموزش استاندارد بدون AI)</option>
                  <option value="intervention">مداخله (آموزش استاندارد + AI در آموزش)</option>
                </select>
              </label>

              <button id="btnSaveStudySettings" class="w-full px-4 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 focus-ring">
                اعمال تنظیمات دمو
              </button>

              <div class="mt-3 p-3 rounded-xl bg-white border border-slate-200">
                <p class="text-sm font-semibold">وضعیت پذیرش اخلاقی</p>
                <div class="mt-2 flex items-center justify-between gap-2">
                  <span id="consentStatus" class="text-sm text-slate-700">ثبت نشده</span>
                  <button id="btnShowConsent2" class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 text-sm focus-ring">نمایش/ثبت</button>
                </div>
              </div>

              <div class="mt-3 p-3 rounded-xl bg-white border border-slate-200">
                <p class="text-sm font-semibold">میانبرهای کیفیت داده</p>
                <ul class="mt-2 text-xs text-slate-600 leading-6 list-disc pr-6">
                  <li>در آزمون‌ها به حدس کور پاسخ ندهید؛ در صورت عدم قطعیت، اطمینان را پایین‌تر ثبت کنید.</li>
                  <li>در آموزش (در صورت مجاز بودن AI) ابتدا پاسخ مستقل ثبت کنید، سپس AI را ببینید و در صورت نیاز اصلاح کنید.</li>
                </ul>
              </div>

            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PRETEST -->
    <section id="route-pretest" class="route hidden space-y-6">
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
          <div>
            <h2 class="text-xl font-bold">پیش‌آزمون (AI قفل است)</h2>
            <p class="mt-2 text-sm text-slate-700 leading-7">
              این بخش برای سنجش خط پایه عملکرد تفسیر CXR است. مطابق پروتکل، در پیش‌آزمون هیچ خروجی AI نمایش داده نمی‌شود.
            </p>
          </div>
          <div class="p-3 rounded-xl bg-rose-50 border border-rose-200 text-rose-900 text-sm">
            وضعیت AI: <b>قفل پروتکلی</b> (غیرقابل فعال‌سازی)
          </div>
        </div>

        <div class="mt-4 grid lg:grid-cols-2 gap-4">
          <!-- Case Viewer -->
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <div class="flex items-center justify-between gap-2">
              <h3 class="font-bold">نمایش کیس (دمو)</h3>
              <div class="text-xs text-slate-600 mono">
                CaseID: <span id="pre_caseId">CXR-PT-001</span>
              </div>
            </div>

            <div class="mt-3 rounded-xl bg-white border border-slate-200 p-3">
              <!-- Demo Image Placeholder -->
              <div class="aspect-[4/3] rounded-lg bg-slate-100 border border-dashed border-slate-300 flex items-center justify-center text-slate-600 text-sm">
                تصویر CXR (دمو) — در استقرار واقعی از DICOMweb/تصاویر ناشناس استفاده می‌شود
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <button class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 text-sm focus-ring" id="btnPreStart">شروع تایمر</button>
                <button class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 text-sm focus-ring" id="btnPreStop">توقف/ثبت زمان</button>
                <span class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm mono">Time: <span id="pre_timer">00:00</span></span>
              </div>

              <div class="mt-3 p-3 rounded-xl bg-amber-50 border border-amber-200 text-sm leading-7">
                <b>یادآوری:</b> رویکرد ABCDE را دنبال کنید. سپس گزارش ساختاریافته را کامل کنید.
              </div>
            </div>

            <div class="mt-3 p-3 rounded-xl bg-white border border-slate-200">
              <p class="text-sm font-semibold">دکمه AI (غیرفعال در آزمون)</p>
              <button disabled class="mt-2 w-full px-4 py-2 rounded-lg bg-slate-200 text-slate-500 text-sm cursor-not-allowed">
                نمایش خروجی AI (در آزمون‌ها قفل است)
              </button>
              <p class="mt-2 text-xs text-slate-600 leading-6">
                هر تلاش برای فعال‌سازی AI در آزمون باید ثبت و بررسی شود. در این دمو، قفل سخت‌افزاری/نرم‌افزاری اعمال شده است.
              </p>
            </div>
          </div>

          <!-- Response Form -->
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">فرم پاسخ (پیش‌آزمون)</h3>

            <form id="formPretest" class="mt-3 space-y-4">
              <fieldset class="p-3 rounded-xl bg-white border border-slate-200">
                <legend class="px-2 text-sm font-semibold">چک‌لیست ABCDE</legend>
                <div class="mt-2 grid md:grid-cols-2 gap-2 text-sm">
                  <label class="flex items-center gap-2"><input type="checkbox" name="abcde_A" class="w-4 h-4"> A: راه‌های هوایی بررسی شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="abcde_B" class="w-4 h-4"> B: ریه/پلور بررسی شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="abcde_C" class="w-4 h-4"> C: قلب/مدیاستن بررسی شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="abcde_D" class="w-4 h-4"> D: دیافراگم بررسی شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="abcde_E" class="w-4 h-4"> E: سایر (استخوان/لوله‌ها/بافت نرم) بررسی شد</label>
                </div>
              </fieldset>

              <fieldset class="p-3 rounded-xl bg-white border border-slate-200">
                <legend class="px-2 text-sm font-semibold">یافته‌های هدف (صرفاً برای پژوهش)</legend>
                <p class="text-xs text-slate-600 leading-6 mt-1">
                  این گزینه‌ها برای ساختاردهی پاسخ پژوهشی است و «لیست کامل تشخیص‌ها» تلقی نمی‌شود.
                </p>
                <div class="mt-2 grid md:grid-cols-2 gap-2 text-sm">
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_normal" class="w-4 h-4"> نرمال/بدون یافته مهم</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_consolidation" class="w-4 h-4"> ارتشاح/Consolidation</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_pleural_effusion" class="w-4 h-4"> افیوژن پلور</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_pneumothorax" class="w-4 h-4"> پنوموتوراکس</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_nodule" class="w-4 h-4"> ندول/توده</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_cardiomegaly" class="w-4 h-4"> بزرگی قلب</label>
                </div>
              </fieldset>

              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <label class="block text-sm font-semibold">گزارش ساختاریافته (الزام پژوهشی)</label>
                <p class="text-xs text-slate-600 leading-6 mt-1">
                  قالب پیشنهادی: کیفیت تصویر → یافته‌ها (ABCDE) → تشخیص اصلی/دیفرانسیل محدود → جمع‌بندی.
                </p>
                <textarea name="structured_report" rows="6" class="mt-2 w-full px-3 py-2 rounded-lg border border-slate-300 focus-ring" placeholder="متن گزارش را اینجا بنویسید..."></textarea>
              </div>

              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <label class="block text-sm font-semibold">اطمینان (0 تا 100)</label>
                <input name="confidence" type="range" min="0" max="100" value="50" class="mt-2 w-full" />
                <div class="mt-1 text-xs text-slate-600">عدد اطمینان: <span id="pre_confVal" class="mono">50</span></div>
              </div>

              <div class="flex flex-col md:flex-row gap-2">
                <button type="submit" class="w-full px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 focus-ring">ثبت پاسخ پیش‌آزمون</button>
                <button type="button" id="btnPreNextCase" class="w-full px-4 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 focus-ring">کیس بعدی (دمو)</button>
              </div>

              <div class="text-xs text-slate-600 leading-6">
                ثبت پاسخ شامل زمان تفسیر، گزینه‌های انتخابی، متن گزارش و اطمینان است. داده‌ها با شناسه مستعار ذخیره می‌شود.
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- TRAINING -->
    <section id="route-training" class="route hidden space-y-6">
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
          <div>
            <h2 class="text-xl font-bold">آموزش (AI فقط در بازوی مداخله مجاز است)</h2>
            <p class="mt-2 text-sm text-slate-700 leading-7">
              در هر کیس آموزشی: ابتدا تفسیر مستقل ثبت می‌شود، سپس (در صورت مجاز بودن) خروجی AI و توضیح‌پذیری نمایش داده می‌شود
              و امکان اصلاح پاسخ فراهم است. در پایان، نکات آموزشی و مرجع استاندارد (در استقرار واقعی) ارائه می‌گردد.
            </p>
          </div>
          <div id="trainingAIBox" class="p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm">
            وضعیت AI در آموزش: <b id="trainingAIStatus">—</b>
          </div>
        </div>

        <div class="mt-4 grid lg:grid-cols-2 gap-4">
          <!-- Case Viewer -->
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <div class="flex items-center justify-between gap-2">
              <h3 class="font-bold">نمایش کیس آموزشی</h3>
              <div class="text-xs text-slate-600 mono">
                CaseID: <span id="tr_caseId">CXR-TR-001</span>
              </div>
            </div>

            <div class="mt-3 rounded-xl bg-white border border-slate-200 p-3">
              <div class="aspect-[4/3] rounded-lg bg-slate-100 border border-dashed border-slate-300 flex items-center justify-center text-slate-600 text-sm">
                تصویر CXR آموزشی (دمو)
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <button class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 text-sm focus-ring" id="btnTrStart">شروع تایمر</button>
                <button class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 text-sm focus-ring" id="btnTrStop">توقف/ثبت زمان</button>
                <span class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm mono">Time: <span id="tr_timer">00:00</span></span>
              </div>

              <!-- AI Panel -->
              <div class="mt-4 p-3 rounded-xl border border-slate-200 bg-slate-50">
                <div class="flex items-center justify-between gap-2">
                  <p class="text-sm font-semibold">پنل AI (کمک‌یار آموزشی)</p>
                  <button id="btnShowAI" class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 text-sm focus-ring">
                    نمایش AI / XAI
                  </button>
                </div>
                <p class="mt-2 text-xs text-slate-600 leading-6">
                  خروجی AI ممکن است خطا داشته باشد، سوگیری داشته باشد، یا در برخی الگوها ناپایدار باشد. این خروجی «تشخیص پزشکی» نیست.
                </p>

                <div id="aiOutput" class="hidden mt-3 space-y-3">
                  <div class="p-3 rounded-xl bg-white border border-slate-200">
                    <p class="text-sm font-semibold">پیش‌بینی‌های چندبرچسبه (دمو)</p>
                    <div class="mt-2 space-y-2 text-sm">
                      <div class="flex items-center justify-between"><span>Consolidation</span><span class="mono">0.62</span></div>
                      <div class="flex items-center justify-between"><span>Pleural effusion</span><span class="mono">0.18</span></div>
                      <div class="flex items-center justify-between"><span>Pneumothorax</span><span class="mono">0.07</span></div>
                      <div class="flex items-center justify-between"><span>Nodule/Mass</span><span class="mono">0.21</span></div>
                      <div class="flex items-center justify-between"><span>Cardiomegaly</span><span class="mono">0.12</span></div>
                    </div>
                    <p class="mt-2 text-xs text-slate-600">اعداد نمایشی هستند و برای دمو استفاده می‌شوند (بدون ادعای کارایی).</p>
                  </div>

                  <div class="p-3 rounded-xl bg-white border border-slate-200">
                    <p class="text-sm font-semibold">توضیح‌پذیری (XAI) — نقشه توجه (دمو)</p>
                    <div class="mt-2 aspect-[4/3] rounded-lg bg-slate-100 border border-dashed border-slate-300 flex items-center justify-center text-slate-600 text-sm">
                      Heatmap دمو — در استقرار واقعی از روش‌های معتبر توضیح‌پذیری استفاده می‌شود
                    </div>
                    <label class="mt-2 flex items-center gap-2 text-sm">
                      <input id="chkXAIViewed" type="checkbox" class="w-4 h-4" />
                      نقشه توضیح‌پذیری را مشاهده کردم
                    </label>
                  </div>

                  <div class="p-3 rounded-xl bg-amber-50 border border-amber-200">
                    <p class="text-sm font-semibold text-amber-900">نکته آموزشی (دمو)</p>
                    <p class="mt-2 text-sm text-amber-950 leading-7">
                      تمرین هدف: توصیف یافته‌ها با زبان ساختاریافته و توجه به پلور و زاویه‌های کوستوفرنیک، حتی در موارد ظاهراً ساده.
                    </p>
                  </div>
                </div>
              </div>

              <div class="mt-3 p-3 rounded-xl bg-white border border-slate-200">
                <p class="text-sm font-semibold">مرجع استاندارد و بازخورد (دمو)</p>
                <p class="mt-2 text-xs text-slate-600 leading-6">
                  در استقرار واقعی، مرجع استاندارد توسط رادیولوژیست‌ها/داوری چندگانه تهیه و به‌صورت کنترل‌شده نمایش داده می‌شود.
                </p>
                <button id="btnShowGold" class="mt-2 w-full px-4 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 text-sm focus-ring">
                  نمایش بازخورد/مرجع (دمو)
                </button>
                <div id="goldBox" class="hidden mt-3 p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm leading-7">
                  <b>Gold (دمو):</b> یافته آموزشی نمونه. این متن جایگزین مرجع واقعی نیست و فقط برای نمایش جریان آموزش است.
                </div>
              </div>
            </div>
          </div>

          <!-- Training Form -->
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">ثبت پاسخ در آموزش (قبل/بعد از AI)</h3>
            <p class="mt-2 text-sm text-slate-700 leading-7">
              ابتدا «پاسخ مستقل» را ثبت کنید. سپس اگر AI مجاز بود، آن را ببینید و «پاسخ پس از AI» را در صورت تغییر ثبت کنید.
              در بازوی کنترل، بخش AI قفل است و پاسخ پس از AI باید خالی بماند.
            </p>

            <form id="formTraining" class="mt-3 space-y-4">
              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <p class="text-sm font-semibold">پاسخ مستقل (Pre-AI)</p>
                <textarea name="pre_ai_report" rows="5" class="mt-2 w-full px-3 py-2 rounded-lg border border-slate-300 focus-ring" placeholder="گزارش/یافته‌های مستقل خود را ثبت کنید..."></textarea>

                <label class="block text-sm font-semibold mt-3">اطمینان (0 تا 100)</label>
                <input name="pre_ai_confidence" type="range" min="0" max="100" value="50" class="mt-2 w-full" />
                <div class="mt-1 text-xs text-slate-600">عدد اطمینان: <span id="tr_preConfVal" class="mono">50</span></div>
              </div>

              <div id="postAIBox" class="p-3 rounded-xl bg-white border border-slate-200">
                <p class="text-sm font-semibold">پاسخ پس از مشاهده AI (Post-AI)</p>
                <p class="mt-1 text-xs text-slate-600 leading-6">
                  این بخش فقط در بازوی مداخله و فقط در آموزش قابل تکمیل است.
                </p>
                <textarea id="post_ai_report" name="post_ai_report" rows="5" class="mt-2 w-full px-3 py-2 rounded-lg border border-slate-300 focus-ring" placeholder="در صورت تغییر، گزارش اصلاح‌شده را ثبت کنید..."></textarea>

                <label class="block text-sm font-semibold mt-3">اطمینان پس از AI (0 تا 100)</label>
                <input id="post_ai_confidence" name="post_ai_confidence" type="range" min="0" max="100" value="50" class="mt-2 w-full" />
                <div class="mt-1 text-xs text-slate-600">عدد اطمینان: <span id="tr_postConfVal" class="mono">50</span></div>

                <div class="mt-3 grid md:grid-cols-2 gap-2 text-sm">
                  <label class="flex items-center gap-2"><input type="checkbox" name="ai_changed_decision" class="w-4 h-4"> پس از AI تصمیم/گزارش تغییر کرد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="ai_increased_confidence" class="w-4 h-4"> AI اطمینان را افزایش داد</label>
                </div>
              </div>

              <fieldset class="p-3 rounded-xl bg-white border border-slate-200">
                <legend class="px-2 text-sm font-semibold">ثبت تعامل با UI (برای تحلیل کاربردپذیری)</legend>
                <div class="mt-2 grid md:grid-cols-2 gap-2 text-sm">
                  <label class="flex items-center gap-2"><input type="checkbox" name="used_zoom" class="w-4 h-4"> از ابزار نمایش/زوم استفاده شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="used_xai" class="w-4 h-4"> از XAI استفاده شد/دیده شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="read_tips" class="w-4 h-4"> نکات آموزشی مطالعه شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="opened_gold" class="w-4 h-4"> بازخورد/مرجع (دمو) باز شد</label>
                </div>
              </fieldset>

              <div class="flex flex-col md:flex-row gap-2">
                <button type="submit" class="w-full px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 focus-ring">ثبت کیس آموزشی</button>
                <button type="button" id="btnTrNextCase" class="w-full px-4 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 focus-ring">کیس بعدی (دمو)</button>
              </div>

              <div class="text-xs text-slate-600 leading-6">
                داده‌های آموزش شامل Pre-AI و (در صورت مجاز بودن) Post-AI و نیز لاگ مشاهده AI/XAI است.
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- POSTTEST -->
    <section id="route-posttest" class="route hidden space-y-6">
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
          <div>
            <h2 class="text-xl font-bold">پس‌آزمون (AI قفل است)</h2>
            <p class="mt-2 text-sm text-slate-700 leading-7">
              پس‌آزمون برای سنجش پیامدهای آموزشی پس از مداخله است. مطابق پروتکل، در پس‌آزمون هیچ خروجی AI نمایش داده نمی‌شود.
            </p>
          </div>
          <div class="p-3 rounded-xl bg-rose-50 border border-rose-200 text-rose-900 text-sm">
            وضعیت AI: <b>قفل پروتکلی</b> (غیرقابل فعال‌سازی)
          </div>
        </div>

        <div class="mt-4 grid lg:grid-cols-2 gap-4">
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <div class="flex items-center justify-between gap-2">
              <h3 class="font-bold">نمایش کیس (دمو)</h3>
              <div class="text-xs text-slate-600 mono">
                CaseID: <span id="post_caseId">CXR-PO-001</span>
              </div>
            </div>

            <div class="mt-3 rounded-xl bg-white border border-slate-200 p-3">
              <div class="aspect-[4/3] rounded-lg bg-slate-100 border border-dashed border-slate-300 flex items-center justify-center text-slate-600 text-sm">
                تصویر CXR (دمو)
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <button class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 text-sm focus-ring" id="btnPostStart">شروع تایمر</button>
                <button class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 text-sm focus-ring" id="btnPostStop">توقف/ثبت زمان</button>
                <span class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm mono">Time: <span id="post_timer">00:00</span></span>
              </div>

              <div class="mt-3 p-3 rounded-xl bg-white border border-slate-200">
                <p class="text-sm font-semibold">AI (غیرفعال در آزمون)</p>
                <button disabled class="mt-2 w-full px-4 py-2 rounded-lg bg-slate-200 text-slate-500 text-sm cursor-not-allowed">
                  نمایش خروجی AI (در آزمون‌ها قفل است)
                </button>
              </div>
            </div>
          </div>

          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">فرم پاسخ (پس‌آزمون)</h3>

            <form id="formPosttest" class="mt-3 space-y-4">
              <fieldset class="p-3 rounded-xl bg-white border border-slate-200">
                <legend class="px-2 text-sm font-semibold">چک‌لیست ABCDE</legend>
                <div class="mt-2 grid md:grid-cols-2 gap-2 text-sm">
                  <label class="flex items-center gap-2"><input type="checkbox" name="abcde_A" class="w-4 h-4"> A: راه‌های هوایی بررسی شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="abcde_B" class="w-4 h-4"> B: ریه/پلور بررسی شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="abcde_C" class="w-4 h-4"> C: قلب/مدیاستن بررسی شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="abcde_D" class="w-4 h-4"> D: دیافراگم بررسی شد</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="abcde_E" class="w-4 h-4"> E: سایر بررسی شد</label>
                </div>
              </fieldset>

              <fieldset class="p-3 rounded-xl bg-white border border-slate-200">
                <legend class="px-2 text-sm font-semibold">یافته‌های هدف</legend>
                <div class="mt-2 grid md:grid-cols-2 gap-2 text-sm">
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_normal" class="w-4 h-4"> نرمال/بدون یافته مهم</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_consolidation" class="w-4 h-4"> ارتشاح/Consolidation</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_pleural_effusion" class="w-4 h-4"> افیوژن پلور</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_pneumothorax" class="w-4 h-4"> پنوموتوراکس</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_nodule" class="w-4 h-4"> ندول/توده</label>
                  <label class="flex items-center gap-2"><input type="checkbox" name="finding_cardiomegaly" class="w-4 h-4"> بزرگی قلب</label>
                </div>
              </fieldset>

              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <label class="block text-sm font-semibold">گزارش ساختاریافته</label>
                <textarea name="structured_report" rows="6" class="mt-2 w-full px-3 py-2 rounded-lg border border-slate-300 focus-ring" placeholder="متن گزارش را اینجا بنویسید..."></textarea>
              </div>

              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <label class="block text-sm font-semibold">اطمینان (0 تا 100)</label>
                <input name="confidence" type="range" min="0" max="100" value="50" class="mt-2 w-full" />
                <div class="mt-1 text-xs text-slate-600">عدد اطمینان: <span id="post_confVal" class="mono">50</span></div>
              </div>

              <div class="flex flex-col md:flex-row gap-2">
                <button type="submit" class="w-full px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 focus-ring">ثبت پاسخ پس‌آزمون</button>
                <button type="button" id="btnPostNextCase" class="w-full px-4 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 focus-ring">کیس بعدی (دمو)</button>
              </div>

              <div class="text-xs text-slate-600 leading-6">
                داده‌های پس‌آزمون برای تحلیل پیامدها با پیش‌آزمون مقایسه می‌شود.
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- SURVEYS -->
    <section id="route-surveys" class="route hidden space-y-6">
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <h2 class="text-xl font-bold">ارزیابی کاربردپذیری و پذیرش (SUS / NPS)</h2>
        <p class="mt-2 text-sm text-slate-700 leading-7">
          لطفاً بر اساس تجربه واقعی خود در استفاده از سامانه پاسخ دهید. این بخش به تحلیل تجربه کاربری و بهینه‌سازی سامانه کمک می‌کند.
        </p>

        <div class="mt-4 grid lg:grid-cols-2 gap-4">
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">SUS (System Usability Scale)</h3>
            <p class="mt-2 text-xs text-slate-600 leading-6">
              مقیاس ۱ تا ۵: ۱=کاملاً مخالفم، ۵=کاملاً موافقم
            </p>

            <form id="formSUS" class="mt-3 space-y-3">
              <div id="susItems" class="space-y-3"></div>

              <button type="submit" class="mt-2 w-full px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 focus-ring">
                ثبت SUS و محاسبه امتیاز
              </button>

              <div class="mt-3 p-3 rounded-xl bg-white border border-slate-200">
                <p class="text-sm font-semibold">امتیاز SUS (0 تا 100)</p>
                <p class="mt-2 text-sm text-slate-700">SUS: <span id="susScore" class="mono">—</span></p>
                <p class="mt-1 text-xs text-slate-600 leading-6">
                  تفسیر امتیاز باید با احتیاط و متناسب با زمینه انجام شود. این سامانه «دمو» است و امتیاز صرفاً برای پژوهش و بهبود UX استفاده می‌شود.
                </p>
              </div>
            </form>
          </div>

          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">NPS (Net Promoter Score) + بازخورد کیفی</h3>
            <form id="formNPS" class="mt-3 space-y-4">
              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <label class="block text-sm font-semibold">NPS: احتمال توصیه این پلتفرم به همکار/همکلاسی؟ (0 تا 10)</label>
                <input name="nps" type="range" min="0" max="10" value="7" class="mt-2 w-full" />
                <div class="mt-1 text-xs text-slate-600">عدد: <span id="npsVal" class="mono">7</span></div>
              </div>

              <div class="p-3 rounded-xl bg-white border border-slate-200">
                <label class="block text-sm font-semibold">بازخورد کوتاه (کیفی)</label>
                <textarea name="qual_feedback" rows="6" class="mt-2 w-full px-3 py-2 rounded-lg border border-slate-300 focus-ring"
                  placeholder="مثلاً: سهولت استفاده، وضوح نمایش، ارزش آموزشی، نقاط ابهام، پیشنهاد بهبود..."></textarea>
              </div>

              <button type="submit" class="w-full px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 focus-ring">
                ثبت NPS و بازخورد
              </button>

              <div class="text-xs text-slate-600 leading-6">
                پاسخ‌های کیفی برای استخراج مضمون‌ها (Thematic Analysis) و اصلاح طراحی استفاده می‌شود.
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- RESEARCH DASHBOARD -->
    <section id="route-research" class="route hidden space-y-6">
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
          <div>
            <h2 class="text-xl font-bold">داشبورد پژوهشگر (مرور داده‌ها و صادرات)</h2>
            <p class="mt-2 text-sm text-slate-700 leading-7">
              این بخش برای مشاهده داده‌های ساختاریافته و لاگ‌ها است. در استقرار واقعی، این دسترسی باید محدود، ثبت‌شده و مبتنی بر نقش باشد.
            </p>
          </div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm">
            یادآوری: هیچ PHI نباید در داده‌ها وجود داشته باشد.
          </div>
        </div>

        <div class="mt-4 grid lg:grid-cols-2 gap-4">
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">خلاصه داده‌های ثبت‌شده</h3>
            <div class="mt-3 space-y-2 text-sm">
              <div class="flex items-center justify-between"><span>تعداد رکوردهای پاسخ</span><span id="statResponses" class="mono">0</span></div>
              <div class="flex items-center justify-between"><span>تعداد رویدادهای Audit Log</span><span id="statAudit" class="mono">0</span></div>
              <div class="flex items-center justify-between"><span>SUS ثبت‌شده</span><span id="statSUS" class="mono">خیر</span></div>
              <div class="flex items-center justify-between"><span>NPS ثبت‌شده</span><span id="statNPS" class="mono">خیر</span></div>
            </div>

            <div class="mt-4 flex flex-col md:flex-row gap-2">
              <button id="btnRefreshStats" class="w-full px-4 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 focus-ring">به‌روزرسانی</button>
              <button id="btnExportJSON" class="w-full px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 focus-ring">خروجی JSON</button>
            </div>

            <div class="mt-3 p-3 rounded-xl bg-white border border-slate-200">
              <p class="text-sm font-semibold">خروجی (پیش‌نمایش)</p>
              <pre id="jsonPreview" class="mt-2 text-xs bg-slate-900 text-slate-50 rounded-xl p-3 overflow-auto max-h-72 mono">—</pre>
              <p class="mt-2 text-xs text-slate-600 leading-6">
                در استقرار واقعی، خروجی باید از مسیر امن و ثبت‌شده تولید شود و کنترل‌های دسترسی/امضا/نسخه‌گذاری داشته باشد.
              </p>
            </div>
          </div>

          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">Audit Log (نمونه)</h3>
            <p class="mt-2 text-xs text-slate-600 leading-6">
              رویدادها شامل ورود، شروع/توقف تایمر، ثبت پاسخ، مشاهده AI/XAI، تغییر مسیرها و تلاش‌های خلاف پروتکل است.
            </p>
            <div class="mt-3 p-3 rounded-xl bg-white border border-slate-200">
              <div class="flex items-center justify-between gap-2">
                <p class="text-sm font-semibold">آخرین رویدادها</p>
                <button id="btnClearDemo" class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-100 text-sm focus-ring">پاکسازی داده‌های دمو</button>
              </div>
              <div id="auditList" class="mt-3 space-y-2 text-xs"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="route-admin" class="route hidden space-y-6">
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <h2 class="text-xl font-bold">ادمین/پیکربندی (دمو)</h2>
        <p class="mt-2 text-sm text-slate-700 leading-7">
          این بخش برای نمایش «قوانین پروتکلی» و کنترل نسخه است. در RCT واقعی، هر تغییر باید مطابق فرآیند مدیریت تغییرات (Change Control)
          و پس از پایان داده‌گیری اعمال شود.
        </p>

        <div class="mt-4 grid lg:grid-cols-2 gap-4">
          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">قوانین قفل AI</h3>
            <ul class="mt-3 text-sm leading-7 list-disc pr-6">
              <li>Pre-test: AI همیشه قفل</li>
              <li>Training: AI فقط در بازوی مداخله مجاز</li>
              <li>Post-test: AI همیشه قفل</li>
              <li>هر تلاش برای فعال‌سازی AI در آزمون باید log شود</li>
            </ul>

            <div class="mt-4 p-3 rounded-xl bg-white border border-slate-200">
              <p class="text-sm font-semibold">نسخه سامانه (Demo)</p>
              <div class="mt-2 flex items-center justify-between">
                <span>App Version</span>
                <span id="appVersion" class="mono">1.0.0-demo</span>
              </div>
              <div class="mt-2 flex items-center justify-between">
                <span>Protocol Lock</span>
                <span class="mono">ON</span>
              </div>
              <p class="mt-2 text-xs text-slate-600 leading-6">
                در استقرار واقعی، نسخه باید به‌صورت امضاشده/قابل ممیزی و با ثبت تغییرات نگهداری شود.
              </p>
            </div>
          </div>

          <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
            <h3 class="font-bold">اسکیماهای داده (JSON-ready)</h3>
            <p class="mt-2 text-xs text-slate-600 leading-6">
              این اسکیماها برای هم‌راستایی تیم فنی/پژوهشی ارائه شده‌اند و باید با پروتکل و برنامه تحلیل آماری همگام شوند.
            </p>

            <pre class="mt-3 text-xs bg-slate-900 text-slate-50 rounded-xl p-3 overflow-auto max-h-96 mono">
{
  "participant": {
    "participant_id": "P-XXXX",
    "role": "student|researcher|admin",
    "arm": "control|intervention",
    "level": "دانشجو/اینترن/دستیار...",
    "site_code": "SITE-XX",
    "consent_accepted_at": "ISO-8601"
  },
  "response": {
    "response_id": "UUID",
    "participant_id": "P-XXXX",
    "case_id": "CXR-TR-001",
    "phase": "pretest|training|posttest",
    "timestamp": "ISO-8601",
    "time_seconds": 123,
    "abcde": {"A":true,"B":true,"C":true,"D":false,"E":true},
    "findings": {"normal":false,"consolidation":true,"effusion":false,"pneumothorax":false,"nodule":false,"cardiomegaly":false},
    "structured_report": "text",
    "confidence_0_100": 72,
    "training_extras": {
      "pre_ai_report": "text",
      "pre_ai_confidence": 60,
      "ai_allowed": true,
      "ai_viewed": true,
      "xai_viewed": true,
      "post_ai_report": "text",
      "post_ai_confidence": 75,
      "changed_decision": true
    }
  },
  "audit_event": {
    "event_id": "UUID",
    "participant_id": "P-XXXX",
    "role": "student|researcher|admin",
    "arm": "control|intervention",
    "route": "home|pretest|training|posttest|surveys|research|admin",
    "action": "NAVIGATE|TIMER_START|FORM_SUBMIT|AI_VIEW|LOCK_VIOLATION_ATTEMPT|EXPORT",
    "case_id": "optional",
    "timestamp": "ISO-8601",
    "meta": {"key":"value"}
  }
}
            </pre>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="text-xs text-slate-600 py-6">
      <div class="bg-white rounded-2xl border border-slate-200 p-4">
        <p class="leading-6">
          © نسخه دمو — این سامانه صرفاً برای آموزش/پژوهش طراحی شده است و برای استفاده بالینی مجاز نیست.
          برای اجرای RCT واقعی، اتصال به زیرساخت امن، مدیریت نسخه قفل‌شده، و رویه‌های رسمی GCP/امنیت اطلاعات الزامی است.
        </p>
      </div>
    </footer>
  </main>

  <script>
    /***********************
     * Research-Grade Demo State
     ***********************/
    const STORAGE_KEY = "CXR_RCT_DEMO_V1";
    const defaultState = {
      app: { version: "1.0.0-demo", protocolLock: true },
      participant: {
        participant_id: "",
        role: "student",
        arm: "",
        level: "",
        site_code: "",
        consent_accepted_at: ""
      },
      responses: [],
      surveys: { sus: null, nps: null },
      audit: []
    };

    function nowISO() { return new Date().toISOString(); }
    function uuid() {
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = Math.random()*16|0, v = c === "x" ? r : (r&0x3|0x8);
        return v.toString(16);
      });
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const s = JSON.parse(raw);
        return { ...structuredClone(defaultState), ...s };
      } catch {
        return structuredClone(defaultState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      refreshBadges();
    }

    function audit(action, meta = {}) {
      const ev = {
        event_id: uuid(),
        participant_id: state.participant.participant_id || "GUEST",
        role: state.participant.role || "student",
        arm: state.participant.arm || "",
        route: currentRoute,
        action,
        case_id: meta.case_id || null,
        timestamp: nowISO(),
        meta
      };
      state.audit.push(ev);
      saveState();
    }

    let state = loadState();
    let currentRoute = "home";

    /***********************
     * Routing
     ***********************/
    const routes = ["home","login","pretest","training","posttest","surveys","research","admin"];
    function showRoute(name) {
      routes.forEach(r => {
        const el = document.getElementById("route-" + r);
        if (el) el.classList.toggle("hidden", r !== name);
      });
      currentRoute = name;
      audit("NAVIGATE", { to: name });
      refreshBadges();
      refreshTrainingAIUI();
      refreshResearchDashboard();
    }

    document.querySelectorAll(".navbtn").forEach(btn => {
      btn.addEventListener("click", () => {
        showRoute(btn.dataset.route);
      });
    });

    /***********************
     * Consent Modal
     ***********************/
    const consentModal = document.getElementById("consentModal");
    const btnOpenConsent = document.getElementById("btnOpenConsent");
    const btnShowConsent2 = document.getElementById("btnShowConsent2");
    const btnCloseConsent = document.getElementById("btnCloseConsent");
    const chkConsent = document.getElementById("chkConsent");
    const btnAcceptConsent = document.getElementById("btnAcceptConsent");

    function openConsent() {
      consentModal.classList.remove("hidden");
      audit("CONSENT_OPEN");
    }
    function closeConsent() {
      consentModal.classList.add("hidden");
      audit("CONSENT_CLOSE");
    }

    btnOpenConsent.addEventListener("click", openConsent);
    btnShowConsent2.addEventListener("click", openConsent);
    btnCloseConsent.addEventListener("click", closeConsent);

    chkConsent.addEventListener("change", () => {
      btnAcceptConsent.disabled = !chkConsent.checked;
    });

    btnAcceptConsent.addEventListener("click", () => {
      state.participant.consent_accepted_at = nowISO();
      saveState();
      audit("CONSENT_ACCEPT");
      closeConsent();
      refreshConsentStatus();
    });

    function refreshConsentStatus() {
      const el = document.getElementById("consentStatus");
      if (!el) return;
      el.textContent = state.participant.consent_accepted_at ? ("ثبت شد: " + state.participant.consent_accepted_at) : "ثبت نشده";
    }

    /***********************
     * Badges
     ***********************/
    function refreshBadges() {
      const roleMap = { student: "دانشجو/فراگیر", researcher: "پژوهشگر", admin: "ادمین" };
      document.getElementById("badgeRole").innerHTML = `نقش: <b>${roleMap[state.participant.role] || "میهمان"}</b>`;
      document.getElementById("badgeArm").innerHTML = `گروه: <b>${state.participant.arm ? (state.participant.arm === "control" ? "کنترل" : "مداخله") : "نامشخص"}</b>`;

      const phaseLabel = (currentRoute === "pretest") ? "پیش‌آزمون" :
                         (currentRoute === "training") ? "آموزش" :
                         (currentRoute === "posttest") ? "پس‌آزمون" :
                         (currentRoute === "surveys") ? "پرسشنامه" :
                         (currentRoute === "research") ? "پژوهش" :
                         (currentRoute === "admin") ? "ادمین" : "پروتکل";
      document.getElementById("badgePhase").innerHTML = `فاز: <b>${phaseLabel}</b>`;

      document.getElementById("badgeAI").innerHTML = `AI: <b>${aiStatusLabel()}</b>`;
      document.getElementById("appVersion").textContent = state.app.version;
    }

    function aiAllowedInCurrentRoute() {
      if (currentRoute === "pretest" || currentRoute === "posttest") return false;
      if (currentRoute === "training") return state.participant.arm === "intervention";
      return false;
    }

    function aiStatusLabel() {
      if (currentRoute === "pretest" || currentRoute === "posttest") return "قفل";
      if (currentRoute === "training") return (state.participant.arm === "intervention") ? "مجاز در آموزش" : "قفل (کنترل)";
      return "—";
    }

    /***********************
     * Profile / Study Settings
     ***********************/
    document.getElementById("btnSaveProfile").addEventListener("click", () => {
      const pid = document.getElementById("inpParticipantId").value.trim();
      const lvl = document.getElementById("selLevel").value;
      const site = document.getElementById("inpSiteCode").value.trim();

      // حداقل اعتبارسنجی پژوهشی
      if (!pid || pid.length < 3) {
        alert("شناسه مستعار معتبر وارد کنید (حداقل ۳ کاراکتر).");
        audit("VALIDATION_FAIL", { field: "participant_id" });
        return;
      }

      state.participant.participant_id = pid;
      state.participant.level = lvl;
      state.participant.site_code = site;
      saveState();
      audit("PROFILE_SAVE", { participant_id: pid, level: lvl, site_code: site });
      refreshConsentStatus();
      alert("پروفایل ذخیره شد.");
    });

    document.getElementById("btnSaveStudySettings").addEventListener("click", () => {
      state.participant.role = document.getElementById("selRole").value;
      state.participant.arm = document.getElementById("selArm").value;
      saveState();
      audit("STUDY_SETTINGS_SAVE", { role: state.participant.role, arm: state.participant.arm });
      refreshTrainingAIUI();
      alert("تنظیمات دمو اعمال شد.");
    });

    /***********************
     * Timers (Pre/Training/Post)
     ***********************/
    function makeTimer(labelEl) {
      let t = 0;
      let interval = null;
      function format(sec){
        const m = String(Math.floor(sec / 60)).padStart(2,"0");
        const s = String(sec % 60).padStart(2,"0");
        return `${m}:${s}`;
      }
      function start() {
        if (interval) return;
        interval = setInterval(() => {
          t += 1;
          labelEl.textContent = format(t);
        }, 1000);
      }
      function stop() {
        if (!interval) return t;
        clearInterval(interval);
        interval = null;
        return t;
      }
      function reset() {
        t = 0;
        labelEl.textContent = format(t);
      }
      function seconds() { return t; }
      return { start, stop, reset, seconds };
    }

    const preTimer = makeTimer(document.getElementById("pre_timer"));
    const trTimer  = makeTimer(document.getElementById("tr_timer"));
    const postTimer= makeTimer(document.getElementById("post_timer"));

    document.getElementById("btnPreStart").addEventListener("click", () => { preTimer.start(); audit("TIMER_START", { phase:"pretest", case_id: getPreCaseId() }); });
    document.getElementById("btnPreStop").addEventListener("click", () => { preTimer.stop(); audit("TIMER_STOP", { phase:"pretest", seconds: preTimer.seconds(), case_id: getPreCaseId() }); });

    document.getElementById("btnTrStart").addEventListener("click", () => { trTimer.start(); audit("TIMER_START", { phase:"training", case_id: getTrCaseId() }); });
    document.getElementById("btnTrStop").addEventListener("click", () => { trTimer.stop(); audit("TIMER_STOP", { phase:"training", seconds: trTimer.seconds(), case_id: getTrCaseId() }); });

    document.getElementById("btnPostStart").addEventListener("click", () => { postTimer.start(); audit("TIMER_START", { phase:"posttest", case_id: getPostCaseId() }); });
    document.getElementById("btnPostStop").addEventListener("click", () => { postTimer.stop(); audit("TIMER_STOP", { phase:"posttest", seconds: postTimer.seconds(), case_id: getPostCaseId() }); });

    function getPreCaseId(){ return document.getElementById("pre_caseId").textContent; }
    function getTrCaseId(){ return document.getElementById("tr_caseId").textContent; }
    function getPostCaseId(){ return document.getElementById("post_caseId").textContent; }

    /***********************
     * Confidence sliders display
     ***********************/
    function bindRangeToLabel(formId, rangeName, labelId) {
      const form = document.getElementById(formId);
      const range = form.querySelector(`input[name="${rangeName}"]`);
      const label = document.getElementById(labelId);
      if (!range || !label) return;
      label.textContent = range.value;
      range.addEventListener("input", () => label.textContent = range.value);
    }
    bindRangeToLabel("formPretest","confidence","pre_confVal");
    bindRangeToLabel("formPosttest","confidence","post_confVal");
    bindRangeToLabel("formTraining","pre_ai_confidence","tr_preConfVal");

    // Post-AI range has id
    const postRange = document.getElementById("post_ai_confidence");
    const postLabel = document.getElementById("tr_postConfVal");
    postLabel.textContent = postRange.value;
    postRange.addEventListener("input", ()=> postLabel.textContent = postRange.value);

    /***********************
     * Training AI Panel behavior
     ***********************/
    const btnShowAI = document.getElementById("btnShowAI");
    const aiOutput = document.getElementById("aiOutput");
    const chkXAIViewed = document.getElementById("chkXAIViewed");
    const postAIBox = document.getElementById("postAIBox");
    const postAIReport = document.getElementById("post_ai_report");

    function refreshTrainingAIUI() {
      const statusEl = document.getElementById("trainingAIStatus");
      if (!statusEl) return;

      const allowed = (state.participant.arm === "intervention");
      statusEl.textContent = allowed ? "مجاز (فقط برای آموزش)" : "قفل (بازوی کنترل یا تخصیص نامشخص)";
      document.getElementById("trainingAIBox").className =
        "p-3 rounded-xl border text-sm " + (allowed ? "bg-emerald-50 border-emerald-200 text-emerald-900" : "bg-rose-50 border-rose-200 text-rose-900");

      // AI Button
      btnShowAI.disabled = !allowed;
      btnShowAI.classList.toggle("opacity-50", !allowed);
      btnShowAI.classList.toggle("cursor-not-allowed", !allowed);

      // Post AI fields
      postAIReport.disabled = !allowed;
      postRange.disabled = !allowed;

      if (!allowed) {
        aiOutput.classList.add("hidden");
        chkXAIViewed.checked = false;
      }
    }

    btnShowAI.addEventListener("click", () => {
      const allowed = aiAllowedInCurrentRoute();
      if (!allowed) {
        audit("LOCK_VIOLATION_ATTEMPT", { feature:"AI_VIEW", phase:"training", case_id: getTrCaseId() });
        alert("AI طبق پروتکل قفل است (بازوی کنترل یا خارج از آموزش).");
        return;
      }
      aiOutput.classList.toggle("hidden");
      audit("AI_VIEW", { phase:"training", case_id: getTrCaseId(), visible: !aiOutput.classList.contains("hidden") });
    });

    chkXAIViewed.addEventListener("change", () => {
      audit("XAI_TOGGLE", { phase:"training", case_id: getTrCaseId(), viewed: chkXAIViewed.checked });
    });

    // Gold feedback demo
    const btnShowGold = document.getElementById("btnShowGold");
    const goldBox = document.getElementById("goldBox");
    btnShowGold.addEventListener("click", () => {
      goldBox.classList.toggle("hidden");
      audit("GOLD_TOGGLE", { phase:"training", case_id: getTrCaseId(), opened: !goldBox.classList.contains("hidden") });
    });

    /***********************
     * Form serialization helpers
     ***********************/
    function serializeForm(form) {
      const data = {};
      const fd = new FormData(form);
      // checkboxes not checked won't appear; handle separately
      for (const [k,v] of fd.entries()) data[k] = v;

      // collect checkboxes
      form.querySelectorAll('input[type="checkbox"][name]').forEach(cb => {
        data[cb.name] = cb.checked;
      });
      // ranges
      form.querySelectorAll('input[type="range"][name]').forEach(r => {
        data[r.name] = Number(r.value);
      });
      return data;
    }

    function ensureParticipantReady() {
      if (!state.participant.participant_id) {
        alert("ابتدا در بخش ورود/پروفایل، شناسه مستعار را ثبت کنید.");
        showRoute("login");
        return false;
      }
      if (!state.participant.consent_accepted_at) {
        alert("برای ادامه، پذیرش اطلاعیه اخلاقی لازم است.");
        openConsent();
        return false;
      }
      return true;
    }

    /***********************
     * Pretest submit
     ***********************/
    document.getElementById("formPretest").addEventListener("submit", (e) => {
      e.preventDefault();
      if (!ensureParticipantReady()) return;

      const form = e.target;
      const d = serializeForm(form);

      const resp = {
        response_id: uuid(),
        participant_id: state.participant.participant_id,
        case_id: getPreCaseId(),
        phase: "pretest",
        timestamp: nowISO(),
        time_seconds: preTimer.seconds(),
        abcde: { A:d.abcde_A, B:d.abcde_B, C:d.abcde_C, D:d.abcde_D, E:d.abcde_E },
        findings: {
          normal: d.finding_normal,
          consolidation: d.finding_consolidation,
          effusion: d.finding_pleural_effusion,
          pneumothorax: d.finding_pneumothorax,
          nodule: d.finding_nodule,
          cardiomegaly: d.finding_cardiomegaly
        },
        structured_report: d.structured_report || "",
        confidence_0_100: Number(d.confidence ?? 50),
        training_extras: null
      };

      state.responses.push(resp);
      audit("FORM_SUBMIT", { phase:"pretest", case_id: resp.case_id, time_seconds: resp.time_seconds });
      saveState();
      alert("پاسخ پیش‌آزمون ثبت شد.");
      preTimer.reset();
      form.reset();
      // reset label
      document.getElementById("pre_confVal").textContent = "50";
    });

    /***********************
     * Posttest submit
     ***********************/
    document.getElementById("formPosttest").addEventListener("submit", (e) => {
      e.preventDefault();
      if (!ensureParticipantReady()) return;

      const form = e.target;
      const d = serializeForm(form);

      const resp = {
        response_id: uuid(),
        participant_id: state.participant.participant_id,
        case_id: getPostCaseId(),
        phase: "posttest",
        timestamp: nowISO(),
        time_seconds: postTimer.seconds(),
        abcde: { A:d.abcde_A, B:d.abcde_B, C:d.abcde_C, D:d.abcde_D, E:d.abcde_E },
        findings: {
          normal: d.finding_normal,
          consolidation: d.finding_consolidation,
          effusion: d.finding_pleural_effusion,
          pneumothorax: d.finding_pneumothorax,
          nodule: d.finding_nodule,
          cardiomegaly: d.finding_cardiomegaly
        },
        structured_report: d.structured_report || "",
        confidence_0_100: Number(d.confidence ?? 50),
        training_extras: null
      };

      state.responses.push(resp);
      audit("FORM_SUBMIT", { phase:"posttest", case_id: resp.case_id, time_seconds: resp.time_seconds });
      saveState();
      alert("پاسخ پس‌آزمون ثبت شد.");
      postTimer.reset();
      form.reset();
      document.getElementById("post_confVal").textContent = "50";
    });

    /***********************
     * Training submit
     ***********************/
    document.getElementById("formTraining").addEventListener("submit", (e) => {
      e.preventDefault();
      if (!ensureParticipantReady()) return;

      const allowed = (state.participant.arm === "intervention");
      const form = e.target;
      const d = serializeForm(form);

      // basic validation: pre-ai report should not be empty in training
      if (!d.pre_ai_report || String(d.pre_ai_report).trim().length < 10) {
        alert("لطفاً در آموزش، گزارش مستقل (Pre-AI) را با حداقل ۱۰ کاراکتر ثبت کنید.");
        audit("VALIDATION_FAIL", { phase:"training", field:"pre_ai_report", case_id: getTrCaseId() });
        return;
      }

      const resp = {
        response_id: uuid(),
        participant_id: state.participant.participant_id,
        case_id: getTrCaseId(),
        phase: "training",
        timestamp: nowISO(),
        time_seconds: trTimer.seconds(),
        abcde: null,
        findings: null,
        structured_report: "",
        confidence_0_100: null,
        training_extras: {
          pre_ai_report: d.pre_ai_report || "",
          pre_ai_confidence: Number(d.pre_ai_confidence ?? 50),
          ai_allowed: allowed,
          ai_viewed: !aiOutput.classList.contains("hidden"),
          xai_viewed: chkXAIViewed.checked || d.used_xai === true,
          post_ai_report: allowed ? (d.post_ai_report || "") : "",
          post_ai_confidence: allowed ? Number(d.post_ai_confidence ?? 50) : null,
          changed_decision: allowed ? Boolean(d.ai_changed_decision) : false,
          ai_increased_confidence: allowed ? Boolean(d.ai_increased_confidence) : false,
          ui_usage: {
            used_zoom: Boolean(d.used_zoom),
            used_xai: Boolean(d.used_xai),
            read_tips: Boolean(d.read_tips),
            opened_gold: Boolean(d.opened_gold)
          }
        }
      };

      // protocol guard: if control arm, do not accept post-ai content
      if (!allowed) {
        const hasPost = (d.post_ai_report && String(d.post_ai_report).trim().length > 0);
        if (hasPost) {
          audit("LOCK_VIOLATION_ATTEMPT", { feature:"POST_AI_ENTRY", case_id: resp.case_id });
          alert("طبق پروتکل، در بازوی کنترل ثبت Post-AI مجاز نیست. این فیلد پاک شد.");
          resp.training_extras.post_ai_report = "";
          resp.training_extras.post_ai_confidence = null;
        }
      }

      state.responses.push(resp);
      audit("FORM_SUBMIT", { phase:"training", case_id: resp.case_id, time_seconds: resp.time_seconds, ai_allowed: allowed });
      saveState();
      alert("کیس آموزشی ثبت شد.");
      trTimer.reset();
      form.reset();
      document.getElementById("tr_preConfVal").textContent = "50";
      document.getElementById("tr_postConfVal").textContent = "50";
      aiOutput.classList.add("hidden");
      chkXAIViewed.checked = false;
    });

    /***********************
     * Demo case navigation
     ***********************/
    function nextCaseId(prefix, n) {
      return `${prefix}-${String(n).padStart(3,"0")}`;
    }
    let preN = 1, trN = 1, postN = 1;

    document.getElementById("btnPreNextCase").addEventListener("click", () => {
      preN += 1;
      document.getElementById("pre_caseId").textContent = nextCaseId("CXR-PT", preN);
      preTimer.reset();
      audit("CASE_NEXT", { phase:"pretest", case_id: getPreCaseId() });
    });

    document.getElementById("btnTrNextCase").addEventListener("click", () => {
      trN += 1;
      document.getElementById("tr_caseId").textContent = nextCaseId("CXR-TR", trN);
      trTimer.reset();
      aiOutput.classList.add("hidden");
      chkXAIViewed.checked = false;
      goldBox.classList.add("hidden");
      audit("CASE_NEXT", { phase:"training", case_id: getTrCaseId() });
    });

    document.getElementById("btnPostNextCase").addEventListener("click", () => {
      postN += 1;
      document.getElementById("post_caseId").textContent = nextCaseId("CXR-PO", postN);
      postTimer.reset();
      audit("CASE_NEXT", { phase:"posttest", case_id: getPostCaseId() });
    });

    /***********************
     * SUS / NPS forms
     ***********************/
    const susStatements = [
      "فکر می‌کنم دوست دارم مرتب از این سامانه استفاده کنم.",
      "سامانه بیش از حد پیچیده است.",
      "فکر می‌کنم استفاده از سامانه آسان است.",
      "برای استفاده از سامانه به کمک فنی نیاز دارم.",
      "قابلیت‌های مختلف سامانه به‌خوبی یکپارچه شده‌اند.",
      "در سامانه ناسازگاری‌های زیادی وجود دارد.",
      "تصور می‌کنم اغلب افراد به‌سرعت یاد می‌گیرند از سامانه استفاده کنند.",
      "استفاده از سامانه بسیار دست‌وپاگیر است.",
      "در استفاده از سامانه احساس اطمینان دارم.",
      "قبل از شروع استفاده، لازم است چیزهای زیادی یاد بگیرم."
    ];

    function renderSUS() {
      const box = document.getElementById("susItems");
      box.innerHTML = "";
      susStatements.forEach((txt, idx) => {
        const q = idx + 1;
        const wrap = document.createElement("div");
        wrap.className = "p-3 rounded-xl bg-white border border-slate-200";
        wrap.innerHTML = `
          <label class="block text-sm font-semibold">SUS-${q}: ${txt}</label>
          <div class="mt-2 grid grid-cols-5 gap-2 text-xs">
            ${[1,2,3,4,5].map(v => `
              <label class="flex items-center justify-center gap-1 p-2 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
                <input type="radio" name="sus_${q}" value="${v}" class="w-4 h-4" required />
                <span>${v}</span>
              </label>
            `).join("")}
          </div>
          <div class="mt-2 text-xs text-slate-600">۱=کاملاً مخالفم … ۵=کاملاً موافقم</div>
        `;
        box.appendChild(wrap);
      });
    }
    renderSUS();

    function computeSUS(values) {
      // SUS scoring:
      // odd items: score = value - 1
      // even items: score = 5 - value
      // total * 2.5
      let sum = 0;
      for (let i=0; i<10; i++) {
        const v = Number(values[i]);
        if ((i % 2) === 0) sum += (v - 1);
        else sum += (5 - v);
      }
      return sum * 2.5;
    }

    document.getElementById("formSUS").addEventListener("submit", (e) => {
      e.preventDefault();
      if (!ensureParticipantReady()) return;

      const form = e.target;
      const vals = [];
      for (let q=1; q<=10; q++) {
        const checked = form.querySelector(`input[name="sus_${q}"]:checked`);
        vals.push(checked ? checked.value : null);
      }
      if (vals.some(v => v === null)) {
        alert("لطفاً همه سوالات SUS را پاسخ دهید.");
        audit("VALIDATION_FAIL", { phase:"surveys", tool:"SUS" });
        return;
      }

      const score = computeSUS(vals);
      state.surveys.sus = {
        participant_id: state.participant.participant_id,
        timestamp: nowISO(),
        items: vals.map(Number),
        score
      };
      document.getElementById("susScore").textContent = String(score.toFixed(1));
      audit("SURVEY_SUBMIT", { tool:"SUS", score });
      saveState();
      alert("SUS ثبت شد.");
      refreshResearchDashboard();
    });

    // NPS binding
    const npsRange = document.querySelector('#formNPS input[name="nps"]');
    const npsVal = document.getElementById("npsVal");
    npsVal.textContent = npsRange.value;
    npsRange.addEventListener("input", ()=> npsVal.textContent = npsRange.value);

    document.getElementById("formNPS").addEventListener("submit", (e) => {
      e.preventDefault();
      if (!ensureParticipantReady()) return;

      const d = serializeForm(e.target);
      state.surveys.nps = {
        participant_id: state.participant.participant_id,
        timestamp: nowISO(),
        nps: Number(d.nps ?? 0),
        qual_feedback: String(d.qual_feedback || "")
      };
      audit("SURVEY_SUBMIT", { tool:"NPS", nps: state.surveys.nps.nps });
      saveState();
      alert("NPS و بازخورد ثبت شد.");
      refreshResearchDashboard();
    });

    /***********************
     * Research dashboard
     ***********************/
    function refreshResearchDashboard() {
      document.getElementById("statResponses").textContent = String(state.responses.length);
      document.getElementById("statAudit").textContent = String(state.audit.length);
      document.getElementById("statSUS").textContent = state.surveys.sus ? "بله" : "خیر";
      document.getElementById("statNPS").textContent = state.surveys.nps ? "بله" : "خیر";
      refreshAuditList();
      refreshConsentStatus();
    }

    function refreshAuditList() {
      const list = document.getElementById("auditList");
      if (!list) return;
      list.innerHTML = "";
      const tail = state.audit.slice(-12).reverse();
      tail.forEach(ev => {
        const item = document.createElement("div");
        item.className = "p-2 rounded-lg border border-slate-200 bg-slate-50";
        item.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div>
              <div><b>${ev.action}</b> <span class="mono text-slate-600">${ev.timestamp}</span></div>
              <div class="text-slate-600">route=${ev.route} arm=${ev.arm || "-"} role=${ev.role || "-"}</div>
              ${ev.case_id ? `<div class="text-slate-600 mono">case=${ev.case_id}</div>` : ""}
            </div>
            <div class="mono text-slate-500">#${ev.event_id.slice(0,8)}</div>
          </div>
        `;
        list.appendChild(item);
      });
    }

    document.getElementById("btnRefreshStats").addEventListener("click", () => {
      refreshResearchDashboard();
      audit("REFRESH_DASHBOARD");
    });

    document.getElementById("btnExportJSON").addEventListener("click", () => {
      if (state.participant.role !== "researcher" && state.participant.role !== "admin") {
        alert("این اقدام فقط برای پژوهشگر/ادمین مجاز است (دمو).");
        audit("ACCESS_DENY", { action:"EXPORT" });
        return;
      }
      const payload = {
        exported_at: nowISO(),
        app: state.app,
        participant: state.participant,
        responses: state.responses,
        surveys: state.surveys,
        audit: state.audit
      };
      const pretty = JSON.stringify(payload, null, 2);
      document.getElementById("jsonPreview").textContent = pretty;
      audit("EXPORT", { format:"json", bytes: pretty.length });

      // trigger download
      const blob = new Blob([pretty], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `CXR_RCT_EXPORT_${(state.participant.participant_id || "GUEST")}_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    document.getElementById("btnClearDemo").addEventListener("click", () => {
      if (state.participant.role !== "admin") {
        alert("پاکسازی فقط برای ادمین مجاز است (دمو).");
        audit("ACCESS_DENY", { action:"CLEAR_DEMO" });
        return;
      }
      if (!confirm("پاکسازی تمام داده‌های دمو در این مرورگر انجام شود؟")) return;
      localStorage.removeItem(STORAGE_KEY);
      state = loadState();
      audit("CLEAR_DEMO");
      saveState();
      refreshResearchDashboard();
      alert("داده‌های دمو پاک شد.");
    });

    /***********************
     * Initial UI sync
     ***********************/
    function initFromStateToUI() {
      document.getElementById("inpParticipantId").value = state.participant.participant_id || "";
      document.getElementById("selLevel").value = state.participant.level || "";
      document.getElementById("inpSiteCode").value = state.participant.site_code || "";
      document.getElementById("selRole").value = state.participant.role || "student";
      document.getElementById("selArm").value = state.participant.arm || "";
      refreshConsentStatus();
      refreshTrainingAIUI();

      // If SUS already exists, show score
      if (state.surveys.sus && typeof state.surveys.sus.score === "number") {
        document.getElementById("susScore").textContent = String(state.surveys.sus.score.toFixed(1));
      }
      if (state.surveys.nps && typeof state.surveys.nps.nps === "number") {
        npsRange.value = String(state.surveys.nps.nps);
        npsVal.textContent = String(state.surveys.nps.nps);
      }
      refreshResearchDashboard();
      refreshBadges();
    }

    // Default route
    initFromStateToUI();
    showRoute("home");
  </script>
</body>
</html>
