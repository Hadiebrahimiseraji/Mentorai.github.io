<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RadMentor | Single-file Research Platform</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Vazirmatn -->
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Vazirmatn','system-ui','sans-serif'] },
          colors: {
            bg0: '#0b1220',
            bg1: '#0f172a',
            panel: '#111c33',
            panel2: '#142140',
            border: '#22314f',
            txt: '#e7eefc',
            sub: '#9fb2d9',
            brand: '#3b82f6',
            mint: '#14b8a6',
            warn: '#f59e0b',
            danger: '#ef4444',
            ok: '#22c55e'
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: Vazirmatn, sans-serif; background:#0b1220; color:#e7eefc; }
    .glass { background: rgba(17,28,51,.72); backdrop-filter: blur(10px); }
    .soft-shadow { box-shadow: 0 10px 40px rgba(0,0,0,.35); }
    .scroll::-webkit-scrollbar { width: 8px; height: 8px; }
    .scroll::-webkit-scrollbar-thumb { background: #22314f; border-radius: 10px; }
    .scroll::-webkit-scrollbar-track { background: #0b1220; }

    .viewer { background:#000; border:1px solid #22314f; border-radius:14px; overflow:hidden; position:relative; }
    .viewer img { width:100%; height:100%; object-fit:contain; transform-origin:center center; user-select:none; -webkit-user-drag:none; pointer-events:none; }
    .heatmap { position:absolute; inset:0; opacity:0; transition:opacity .25s ease; mix-blend-mode:screen; pointer-events:none; }
    .heatmap.on { opacity:1; }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background:#0a1020;
      border:1px solid #22314f;
      padding:2px 6px;
      border-radius:8px;
      color:#9fb2d9;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pill { border:1px solid #22314f; background:rgba(17,28,51,.7); border-radius:999px; padding:6px 10px; font-size:12px; color:#9fb2d9; }
    .btn { border:1px solid #22314f; background:#111c33; border-radius:14px; padding:10px 12px; transition:.15s; }
    .btn:hover { background:#142140; border-color:#3b82f6; }
    .btn-primary { background:#3b82f6; border-color:#3b82f6; color:white; font-weight:800; }
    .btn-primary:hover { filter:brightness(1.1); }
    .btn-mint { background:#14b8a6; border-color:#14b8a6; color:#06121d; font-weight:900; }
    .btn-mint:hover { filter:brightness(1.07); }
    .btn-danger { background:#ef4444; border-color:#ef4444; color:white; font-weight:900; }
    .btn-danger:hover { filter:brightness(1.06); }

    .input { width:100%; background:#0b1220; border:1px solid #22314f; border-radius:14px; padding:10px 12px; outline:none; }
    .input:focus { border-color:#3b82f6; }
    .select { width:100%; background:#0b1220; border:1px solid #22314f; border-radius:14px; padding:10px 12px; outline:none; }
    .select:focus { border-color:#3b82f6; }
    .textarea { width:100%; background:#0b1220; border:1px solid #22314f; border-radius:14px; padding:10px 12px; outline:none; }
    .textarea:focus { border-color:#3b82f6; }

    .tag { border:1px solid #22314f; background:rgba(20,33,64,.6); border-radius:12px; padding:6px 10px; font-size:12px; color:#9fb2d9; display:inline-flex; gap:8px; align-items:center; }
    .sep { height:1px; background:#22314f; opacity:.7; }
    .chip { display:inline-flex; align-items:center; gap:8px; border:1px solid #22314f; background:rgba(17,28,51,.8); border-radius:14px; padding:8px 10px; }
    .muted { color:#9fb2d9; }
    .title { font-weight:900; letter-spacing:-.2px; }
    .dangerbox { border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.12); border-radius:16px; padding:12px; }
    .okbox { border:1px solid rgba(34,197,94,.35); background:rgba(34,197,94,.10); border-radius:16px; padding:12px; }
    .warnbox { border:1px solid rgba(245,158,11,.35); background:rgba(245,158,11,.10); border-radius:16px; padding:12px; }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal { width:min(980px, 92vw); max-height:86vh; overflow:auto; border:1px solid #22314f; background:rgba(17,28,51,.9); backdrop-filter: blur(10px); border-radius:18px; box-shadow:0 25px 80px rgba(0,0,0,.55); }
  </style>
</head>

<body class="min-h-screen">

<header class="sticky top-0 z-50 border-b border-border bg-bg1/75 backdrop-blur">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand to-mint flex items-center justify-center soft-shadow">
        <i class="fa-solid fa-x-ray text-white text-lg"></i>
      </div>
      <div>
        <div class="title">RadMentor (Single-file)</div>
        <div class="text-xs muted -mt-0.5">آموزش/پژوهش تفسیر CXR با گروه‌بندی مداخله/کنترل</div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <div id="hdr-phase" class="hidden md:flex pill items-center gap-2">
        <i class="fa-solid fa-flask"></i>
        <span>Phase: <span id="hdr-phase-text" class="text-txt font-bold">—</span></span>
      </div>

      <div id="hdr-protocol" class="hidden md:flex pill items-center gap-2">
        <i class="fa-solid fa-diagram-project"></i>
        <span>Protocol: <span id="hdr-protocol-text" class="text-txt font-bold">—</span></span>
      </div>

      <div id="hdr-user" class="hidden chip">
        <i class="fa-solid fa-user-doctor muted"></i>
        <div class="text-sm">
          <div class="font-extrabold" id="hdr-username">—</div>
          <div class="text-xs muted -mt-1">
            <span id="hdr-role">—</span> • <span id="hdr-group">—</span>
          </div>
        </div>
      </div>

      <button id="btn-logout" class="hidden btn">
        <i class="fa-solid fa-right-from-bracket ml-2"></i>خروج
      </button>
    </div>
  </div>
</header>

<div id="app" class="max-w-7xl mx-auto p-4 grid gap-4"></div>

<!-- Toast -->
<div id="toast" class="fixed bottom-5 left-5 hidden px-4 py-3 rounded-xl border border-border bg-panel soft-shadow text-sm"></div>

<!-- Modal -->
<div id="modal-backdrop" class="modal-backdrop">
  <div class="modal scroll">
    <div class="p-4 border-b border-border flex items-center justify-between">
      <div class="font-black text-lg" id="modal-title">—</div>
      <button id="modal-close" class="btn"><i class="fa-solid fa-xmark ml-2"></i>بستن</button>
    </div>
    <div class="p-4" id="modal-body"></div>
  </div>
</div>

<script>
/* ============================================================
   RadMentor Single-file Platform
   - Storage: IndexedDB (durable)
   - Auth: client-side PBKDF2 hash (NOT server-grade)
   - Roles: ADMIN / STUDENT
   - Groups: AI / CONTROL
   - Protocol: phases, locks, assignments, attempt logging
   - Admin dashboard: users, assignments, attempts, export, audit
   - Student: assigned cases, timer, structured reporting, AI panel w/ locks
============================================================ */

/* -----------------------------
   Helpers
----------------------------- */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const app = $("#app");

function escapeHtml(s="") {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function toast(msg, kind="info", ms=2800) {
  const el = $("#toast");
  el.classList.remove("hidden");
  el.textContent = msg;
  el.style.borderColor = kind==="error" ? "#ef4444" : kind==="ok" ? "#14b8a6" : kind==="warn" ? "#f59e0b" : "#22314f";
  setTimeout(() => el.classList.add("hidden"), ms);
}

function fmtTimeSec(sec) {
  if (sec == null || Number.isNaN(sec)) return "—";
  sec = Math.max(0, Math.floor(sec));
  const mm = String(Math.floor(sec/60)).padStart(2,"0");
  const ss = String(sec%60).padStart(2,"0");
  return `${mm}:${ss}`;
}

function uuid() {
  // not cryptographically perfect, enough for IDs
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
    const r = Math.random()*16|0;
    const v = c === "x" ? r : (r&0x3|0x8);
    return v.toString(16);
  });
}

function nowMs(){ return Date.now(); }

/* -----------------------------
   Wikimedia Creative Commons images
----------------------------- */
const IMG = (fileName) => `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(fileName)}`;

/* Seed cases (you can add more via Admin later if you want) */
const SEED_CASES = [
  {
    id: "CXR-0001",
    title: "نرمال (PA)",
    modality: "CXR",
    view: "PA",
    age: 28,
    sex: "F",
    complaint: "Check-up",
    imageUrl: IMG("Normal_posteroanterior_(PA)_chest_radiograph_(X-ray).jpg"),
    truth: { primaryDx: "normal", findings: [] },
    ai: {
      probs: { pneumonia: 0.03, pneumothorax: 0.01, effusion: 0.02, cardiomegaly: 0.06, normal: 0.92 },
      heatmap: { x: 50, y: 50, r: 35 }
    }
  },
  {
    id: "CXR-0002",
    title: "پنومونی واضح (RML/RLL)",
    modality: "CXR",
    view: "PA",
    age: 56,
    sex: "M",
    complaint: "تب + تنگی نفس",
    imageUrl: IMG("PneumonisWedge09.JPG"),
    truth: { primaryDx: "pneumonia", findings: ["consolidation"] },
    ai: {
      probs: { pneumonia: 0.89, pneumothorax: 0.02, effusion: 0.12, cardiomegaly: 0.08, normal: 0.05 },
      heatmap: { x: 70, y: 65, r: 28 }
    }
  },
  {
    id: "CXR-0003",
    title: "پنوموتوراکس (مثال آموزشی)",
    modality: "CXR",
    view: "AP",
    age: 34,
    sex: "M",
    complaint: "درد قفسه سینه ناگهانی",
    imageUrl: IMG("Pneumothorax_CXR.jpg"),
    truth: { primaryDx: "pneumothorax", findings: ["pneumothorax"] },
    ai: {
      probs: { pneumonia: 0.04, pneumothorax: 0.92, effusion: 0.08, cardiomegaly: 0.05, normal: 0.03 },
      heatmap: { x: 30, y: 40, r: 30 }
    }
  },
  {
    id: "CXR-0004",
    title: "افیوژن پلور (Right)",
    modality: "CXR",
    view: "PA",
    age: 67,
    sex: "F",
    complaint: "تنگی نفس",
    imageUrl: IMG("Pleural_effusion.jpg"),
    truth: { primaryDx: "effusion", findings: ["effusion"] },
    ai: {
      probs: { pneumonia: 0.18, pneumothorax: 0.01, effusion: 0.86, cardiomegaly: 0.12, normal: 0.04 },
      heatmap: { x: 72, y: 78, r: 30 }
    }
  }
];

/* -----------------------------
   App State (in-memory)
----------------------------- */
const state = {
  session: null, // { userId, username, role, group, protocolId }
  protocol: null,
  viewer: { zoom: 1, invert: false, brightness: 100, contrast: 100 },
  current: {
    assignmentId: null,
    caseId: null,
    startedAtMs: null,
    aiShown: false,
    started: false
  }
};

/* -----------------------------
   IndexedDB tiny layer
----------------------------- */
const DB_NAME = "radmentor_singlefile_db";
const DB_VERSION = 1;

let db = null;

function idbOpen() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const d = req.result;

      // users
      if (!d.objectStoreNames.contains("users")) {
        const s = d.createObjectStore("users", { keyPath: "id" });
        s.createIndex("username", "username", { unique: true });
        s.createIndex("role", "role", { unique: false });
        s.createIndex("group", "group", { unique: false });
      }

      // protocols (single active + history)
      if (!d.objectStoreNames.contains("protocols")) {
        const s = d.createObjectStore("protocols", { keyPath: "id" });
        s.createIndex("active", "active", { unique: false });
      }

      // cases
      if (!d.objectStoreNames.contains("cases")) {
        const s = d.createObjectStore("cases", { keyPath: "id" });
        s.createIndex("modality", "modality", { unique: false });
      }

      // assignments (user <-> case, phase, order, locks)
      if (!d.objectStoreNames.contains("assignments")) {
        const s = d.createObjectStore("assignments", { keyPath: "id" });
        s.createIndex("userId", "userId", { unique: false });
        s.createIndex("phase", "phase", { unique: false });
        s.createIndex("status", "status", { unique: false }); // OPEN / DONE
      }

      // attempts (each submission)
      if (!d.objectStoreNames.contains("attempts")) {
        const s = d.createObjectStore("attempts", { keyPath: "id" });
        s.createIndex("userId", "userId", { unique: false });
        s.createIndex("caseId", "caseId", { unique: false });
        s.createIndex("phase", "phase", { unique: false });
        s.createIndex("createdAt", "createdAt", { unique: false });
      }

      // audit (admin ops)
      if (!d.objectStoreNames.contains("audit")) {
        const s = d.createObjectStore("audit", { keyPath: "id" });
        s.createIndex("createdAt", "createdAt", { unique: false });
        s.createIndex("actorUserId", "actorUserId", { unique: false });
      }

      // meta
      if (!d.objectStoreNames.contains("meta")) {
        d.createObjectStore("meta", { keyPath: "key" });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function tx(store, mode="readonly") {
  const t = db.transaction(store, mode);
  return { store: t.objectStore(store), done: () => new Promise((res, rej)=>{ t.oncomplete=res; t.onerror=()=>rej(t.error); }) };
}

async function idbPut(storeName, value) {
  const { store, done } = tx(storeName, "readwrite");
  store.put(value);
  await done();
  return value;
}

async function idbGet(storeName, key) {
  const { store, done } = tx(storeName, "readonly");
  const req = store.get(key);
  const out = await new Promise((res, rej)=>{ req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); });
  await done();
  return out;
}

async function idbDel(storeName, key) {
  const { store, done } = tx(storeName, "readwrite");
  store.delete(key);
  await done();
}

async function idbAll(storeName) {
  const { store, done } = tx(storeName, "readonly");
  const req = store.getAll();
  const out = await new Promise((res, rej)=>{ req.onsuccess=()=>res(req.result||[]); req.onerror=()=>rej(req.error); });
  await done();
  return out;
}

async function idbByIndex(storeName, indexName, value) {
  const { store, done } = tx(storeName, "readonly");
  const idx = store.index(indexName);
  const req = idx.getAll(value);
  const out = await new Promise((res, rej)=>{ req.onsuccess=()=>res(req.result||[]); req.onerror=()=>rej(req.error); });
  await done();
  return out;
}

async function idbFirstByIndex(storeName, indexName, value) {
  const all = await idbByIndex(storeName, indexName, value);
  return all[0] || null;
}

/* -----------------------------
   Crypto: PBKDF2 password hashing
   (Still client-side, but avoids plain text storage.)
----------------------------- */
async function pbkdf2Hash(password, saltB64, iterations=150000) {
  const enc = new TextEncoder();
  const salt = saltB64 ? Uint8Array.from(atob(saltB64), c => c.charCodeAt(0)) : crypto.getRandomValues(new Uint8Array(16));
  const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveBits"]);
  const bits = await crypto.subtle.deriveBits(
    { name: "PBKDF2", salt, iterations, hash: "SHA-256" },
    keyMaterial,
    256
  );
  const hash = new Uint8Array(bits);
  const hashB64 = btoa(String.fromCharCode(...hash));
  const newSaltB64 = btoa(String.fromCharCode(...salt));
  return { saltB64: newSaltB64, hashB64 };
}

function constantTimeEqual(a, b) {
  a = String(a||""); b = String(b||"");
  if (a.length !== b.length) return false;
  let out = 0;
  for (let i=0;i<a.length;i++) out |= (a.charCodeAt(i) ^ b.charCodeAt(i));
  return out === 0;
}

/* -----------------------------
   Protocol & Policy (research logic)
----------------------------- */
const PHASES = ["pilot","pretest","training","posttest"];

function defaultProtocol() {
  return {
    id: "proto-" + uuid(),
    name: "default-rct",
    active: true,
    createdAt: nowMs(),
    // research rules
    rules: {
      // AI availability policy:
      // - pretest/posttest => never show AI
      // - exam mode => never show AI
      // - training => only if group AI and only AFTER initial answer is locked (enforced in UI here)
      ai: {
        disableInPhases: ["pretest","posttest"],
        disableInUIModes: ["exam"],
        requireInitialSubmitBeforeAI: true
      },
      // training feedback: after submit show truth? (for demo yes; in RCT you may disable)
      feedback: {
        showTruthInTraining: true,
        showTruthInExam: false
      },
      // scoring weights
      scoring: {
        dxWeight: 70,
        findingsWeight: 30
      }
    }
  };
}

function canUseAI({ user, phase, uiMode, initialSubmitted }) {
  const proto = state.protocol;
  if (!proto) return false;
  if (!user) return false;
  if (proto.rules.ai.disableInPhases.includes(phase)) return false;
  if (proto.rules.ai.disableInUIModes.includes(uiMode)) return false;
  if (user.group !== "AI") return false;
  if (proto.rules.ai.requireInitialSubmitBeforeAI && !initialSubmitted) return false;
  return true;
}

/* -----------------------------
   Audit log
----------------------------- */
async function audit(action, detail={}) {
  const actor = state.session?.userId || null;
  const entry = {
    id: "aud-" + uuid(),
    createdAt: nowMs(),
    actorUserId: actor,
    actorUsername: state.session?.username || "anonymous",
    action,
    detail
  };
  await idbPut("audit", entry);
}

/* -----------------------------
   Seed DB (first run)
----------------------------- */
async function seedIfNeeded() {
  const meta = await idbGet("meta", "seeded");
  if (meta?.value === true) return;

  // seed protocol
  const proto = defaultProtocol();
  await idbPut("protocols", proto);

  // seed cases
  for (const c of SEED_CASES) await idbPut("cases", c);

  // seed admin user
  const adminUser = await idbFirstByIndex("users", "username", "admin");
  if (!adminUser) {
    const { saltB64, hashB64 } = await pbkdf2Hash("admin1234");
    await idbPut("users", {
      id: "usr-" + uuid(),
      username: "admin",
      role: "ADMIN",
      group: "CONTROL",
      createdAt: nowMs(),
      pass: { saltB64, hashB64 },
      profile: { displayName: "Admin" }
    });
  }

  // Mark seeded
  await idbPut("meta", { key:"seeded", value:true, createdAt: nowMs() });
}

/* -----------------------------
   Session handling
----------------------------- */
function loadSession() {
  const raw = localStorage.getItem("rm_session");
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function saveSession(sess) {
  localStorage.setItem("rm_session", JSON.stringify(sess));
}
function clearSession() {
  localStorage.removeItem("rm_session");
}

async function refreshHeader() {
  const sess = state.session;
  const elUser = $("#hdr-user");
  const elLogout = $("#btn-logout");
  const elPhase = $("#hdr-phase");
  const elProto = $("#hdr-protocol");

  if (!sess) {
    elUser.classList.add("hidden");
    elLogout.classList.add("hidden");
    elPhase.classList.add("hidden");
    elProto.classList.add("hidden");
    return;
  }
  elUser.classList.remove("hidden");
  elLogout.classList.remove("hidden");
  elPhase.classList.remove("hidden");
  elProto.classList.remove("hidden");

  $("#hdr-username").textContent = sess.username;
  $("#hdr-role").textContent = sess.role;
  $("#hdr-group").textContent = sess.group;
  $("#hdr-phase-text").textContent = sess.phase || "—";
  $("#hdr-protocol-text").textContent = state.protocol?.name || "—";
}

/* -----------------------------
   Modal
----------------------------- */
function modalOpen(title, html) {
  $("#modal-title").textContent = title;
  $("#modal-body").innerHTML = html;
  $("#modal-backdrop").style.display = "flex";
}
function modalClose() {
  $("#modal-backdrop").style.display = "none";
  $("#modal-title").textContent = "—";
  $("#modal-body").innerHTML = "";
}
$("#modal-close").onclick = modalClose;
$("#modal-backdrop").addEventListener("click", (e) => {
  if (e.target.id === "modal-backdrop") modalClose();
});

/* -----------------------------
   Rendering: Login
----------------------------- */
function renderLogin() {
  app.innerHTML = `
    <div class="grid lg:grid-cols-2 gap-4">
      <div class="glass border border-border rounded-2xl p-6 soft-shadow">
        <div class="text-2xl font-black mb-2">ورود به سامانه</div>
        <div class="text-sm muted leading-7 mb-4">
          این نسخه «تک‌فایل» است و داده‌ها را در مرورگر (IndexedDB) ذخیره می‌کند. برای RCT واقعی بهتر است بک‌اند داشته باشید.
        </div>

        <div class="warnbox text-sm leading-7 mb-4">
          <div class="font-extrabold mb-1"><i class="fa-solid fa-triangle-exclamation ml-2"></i>یادآوری پژوهشی</div>
          <div>این سامانه برای آموزش/پژوهش است و جایگزین تصمیم‌گیری بالینی نیست.</div>
        </div>

        <div class="grid gap-3">
          <div>
            <label class="text-xs muted">نام کاربری</label>
            <input id="in-username" class="input mt-1" placeholder="مثلاً: student01" />
          </div>
          <div>
            <label class="text-xs muted">رمز عبور</label>
            <input id="in-password" type="password" class="input mt-1" placeholder="••••••••" />
          </div>

          <button id="btn-login" class="btn btn-primary">
            <i class="fa-solid fa-right-to-bracket ml-2"></i>ورود
          </button>

          <div class="text-xs muted leading-6">
            ورود پیش‌فرض ادمین: <span class="kbd">admin</span> / <span class="kbd">admin1234</span>
          </div>
        </div>
      </div>

      <div class="border border-border rounded-2xl p-6 bg-gradient-to-br from-panel to-bg1 soft-shadow">
        <div class="text-xl font-black mb-2">قابلیت‌ها (همه داخل همین فایل)</div>
        <ul class="text-sm muted leading-7 list-disc list-inside">
          <li>نقش‌ها: Admin / Student</li>
          <li>گروه‌بندی: AI vs Control</li>
          <li>پروتکل: فازها + قفل AI بر اساس Phase و Mode</li>
          <li>Assignment کیس‌ها برای هر کاربر</li>
          <li>ثبت زمان و پاسخ‌ها و نمره</li>
          <li>داشبورد Admin: مشاهده تلاش‌ها، فیلتر، خروجی CSV، audit log</li>
        </ul>

        <div class="mt-4 okbox text-sm leading-7">
          <div class="font-extrabold mb-1"><i class="fa-solid fa-seedling ml-2"></i>پیشنهاد عملی</div>
          <div>این تک‌فایل برای پایلوت عالی است. وقتی پروتکل نهایی شد، همین ساختار را به Node+SQLite مهاجرت می‌دهید.</div>
        </div>

        <div class="mt-4 text-xs muted leading-6">
          تصاویر نمونه از Wikimedia Commons با Special:FilePath لود می‌شوند (Creative Commons).
        </div>
      </div>
    </div>
  `;

  $("#btn-login").onclick = async () => {
    const username = $("#in-username").value.trim();
    const password = $("#in-password").value.trim();
    if (!username || !password) return toast("نام کاربری و رمز را وارد کنید.", "error");

    try {
      const user = await idbFirstByIndex("users", "username", username);
      if (!user) return toast("نام کاربری یا رمز اشتباه است.", "error");

      const { hashB64 } = await pbkdf2Hash(password, user.pass.saltB64);
      if (!constantTimeEqual(hashB64, user.pass.hashB64)) return toast("نام کاربری یا رمز اشتباه است.", "error");

      // load active protocol
      const protos = await idbAll("protocols");
      const active = protos.find(p => p.active) || protos[0] || defaultProtocol();
      if (!protos.length) await idbPut("protocols", active);

      state.protocol = active;

      // choose current phase per user (stored in localStorage per-user or default "pilot")
      const phaseKey = `rm_phase_${user.id}`;
      const phase = localStorage.getItem(phaseKey) || "pilot";

      state.session = {
        userId: user.id,
        username: user.username,
        role: user.role,
        group: user.group,
        protocolId: active.id,
        phase
      };
      saveSession(state.session);

      await audit("LOGIN", { username: user.username, role: user.role });

      toast("ورود موفق.", "ok");
      await refreshHeader();
      render();
    } catch (e) {
      toast("خطا در ورود: " + (e?.message || e), "error");
    }
  };
}

/* -----------------------------
   Common UI blocks
----------------------------- */
function card(title, icon, innerHtml, extra="") {
  return `
    <div class="glass border border-border rounded-2xl p-5 soft-shadow ${extra}">
      <div class="flex items-center justify-between mb-3">
        <div class="font-extrabold text-lg">
          <i class="fa-solid ${icon} muted ml-2"></i>${title}
        </div>
      </div>
      ${innerHtml}
    </div>
  `;
}

function smallCard(title, icon, innerHtml) {
  return `
    <div class="border border-border rounded-2xl bg-panel/70 p-4">
      <div class="font-extrabold mb-2">
        <i class="fa-solid ${icon} muted ml-2"></i>${title}
      </div>
      ${innerHtml}
    </div>
  `;
}

function badge(text, icon="fa-tag") {
  return `<span class="tag"><i class="fa-solid ${icon}"></i>${escapeHtml(text)}</span>`;
}

/* -----------------------------
   Admin: user management, protocol, cases, assignments, attempts
----------------------------- */
async function renderAdmin() {
  const users = await idbAll("users");
  const cases = await idbAll("cases");
  const protos = await idbAll("protocols");
  const proto = protos.find(p => p.active) || protos[0] || defaultProtocol();
  state.protocol = proto;

  const assignments = await idbAll("assignments");
  const attempts = (await idbAll("attempts")).sort((a,b)=>b.createdAt-a.createdAt);
  const auditLogs = (await idbAll("audit")).sort((a,b)=>b.createdAt-a.createdAt);

  app.innerHTML = `
    <div class="grid lg:grid-cols-12 gap-4">
      <section class="lg:col-span-4 grid gap-4">
        ${card("کنترل پنل Admin", "fa-shield-halved", `
          <div class="text-sm muted leading-7">
            مدیریت کاربران/گروه‌ها، تعیین پروتکل، تخصیص کیس‌ها، مشاهده نتایج و خروجی CSV.
          </div>
          <div class="sep my-4"></div>
          <div class="grid gap-2">
            <button id="btn-admin-create" class="btn btn-primary"><i class="fa-solid fa-user-plus ml-2"></i>ساخت کاربر Student</button>
            <button id="btn-admin-assign" class="btn"><i class="fa-solid fa-diagram-project ml-2"></i>تخصیص کیس‌ها (Assignments)</button>
            <button id="btn-admin-proto" class="btn"><i class="fa-solid fa-sliders ml-2"></i>تنظیم پروتکل (Locks/Rules)</button>
            <button id="btn-admin-cases" class="btn"><i class="fa-solid fa-images ml-2"></i>مدیریت کیس‌ها</button>
            <button id="btn-admin-export" class="btn"><i class="fa-solid fa-file-csv ml-2"></i>خروجی CSV تلاش‌ها</button>
            <button id="btn-admin-audit" class="btn"><i class="fa-solid fa-scroll ml-2"></i>Audit Log</button>
          </div>
        `)}

        ${smallCard("آمار سریع", "fa-chart-line", `
          <div class="grid gap-2 text-sm">
            <div class="flex items-center justify-between">
              <span class="muted">Users</span>
              <span class="font-extrabold">${users.length}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="muted">Cases</span>
              <span class="font-extrabold">${cases.length}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="muted">Assignments</span>
              <span class="font-extrabold">${assignments.length}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="muted">Attempts</span>
              <span class="font-extrabold">${attempts.length}</span>
            </div>
            <div class="sep my-2"></div>
            <div class="text-xs muted leading-6">
              Active Protocol: <span class="kbd">${escapeHtml(proto.name)}</span>
            </div>
          </div>
        `)}

        ${smallCard("ریسک‌های روش‌شناختی", "fa-triangle-exclamation", `
          <div class="text-sm muted leading-7">
            چون این نسخه روی مرورگر اجرا می‌شود، enforce واقعی گروه‌بندی و دستکاری‌ناپذیری داده‌ها در سطح سرور نداریم.
            برای RCT نهایی، بک‌اند لازم است.
          </div>
        `)}
      </section>

      <section class="lg:col-span-8 grid gap-4">
        ${card("نتایج ثبت‌شده (Attempts)", "fa-table", `
          <div class="grid md:grid-cols-3 gap-2 mb-3">
            <input id="f_user" class="input" placeholder="فیلتر نام کاربری..." />
            <select id="f_phase" class="select">
              <option value="">همه فازها</option>
              ${PHASES.map(p=>`<option value="${p}">${p}</option>`).join("")}
            </select>
            <select id="f_group" class="select">
              <option value="">همه گروه‌ها</option>
              <option value="AI">AI</option>
              <option value="CONTROL">CONTROL</option>
            </select>
          </div>

          <div id="attempts-table" class="scroll max-h-[70vh] overflow-auto border border-border rounded-2xl bg-bg0/25"></div>
        `)}

        ${card("Users (نمای کلی)", "fa-users", `
          <div class="scroll max-h-[40vh] overflow-auto border border-border rounded-2xl bg-bg0/25">
            ${users.map(u => `
              <div class="p-3 border-b border-border flex items-center justify-between">
                <div>
                  <div class="font-extrabold">${escapeHtml(u.username)} <span class="text-xs muted">(${u.role})</span></div>
                  <div class="text-xs muted">${u.group} • created: ${new Date(u.createdAt).toLocaleString("fa-IR")}</div>
                </div>
                <div class="flex gap-2">
                  <button class="btn" data-act="resetpass" data-uid="${u.id}"><i class="fa-solid fa-key ml-2"></i>Reset Pass</button>
                  <button class="btn" data-act="togglegrp" data-uid="${u.id}"><i class="fa-solid fa-people-arrows ml-2"></i>Toggle Group</button>
                  ${u.role!=="ADMIN" ? `<button class="btn btn-danger" data-act="deluser" data-uid="${u.id}"><i class="fa-solid fa-trash ml-2"></i>Delete</button>` : ""}
                </div>
              </div>
            `).join("")}
          </div>
        `)}
      </section>
    </div>
  `;

  // attempts table loader
  async function loadAttemptsTable() {
    const fUser = $("#f_user").value.trim().toLowerCase();
    const fPhase = $("#f_phase").value;
    const fGroup = $("#f_group").value;

    const items = (await idbAll("attempts"))
      .filter(a => !fUser || (a.username||"").toLowerCase().includes(fUser))
      .filter(a => !fPhase || a.phase === fPhase)
      .filter(a => !fGroup || a.group === fGroup)
      .sort((a,b)=>b.createdAt-a.createdAt)
      .slice(0, 800);

    $("#attempts-table").innerHTML = items.length ? items.map(a => {
      const ok = a.correctDx ? "text-mint" : "text-danger";
      return `
        <div class="p-3 border-b border-border">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">
              ${escapeHtml(a.username)} <span class="text-xs muted">(${a.group})</span>
            </div>
            <div class="text-xs muted">
              ${a.phase} • ${a.uiMode} • ${escapeHtml(a.caseId)} • ${a.durationSec ?? "—"}s
            </div>
          </div>
          <div class="mt-2 grid md:grid-cols-5 gap-2 text-xs">
            <div class="bg-panel/60 border border-border rounded-xl p-2">Dx: <span class="mono ${ok}">${escapeHtml(a.primaryDx||"")}</span></div>
            <div class="bg-panel/60 border border-border rounded-xl p-2">Truth: <span class="mono text-txt">${escapeHtml(a.truthPrimaryDx||"")}</span></div>
            <div class="bg-panel/60 border border-border rounded-xl p-2">Score: <span class="mono text-txt">${a.score ?? "—"}</span></div>
            <div class="bg-panel/60 border border-border rounded-xl p-2">AI allowed: <span class="mono text-txt">${a.aiAllowed ? "1":"0"}</span></div>
            <div class="bg-panel/60 border border-border rounded-xl p-2">AI shown: <span class="mono text-txt">${a.aiShown ? "1":"0"}</span></div>
          </div>
          <div class="mt-2 text-[11px] muted">
            findings: <span class="mono">${escapeHtml((a.findings||[]).join(","))}</span>
            • confidence: <span class="mono">${escapeHtml(a.confidence||"")}</span>
            • time: ${new Date(a.createdAt).toLocaleString("fa-IR")}
          </div>
          <div class="mt-2 flex gap-2">
            <button class="btn" data-act="viewattempt" data-aid="${a.id}">
              <i class="fa-solid fa-eye ml-2"></i>جزئیات
            </button>
          </div>
        </div>
      `;
    }).join("") : `<div class="p-6 text-sm muted">فعلاً داده‌ای ثبت نشده.</div>`;
  }

  $("#f_user").oninput = loadAttemptsTable;
  $("#f_phase").onchange = loadAttemptsTable;
  $("#f_group").onchange = loadAttemptsTable;

  await loadAttemptsTable();

  // Admin buttons
  $("#btn-admin-create").onclick = () => openCreateUserModal();
  $("#btn-admin-assign").onclick = () => openAssignmentsModal();
  $("#btn-admin-proto").onclick = () => openProtocolModal();
  $("#btn-admin-cases").onclick = () => openCasesModal();
  $("#btn-admin-export").onclick = () => exportAttemptsCSV();
  $("#btn-admin-audit").onclick = () => openAuditModal();

  // Users actions
  app.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const act = btn.dataset.act;
    const uid = btn.dataset.uid;
    const aid = btn.dataset.aid;

    if (act === "deluser") {
      const user = await idbGet("users", uid);
      if (!user) return;
      if (user.role === "ADMIN") return toast("ادمین حذف نمی‌شود.", "error");
      if (!confirm(`حذف کاربر ${user.username}? (Assignments و Attempts او باقی می‌ماند) `)) return;
      await idbDel("users", uid);
      await audit("DELETE_USER", { userId: uid, username: user.username });
      toast("کاربر حذف شد.", "ok");
      render();
    }

    if (act === "togglegrp") {
      const user = await idbGet("users", uid);
      if (!user) return;
      user.group = user.group === "AI" ? "CONTROL" : "AI";
      await idbPut("users", user);
      await audit("TOGGLE_GROUP", { userId: uid, username: user.username, newGroup: user.group });
      toast("گروه تغییر کرد.", "ok");
      render();
    }

    if (act === "resetpass") {
      const user = await idbGet("users", uid);
      if (!user) return;
      const newPass = prompt(`پسورد جدید برای ${user.username} را وارد کنید:`) || "";
      if (newPass.trim().length < 4) return toast("پسورد خیلی کوتاه است.", "error");
      const { saltB64, hashB64 } = await pbkdf2Hash(newPass.trim());
      user.pass = { saltB64, hashB64 };
      await idbPut("users", user);
      await audit("RESET_PASSWORD", { userId: uid, username: user.username });
      toast("پسورد تغییر کرد.", "ok");
    }

    if (act === "viewattempt") {
      const a = await idbGet("attempts", aid);
      if (!a) return;
      modalOpen("جزئیات Attempt", renderAttemptDetail(a));
    }
  }, { once: true }); // render() will rebind anyway
}

/* -----------------------------
   Admin Modals
----------------------------- */
function openCreateUserModal() {
  modalOpen("ساخت کاربر Student", `
    <div class="grid md:grid-cols-2 gap-4">
      <div class="border border-border rounded-2xl bg-bg0/25 p-4">
        <div class="font-extrabold mb-2">مشخصات ورود</div>
        <div class="grid gap-3">
          <div>
            <label class="text-xs muted">Username</label>
            <input id="nu" class="input mt-1" placeholder="student01" />
          </div>
          <div>
            <label class="text-xs muted">Password</label>
            <input id="np" class="input mt-1" type="password" placeholder="حداقل 4 کاراکتر" />
          </div>
          <div>
            <label class="text-xs muted">Group</label>
            <select id="ng" class="select mt-1">
              <option value="CONTROL">CONTROL</option>
              <option value="AI">AI</option>
            </select>
          </div>
          <button id="btn-create-user" class="btn btn-primary"><i class="fa-solid fa-user-plus ml-2"></i>ایجاد</button>
        </div>
      </div>

      <div class="warnbox text-sm leading-7">
        <div class="font-extrabold mb-1"><i class="fa-solid fa-triangle-exclamation ml-2"></i>توجه روش‌شناسی</div>
        <div>
          گروه‌بندی در RCT واقعی بهتر است سمت سرور enforce شود و randomization ثبت‌شده داشته باشد.
          اینجا برای پایلوت قابل استفاده است.
        </div>
        <div class="sep my-3"></div>
        <div class="text-xs muted">
          پیشنهاد: نام کاربری را به شکل <span class="kbd">S001</span>، <span class="kbd">S002</span> ... بسازید.
        </div>
      </div>
    </div>
  `);

  $("#btn-create-user").onclick = async () => {
    const username = $("#nu").value.trim();
    const password = $("#np").value.trim();
    const group = $("#ng").value;
    if (!username || !password) return toast("نام کاربری/رمز را وارد کنید.", "error");

    // create
    try {
      const existing = await idbFirstByIndex("users", "username", username);
      if (existing) return toast("این نام کاربری وجود دارد.", "error");

      const { saltB64, hashB64 } = await pbkdf2Hash(password);
      const user = {
        id: "usr-" + uuid(),
        username,
        role: "STUDENT",
        group: group === "AI" ? "AI" : "CONTROL",
        createdAt: nowMs(),
        pass: { saltB64, hashB64 },
        profile: { displayName: username }
      };
      await idbPut("users", user);
      await audit("CREATE_USER", { userId: user.id, username, group: user.group });

      toast("کاربر ساخته شد.", "ok");
      modalClose();
      render();
    } catch (e) {
      toast("خطا: " + (e?.message || e), "error");
    }
  };
}

async function openProtocolModal() {
  const protos = await idbAll("protocols");
  let proto = protos.find(p => p.active) || protos[0] || defaultProtocol();
  state.protocol = proto;

  modalOpen("تنظیم پروتکل پژوهشی (Locks/Rules)", `
    <div class="grid gap-4">
      <div class="border border-border rounded-2xl bg-bg0/25 p-4">
        <div class="font-extrabold mb-2">پروتکل فعال</div>
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs muted">Protocol Name</label>
            <input id="p_name" class="input mt-1" value="${escapeHtml(proto.name)}" />
          </div>
          <div class="text-xs muted leading-6">
            تغییر قوانین باید قبل از شروع فاز RCT قفل شود. اینجا برای پایلوت قابل ویرایش است.
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="border border-border rounded-2xl bg-bg0/25 p-4">
          <div class="font-extrabold mb-3"><i class="fa-solid fa-robot muted ml-2"></i>قوانین نمایش AI</div>

          <label class="flex items-center gap-2 px-3 py-2 rounded-xl border border-border bg-panel/50 cursor-pointer">
            <input id="ai_lock_prepost" type="checkbox" class="accent-mint" checked />
            <span class="text-sm">قفل AI در pretest و posttest (پیشنهاد شده)</span>
          </label>

          <label class="flex items-center gap-2 px-3 py-2 rounded-xl border border-border bg-panel/50 cursor-pointer mt-2">
            <input id="ai_lock_exam" type="checkbox" class="accent-mint" checked />
            <span class="text-sm">قفل AI در exam mode (پیشنهاد شده)</span>
          </label>

          <label class="flex items-center gap-2 px-3 py-2 rounded-xl border border-border bg-panel/50 cursor-pointer mt-2">
            <input id="ai_after_submit" type="checkbox" class="accent-mint" checked />
            <span class="text-sm">AI فقط بعد از ثبت پاسخ اولیه (مداخله واقعی)</span>
          </label>

          <div class="sep my-3"></div>
          <div class="text-xs muted leading-6">
            در گروه AI، خروجی AI بعد از پاسخ اولیه می‌تواند برای «تغییر پاسخ» اندازه‌گیری شود.
          </div>
        </div>

        <div class="border border-border rounded-2xl bg-bg0/25 p-4">
          <div class="font-extrabold mb-3"><i class="fa-solid fa-star-half-stroke muted ml-2"></i>بازخورد/نمره</div>

          <label class="flex items-center gap-2 px-3 py-2 rounded-xl border border-border bg-panel/50 cursor-pointer">
            <input id="fb_training_truth" type="checkbox" class="accent-mint" ${proto.rules.feedback.showTruthInTraining ? "checked":""} />
            <span class="text-sm">در Training، Truth/Feedback بعد از ثبت نشان داده شود</span>
          </label>

          <label class="flex items-center gap-2 px-3 py-2 rounded-xl border border-border bg-panel/50 cursor-pointer mt-2">
            <input id="fb_exam_truth" type="checkbox" class="accent-mint" ${proto.rules.feedback.showTruthInExam ? "checked":""} />
            <span class="text-sm">در Exam، Truth نشان داده شود (معمولاً نه)</span>
          </label>

          <div class="sep my-3"></div>

          <div class="grid grid-cols-2 gap-2 text-sm">
            <div>
              <label class="text-xs muted">وزن Dx</label>
              <input id="w_dx" class="input mt-1" type="number" min="0" max="100" value="${proto.rules.scoring.dxWeight}" />
            </div>
            <div>
              <label class="text-xs muted">وزن Findings</label>
              <input id="w_find" class="input mt-1" type="number" min="0" max="100" value="${proto.rules.scoring.findingsWeight}" />
            </div>
          </div>

          <div class="text-xs muted mt-3">مجموع وزن‌ها بهتر است 100 باشد.</div>
        </div>
      </div>

      <div class="flex gap-2 justify-end">
        <button id="btn-proto-save" class="btn btn-primary"><i class="fa-solid fa-floppy-disk ml-2"></i>ذخیره</button>
      </div>
    </div>
  `);

  // set defaults for ai checkboxes based on proto
  const lockPrePost = $("#ai_lock_prepost");
  const lockExam = $("#ai_lock_exam");
  const afterSubmit = $("#ai_after_submit");

  lockPrePost.checked = proto.rules.ai.disableInPhases.includes("pretest") && proto.rules.ai.disableInPhases.includes("posttest");
  lockExam.checked = proto.rules.ai.disableInUIModes.includes("exam");
  afterSubmit.checked = !!proto.rules.ai.requireInitialSubmitBeforeAI;

  $("#btn-proto-save").onclick = async () => {
    proto.name = $("#p_name").value.trim() || proto.name;

    // rebuild rules arrays based on toggles
    proto.rules.ai.disableInPhases = lockPrePost.checked ? ["pretest","posttest"] : [];
    proto.rules.ai.disableInUIModes = lockExam.checked ? ["exam"] : [];
    proto.rules.ai.requireInitialSubmitBeforeAI = afterSubmit.checked;

    proto.rules.feedback.showTruthInTraining = $("#fb_training_truth").checked;
    proto.rules.feedback.showTruthInExam = $("#fb_exam_truth").checked;

    const wdx = Number($("#w_dx").value);
    const wfi = Number($("#w_find").value);
    proto.rules.scoring.dxWeight = Number.isFinite(wdx) ? wdx : 70;
    proto.rules.scoring.findingsWeight = Number.isFinite(wfi) ? wfi : 30;

    await idbPut("protocols", proto);
    state.protocol = proto;
    await audit("UPDATE_PROTOCOL", { protocolId: proto.id, name: proto.name, rules: proto.rules });

    toast("پروتکل ذخیره شد.", "ok");
    modalClose();
    render();
  };
}

async function openCasesModal() {
  const cases = (await idbAll("cases")).sort((a,b)=>a.id.localeCompare(b.id));
  modalOpen("مدیریت کیس‌ها", `
    <div class="grid gap-4">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="border border-border rounded-2xl bg-bg0/25 p-4">
          <div class="font-extrabold mb-2">افزودن کیس جدید</div>
          <div class="text-xs muted mb-3">برای شروع پایلوت می‌توانید فقط چند کیس داشته باشید.</div>

          <div class="grid gap-2">
            <input id="c_id" class="input" placeholder="Case ID مثل CXR-0101" />
            <input id="c_title" class="input" placeholder="Title" />
            <input id="c_img" class="input" placeholder="Image URL (ترجیحاً Wikimedia Special:FilePath)" />
            <div class="grid grid-cols-2 gap-2">
              <select id="c_view" class="select">
                <option value="PA">PA</option>
                <option value="AP">AP</option>
                <option value="LAT">LAT</option>
              </select>
              <select id="c_sex" class="select">
                <option value="M">M</option>
                <option value="F">F</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <input id="c_age" class="input" type="number" min="0" max="120" placeholder="Age" />
              <input id="c_complaint" class="input" placeholder="Complaint" />
            </div>

            <div class="sep my-2"></div>
            <div class="font-extrabold text-sm">Ground Truth</div>
            <select id="c_truth_dx" class="select">
              <option value="normal">normal</option>
              <option value="pneumonia">pneumonia</option>
              <option value="pneumothorax">pneumothorax</option>
              <option value="effusion">effusion</option>
              <option value="chf">chf</option>
              <option value="other">other</option>
            </select>
            <input id="c_truth_find" class="input" placeholder="Truth findings comma-separated (مثلاً effusion,cardiomegaly)" />

            <div class="sep my-2"></div>
            <button id="btn-case-add" class="btn btn-primary"><i class="fa-solid fa-plus ml-2"></i>افزودن</button>
          </div>
        </div>

        <div class="warnbox text-sm leading-7">
          <div class="font-extrabold mb-1"><i class="fa-solid fa-scale-balanced ml-2"></i>حقوقی/اخلاقی</div>
          <div>برای کیس‌های واقعی بیمارستانی: ناشناس‌سازی، رضایت، و مجوز IRB لازم است. برای demo از Creative Commons استفاده کنید.</div>
          <div class="sep my-3"></div>
          <div class="text-xs muted">
            نکته: در RCT، «مجموعه کیس‌ها» بهتر است قبل از شروع قفل شود و نسخه‌بندی داشته باشد.
          </div>
        </div>
      </div>

      <div class="border border-border rounded-2xl bg-bg0/25">
        <div class="p-4 border-b border-border flex items-center justify-between">
          <div class="font-extrabold">لیست کیس‌ها (${cases.length})</div>
          <button id="btn-case-seed" class="btn"><i class="fa-solid fa-arrows-rotate ml-2"></i>Seed دوباره کیس‌های نمونه</button>
        </div>
        <div class="scroll max-h-[55vh] overflow-auto">
          ${cases.map(c => `
            <div class="p-4 border-b border-border">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="font-extrabold">${escapeHtml(c.id)} — ${escapeHtml(c.title)}</div>
                  <div class="text-xs muted">${c.sex}, ${c.age} • ${c.view} • ${escapeHtml(c.complaint||"")}</div>
                  <div class="text-xs muted mt-1">Truth: <span class="mono">${escapeHtml(c.truth?.primaryDx||"")}</span> • Findings: <span class="mono">${escapeHtml((c.truth?.findings||[]).join(","))}</span></div>
                </div>
                <div class="flex gap-2">
                  <button class="btn" data-act="case-preview" data-cid="${c.id}"><i class="fa-solid fa-image ml-2"></i>Preview</button>
                  <button class="btn btn-danger" data-act="case-del" data-cid="${c.id}"><i class="fa-solid fa-trash ml-2"></i>Delete</button>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `);

  $("#btn-case-add").onclick = async () => {
    const id = $("#c_id").value.trim();
    const title = $("#c_title").value.trim();
    const imageUrl = $("#c_img").value.trim();
    const view = $("#c_view").value;
    const sex = $("#c_sex").value;
    const age = Number($("#c_age").value);
    const complaint = $("#c_complaint").value.trim();
    const truthDx = $("#c_truth_dx").value;
    const truthFind = $("#c_truth_find").value.trim();

    if (!id || !title || !imageUrl) return toast("id/title/imageUrl ضروری است.", "error");
    const existing = await idbGet("cases", id);
    if (existing) return toast("این Case ID وجود دارد.", "error");

    const findings = truthFind ? truthFind.split(",").map(s=>s.trim()).filter(Boolean) : [];

    const c = {
      id, title, modality:"CXR", view, age: Number.isFinite(age)?age:null, sex,
      complaint, imageUrl,
      truth: { primaryDx: truthDx, findings },
      ai: { probs: { pneumonia: .2, pneumothorax:.2, effusion:.2, cardiomegaly:.2, normal:.2 }, heatmap: {x:50,y:50,r:30} }
    };

    await idbPut("cases", c);
    await audit("ADD_CASE", { caseId: id, title });
    toast("کیس اضافه شد.", "ok");
    modalClose();
    openCasesModal();
  };

  $("#btn-case-seed").onclick = async () => {
    for (const c of SEED_CASES) await idbPut("cases", c);
    await audit("RESEED_CASES", { count: SEED_CASES.length });
    toast("Seed انجام شد.", "ok");
    modalClose();
    openCasesModal();
  };

  $("#modal-body").addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const act = btn.dataset.act;
    const cid = btn.dataset.cid;

    if (act === "case-preview") {
      const c = await idbGet("cases", cid);
      if (!c) return;
      modalOpen("Preview کیس " + c.id, `
        <div class="grid md:grid-cols-2 gap-4">
          <div class="viewer h-[60vh]">
            <img src="${escapeHtml(c.imageUrl)}" alt="case" />
          </div>
          <div class="border border-border rounded-2xl bg-bg0/25 p-4">
            <div class="font-extrabold mb-2">${escapeHtml(c.title)}</div>
            <div class="text-sm muted leading-7">
              ${c.sex}, ${c.age} • ${c.view}<br/>
              Complaint: ${escapeHtml(c.complaint||"—")}<br/>
              Truth Dx: <span class="mono">${escapeHtml(c.truth?.primaryDx||"")}</span><br/>
              Truth Findings: <span class="mono">${escapeHtml((c.truth?.findings||[]).join(","))}</span>
            </div>
            <div class="sep my-3"></div>
            <div class="text-xs muted">Image URL:</div>
            <div class="text-xs mono break-all">${escapeHtml(c.imageUrl)}</div>
          </div>
        </div>
      `);
    }

    if (act === "case-del") {
      if (!confirm(`حذف کیس ${cid}?`)) return;
      await idbDel("cases", cid);
      await audit("DELETE_CASE", { caseId: cid });
      toast("کیس حذف شد.", "ok");
      modalClose();
      openCasesModal();
    }
  }, { once:true });
}

async function openAssignmentsModal() {
  const users = (await idbAll("users")).filter(u=>u.role==="STUDENT").sort((a,b)=>a.username.localeCompare(b.username));
  const cases = (await idbAll("cases")).sort((a,b)=>a.id.localeCompare(b.id));
  const assignments = await idbAll("assignments");

  modalOpen("Assignments | تخصیص کیس‌ها به کاربران", `
    <div class="grid gap-4">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="border border-border rounded-2xl bg-bg0/25 p-4">
          <div class="font-extrabold mb-2">تخصیص سریع (Batch Assign)</div>
          <div class="text-xs muted mb-3">
            برای هر Student، تعدادی کیس را به یک Phase تخصیص بده (Order هم ثبت می‌شود).
          </div>

          <div class="grid gap-2">
            <label class="text-xs muted">Student</label>
            <select id="as_user" class="select">
              ${users.map(u=>`<option value="${u.id}">${escapeHtml(u.username)} (${u.group})</option>`).join("")}
            </select>

            <label class="text-xs muted">Phase</label>
            <select id="as_phase" class="select">
              ${PHASES.map(p=>`<option value="${p}">${p}</option>`).join("")}
            </select>

            <label class="text-xs muted">UIMode</label>
            <select id="as_uimode" class="select">
              <option value="training">training</option>
              <option value="exam">exam</option>
            </select>

            <label class="text-xs muted">انتخاب کیس‌ها</label>
            <div class="scroll max-h-[200px] overflow-auto border border-border rounded-2xl bg-panel/40 p-2">
              ${cases.map(c=>`
                <label class="flex items-center gap-2 px-3 py-2 rounded-xl border border-border bg-bg0/40 cursor-pointer mb-2">
                  <input type="checkbox" class="accent-mint" data-case="${c.id}" />
                  <span class="text-sm">${escapeHtml(c.id)} — ${escapeHtml(c.title)}</span>
                  <span class="text-xs muted mr-auto">${escapeHtml(c.truth?.primaryDx||"")}</span>
                </label>
              `).join("")}
            </div>

            <label class="text-xs muted mt-2">Randomize order?</label>
            <label class="flex items-center gap-2 px-3 py-2 rounded-xl border border-border bg-panel/50 cursor-pointer">
              <input id="as_rand" type="checkbox" class="accent-mint" checked />
              <span class="text-sm">ترتیب کیس‌ها برای این کاربر shuffle شود</span>
            </label>

            <button id="btn-assign" class="btn btn-primary mt-2">
              <i class="fa-solid fa-diagram-project ml-2"></i>تخصیص
            </button>

            <div class="sep my-2"></div>
            <button id="btn-clear-open" class="btn btn-danger">
              <i class="fa-solid fa-broom ml-2"></i>حذف Assignments باز (OPEN) برای این کاربر/فاز
            </button>
          </div>
        </div>

        <div class="border border-border rounded-2xl bg-bg0/25 p-4">
          <div class="font-extrabold mb-2">تخصیص کامل برای همه (Auto)</div>
          <div class="text-xs muted leading-6 mb-3">
            به همه دانشجوها، همه کیس‌ها را برای یک فاز تخصیص می‌دهد (با ترتیب رندوم برای هر نفر).
            برای پایلوت سریع کاربردی است.
          </div>

          <label class="text-xs muted">Phase</label>
          <select id="as_all_phase" class="select">
            ${PHASES.map(p=>`<option value="${p}">${p}</option>`).join("")}
          </select>

          <label class="text-xs muted mt-2">UIMode</label>
          <select id="as_all_uimode" class="select">
            <option value="training">training</option>
            <option value="exam">exam</option>
          </select>

          <button id="btn-assign-all" class="btn mt-3">
            <i class="fa-solid fa-wand-magic-sparkles ml-2"></i>Assign to all students
          </button>

          <div class="sep my-3"></div>
          <div class="warnbox text-sm leading-7">
            <div class="font-extrabold mb-1"><i class="fa-solid fa-triangle-exclamation ml-2"></i>RCT Tip</div>
            <div>اگر pretest/posttest دارید، بهتر است همان کیس‌ها باشند یا کیس‌های matched و تصادفی‌سازی‌شده.</div>
          </div>
        </div>
      </div>

      <div class="border border-border rounded-2xl bg-bg0/25">
        <div class="p-4 border-b border-border flex items-center justify-between">
          <div class="font-extrabold">Assignments موجود (${assignments.length})</div>
          <div class="text-xs muted">نمایش آخرین 300</div>
        </div>
        <div class="scroll max-h-[55vh] overflow-auto">
          ${assignments
            .sort((a,b)=>b.createdAt-a.createdAt)
            .slice(0,300)
            .map(a=>`
              <div class="p-3 border-b border-border flex items-center justify-between gap-3">
                <div>
                  <div class="font-extrabold text-sm">${escapeHtml(a.username)} • ${escapeHtml(a.caseId)}</div>
                  <div class="text-xs muted">
                    phase: ${a.phase} • mode: ${a.uiMode} • status: ${a.status} • order: ${a.order}
                  </div>
                </div>
                <div class="flex gap-2">
                  <button class="btn" data-act="as_done" data-aid="${a.id}">
                    <i class="fa-solid fa-check ml-2"></i>Mark DONE
                  </button>
                  <button class="btn btn-danger" data-act="as_del" data-aid="${a.id}">
                    <i class="fa-solid fa-trash ml-2"></i>Delete
                  </button>
                </div>
              </div>
            `).join("")}
        </div>
      </div>
    </div>
  `);

  function shuffle(arr) {
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--) {
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  $("#btn-assign").onclick = async () => {
    const userId = $("#as_user").value;
    const phase = $("#as_phase").value;
    const uiMode = $("#as_uimode").value;
    const rand = $("#as_rand").checked;

    const user = await idbGet("users", userId);
    if (!user) return toast("کاربر پیدا نشد.", "error");

    const selected = $$("input[type=checkbox][data-case]").filter(x=>x.checked).map(x=>x.dataset.case);
    if (!selected.length) return toast("حداقل یک کیس انتخاب کنید.", "error");

    const ordered = rand ? shuffle(selected) : selected;
    let order = 1;
    for (const caseId of ordered) {
      const a = {
        id: "as-" + uuid(),
        createdAt: nowMs(),
        userId,
        username: user.username,
        group: user.group,
        phase,
        uiMode,
        caseId,
        status: "OPEN",
        order: order++
      };
      await idbPut("assignments", a);
    }

    await audit("ASSIGN_CASES", { userId, username: user.username, phase, uiMode, count: selected.length, randomized: rand });
    toast("Assignments ثبت شد.", "ok");
    modalClose();
    openAssignmentsModal();
  };

  $("#btn-clear-open").onclick = async () => {
    const userId = $("#as_user").value;
    const phase = $("#as_phase").value;
    const user = await idbGet("users", userId);
    if (!user) return;

    if (!confirm(`Assignments باز (OPEN) برای ${user.username} در فاز ${phase} حذف شود؟`)) return;

    const all = await idbAll("assignments");
    const targets = all.filter(a => a.userId===userId && a.phase===phase && a.status==="OPEN");
    for (const t of targets) await idbDel("assignments", t.id);

    await audit("CLEAR_ASSIGNMENTS_OPEN", { userId, username: user.username, phase, count: targets.length });
    toast("پاکسازی انجام شد.", "ok");
    modalClose();
    openAssignmentsModal();
  };

  $("#btn-assign-all").onclick = async () => {
    const phase = $("#as_all_phase").value;
    const uiMode = $("#as_all_uimode").value;

    if (!confirm(`به همه دانشجوها برای فاز ${phase} همه کیس‌ها تخصیص داده شود؟`)) return;

    for (const u of users) {
      const ordered = shuffle(cases.map(c=>c.id));
      let order = 1;
      for (const caseId of ordered) {
        await idbPut("assignments", {
          id:"as-"+uuid(),
          createdAt: nowMs(),
          userId: u.id,
          username: u.username,
          group: u.group,
          phase,
          uiMode,
          caseId,
          status:"OPEN",
          order: order++
        });
      }
    }

    await audit("ASSIGN_ALL", { phase, uiMode, students: users.length, cases: cases.length });
    toast("Assign to all انجام شد.", "ok");
    modalClose();
    openAssignmentsModal();
  };

  $("#modal-body").addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const act = btn.dataset.act;
    const aid = btn.dataset.aid;
    const a = await idbGet("assignments", aid);
    if (!a) return;

    if (act === "as_done") {
      a.status = "DONE";
      await idbPut("assignments", a);
      await audit("MARK_ASSIGNMENT_DONE", { assignmentId: aid, username: a.username, caseId: a.caseId });
      toast("DONE شد.", "ok");
      modalClose();
      openAssignmentsModal();
    }
    if (act === "as_del") {
      if (!confirm("حذف assignment؟")) return;
      await idbDel("assignments", aid);
      await audit("DELETE_ASSIGNMENT", { assignmentId: aid, username: a.username, caseId: a.caseId });
      toast("حذف شد.", "ok");
      modalClose();
      openAssignmentsModal();
    }
  }, { once:true });
}

async function openAuditModal() {
  const logs = (await idbAll("audit")).sort((a,b)=>b.createdAt-a.createdAt).slice(0,400);
  modalOpen("Audit Log (آخرین 400)", `
    <div class="border border-border rounded-2xl bg-bg0/25">
      <div class="scroll max-h-[70vh] overflow-auto">
        ${logs.map(l=>`
          <div class="p-3 border-b border-border">
            <div class="flex items-center justify-between">
              <div class="font-extrabold text-sm">${escapeHtml(l.action)}</div>
              <div class="text-xs muted">${new Date(l.createdAt).toLocaleString("fa-IR")}</div>
            </div>
            <div class="text-xs muted mt-1">
              actor: <span class="mono">${escapeHtml(l.actorUsername||"")}</span>
              • id: <span class="mono">${escapeHtml(l.id)}</span>
            </div>
            <div class="text-xs mono mt-2 whitespace-pre-wrap break-words">${escapeHtml(JSON.stringify(l.detail||{}, null, 2))}</div>
          </div>
        `).join("") || `<div class="p-6 text-sm muted">چیزی ثبت نشده.</div>`}
      </div>
    </div>
  `);
}

/* -----------------------------
   Export CSV
----------------------------- */
async function exportAttemptsCSV() {
  const rows = (await idbAll("attempts")).sort((a,b)=>b.createdAt-a.createdAt);
  if (!rows.length) return toast("داده‌ای برای خروجی نیست.", "warn");

  // Flatten columns
  const flat = rows.map(a => ({
    id: a.id,
    createdAt: new Date(a.createdAt).toISOString(),
    username: a.username,
    role: a.role,
    group: a.group,
    phase: a.phase,
    uiMode: a.uiMode,
    caseId: a.caseId,
    startedAtMs: a.startedAtMs ?? "",
    durationSec: a.durationSec ?? "",
    primaryDx: a.primaryDx ?? "",
    confidence: a.confidence ?? "",
    airway: a.airway ?? "",
    findings: (a.findings||[]).join("|"),
    notesFree: a.notes?.free ?? "",
    q_rotation: a.quality?.rotation ? 1:0,
    q_inspiration: a.quality?.inspiration ? 1:0,
    q_penetration: a.quality?.penetration ? 1:0,
    q_note: a.quality?.note ?? "",
    rf_tension: a.redFlags?.tensionPtx ? 1:0,
    rf_massiveEff: a.redFlags?.massiveEffusion ? 1:0,
    aiAllowed: a.aiAllowed ? 1:0,
    aiShown: a.aiShown ? 1:0,
    truthPrimaryDx: a.truthPrimaryDx ?? "",
    truthFindings: (a.truthFindings||[]).join("|"),
    score: a.score ?? "",
    correctDx: a.correctDx ? 1:0,
    changedAfterAI: a.changedAfterAI ? 1:0,
    primaryDx_afterAI: a.primaryDx_afterAI ?? "",
    confidence_afterAI: a.confidence_afterAI ?? ""
  }));

  const headers = Object.keys(flat[0]);
  const esc = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;
  const csv = [headers.join(","), ...flat.map(r => headers.map(h => esc(r[h])).join(","))].join("\n");

  const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "radmentor_attempts.csv";
  a.click();
  URL.revokeObjectURL(url);

  await audit("EXPORT_CSV", { count: rows.length });
  toast("CSV دانلود شد.", "ok");
}

/* -----------------------------
   Attempt detail
----------------------------- */
function renderAttemptDetail(a) {
  return `
    <div class="grid md:grid-cols-2 gap-4">
      <div class="border border-border rounded-2xl bg-bg0/25 p-4">
        <div class="font-extrabold mb-2">Meta</div>
        <div class="text-sm muted leading-7">
          user: <span class="mono">${escapeHtml(a.username)}</span> (${escapeHtml(a.group)})<br/>
          phase: <span class="mono">${escapeHtml(a.phase)}</span> • mode: <span class="mono">${escapeHtml(a.uiMode)}</span><br/>
          case: <span class="mono">${escapeHtml(a.caseId)}</span><br/>
          duration: <span class="mono">${escapeHtml(String(a.durationSec ?? "—"))}s</span><br/>
          aiAllowed: <span class="mono">${a.aiAllowed? "1":"0"}</span> • aiShown: <span class="mono">${a.aiShown? "1":"0"}</span><br/>
          created: ${new Date(a.createdAt).toLocaleString("fa-IR")}
        </div>

        <div class="sep my-3"></div>
        <div class="font-extrabold mb-2">Score</div>
        <div class="text-sm">
          score: <span class="mono font-extrabold">${escapeHtml(String(a.score ?? "—"))}</span><br/>
          correctDx: <span class="mono">${a.correctDx? "1":"0"}</span><br/>
          truth: <span class="mono">${escapeHtml(a.truthPrimaryDx || "")}</span>
        </div>
      </div>

      <div class="border border-border rounded-2xl bg-bg0/25 p-4">
        <div class="font-extrabold mb-2">Answers</div>
        <div class="text-sm muted leading-7">
          primaryDx: <span class="mono">${escapeHtml(a.primaryDx || "")}</span><br/>
          confidence: <span class="mono">${escapeHtml(a.confidence || "")}</span><br/>
          airway: <span class="mono">${escapeHtml(a.airway || "")}</span><br/>
          findings: <span class="mono">${escapeHtml((a.findings||[]).join(","))}</span><br/>
          notes: <span class="mono">${escapeHtml(a.notes?.free || "")}</span>
        </div>
        <div class="sep my-3"></div>
        <div class="font-extrabold mb-2">After AI (if any)</div>
        <div class="text-sm muted leading-7">
          changedAfterAI: <span class="mono">${a.changedAfterAI? "1":"0"}</span><br/>
          primaryDx_afterAI: <span class="mono">${escapeHtml(a.primaryDx_afterAI||"")}</span><br/>
          confidence_afterAI: <span class="mono">${escapeHtml(a.confidence_afterAI||"")}</span>
        </div>
      </div>
    </div>

    <div class="mt-4 border border-border rounded-2xl bg-bg0/25 p-4">
      <div class="font-extrabold mb-2">Raw JSON</div>
      <pre class="text-xs mono whitespace-pre-wrap break-words">${escapeHtml(JSON.stringify(a, null, 2))}</pre>
    </div>
  `;
}

/* -----------------------------
   Student: pick assignments, do cases
----------------------------- */
async function renderStudent() {
  const sess = state.session;
  const user = await idbGet("users", sess.userId);
  const proto = state.protocol || (await idbAll("protocols")).find(p=>p.active) || defaultProtocol();
  state.protocol = proto;

  const phaseKey = `rm_phase_${user.id}`;
  const currentPhase = localStorage.getItem(phaseKey) || sess.phase || "pilot";
  sess.phase = currentPhase;
  saveSession(sess);

  // get open assignments for this user/phase, sorted by order
  const allAssignments = await idbByIndex("assignments", "userId", user.id);
  const phaseAssignments = allAssignments.filter(a => a.phase === currentPhase).sort((a,b)=>(a.order??999)-(b.order??999));
  const open = phaseAssignments.filter(a => a.status === "OPEN");
  const done = phaseAssignments.filter(a => a.status === "DONE");

  const currentAssignment = open[0] || null;
  const currentCase = currentAssignment ? await idbGet("cases", currentAssignment.caseId) : null;

  app.innerHTML = `
    <div class="grid lg:grid-cols-12 gap-4">
      <section class="lg:col-span-4 grid gap-4">
        ${card("Student Dashboard", "fa-graduation-cap", `
          <div class="flex flex-wrap gap-2 mb-3">
            ${badge(`User: ${sess.username}`, "fa-user")}
            ${badge(`Group: ${sess.group}`, "fa-users")}
            ${badge(`Phase: ${currentPhase}`, "fa-flask")}
          </div>

          <div class="grid gap-2">
            <label class="text-xs muted">تغییر Phase (برای پایلوت)</label>
            <select id="st_phase" class="select">
              ${PHASES.map(p=>`<option value="${p}" ${p===currentPhase?"selected":""}>${p}</option>`).join("")}
            </select>
            <div class="text-xs muted leading-6">
              در نسخه واقعی، Phase باید از سمت Admin و سرور enforce شود.
            </div>
          </div>

          <div class="sep my-4"></div>

          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="border border-border rounded-2xl bg-bg0/25 p-3">
              <div class="muted text-xs">Assignments OPEN</div>
              <div class="text-2xl font-black">${open.length}</div>
            </div>
            <div class="border border-border rounded-2xl bg-bg0/25 p-3">
              <div class="muted text-xs">Assignments DONE</div>
              <div class="text-2xl font-black">${done.length}</div>
            </div>
          </div>

          <div class="sep my-4"></div>

          <button id="btn-st-mydata" class="btn">
            <i class="fa-solid fa-database ml-2"></i>مشاهده تلاش‌های من + CSV
          </button>
        `)}

        ${smallCard("پروتکل فعال", "fa-diagram-project", `
          <div class="text-sm muted leading-7">
            <div>Protocol: <span class="mono">${escapeHtml(proto.name)}</span></div>
            <div>AI lock phases: <span class="mono">${escapeHtml((proto.rules.ai.disableInPhases||[]).join(","))}</span></div>
            <div>AI lock modes: <span class="mono">${escapeHtml((proto.rules.ai.disableInUIModes||[]).join(","))}</span></div>
            <div>AI after submit: <span class="mono">${proto.rules.ai.requireInitialSubmitBeforeAI ? "1":"0"}</span></div>
          </div>
        `)}

        ${smallCard("راهنما", "fa-circle-info", `
          <div class="text-sm muted leading-7">
            1) اگر Assignment نداری، از Admin بخواه کیس‌ها را تخصیص دهد.<br/>
            2) در pre/posttest معمولاً AI قفل است.<br/>
            3) برای گروه AI، AI بعد از پاسخ اولیه فعال می‌شود (در training).
          </div>
        `)}
      </section>

      <section class="lg:col-span-8 grid gap-4">
        ${card("کار روی کیس", "fa-x-ray", `
          ${currentCase ? renderCaseWorkspace(currentCase, currentAssignment, user, currentPhase) : `
            <div class="warnbox text-sm leading-7">
              <div class="font-extrabold mb-1"><i class="fa-solid fa-triangle-exclamation ml-2"></i>Assignment ندارید</div>
              <div>برای این Phase، کیس تخصیص داده نشده یا همه DONE شده‌اند.</div>
              <div class="sep my-3"></div>
              <div class="text-xs muted">ادمین باید از پنل Assignments برای شما کیس تخصیص دهد.</div>
            </div>
          `}
        `)}
      </section>
    </div>
  `;

  $("#st_phase").onchange = (e) => {
    localStorage.setItem(`rm_phase_${user.id}`, e.target.value);
    sess.phase = e.target.value;
    saveSession(sess);
    $("#hdr-phase-text").textContent = e.target.value;
    render();
  };

  $("#btn-st-mydata").onclick = async () => openMyDataModal(user.id);

  // workspace behavior (only if case exists)
  if (currentCase) initCaseWorkspace(currentCase, currentAssignment, user, currentPhase);
}

/* -----------------------------
   Student: Workspace HTML
----------------------------- */
function renderCaseWorkspace(c, assignment, user, phase) {
  return `
    <div class="grid lg:grid-cols-12 gap-4">
      <div class="lg:col-span-7">
        <div class="viewer h-[70vh] soft-shadow">
          <div class="absolute top-3 right-3 z-10 glass border border-border rounded-xl px-3 py-2 text-xs">
            <div class="font-bold">${escapeHtml(c.id)} — ${escapeHtml(c.title)}</div>
            <div class="muted">${escapeHtml(c.sex)}, ${escapeHtml(String(c.age))} | ${escapeHtml(c.view)} | ${escapeHtml(c.complaint||"")}</div>
            <div class="muted mt-1">Assignment: <span class="mono">${escapeHtml(assignment.id)}</span></div>
          </div>

          <div class="absolute top-3 left-3 z-10 flex flex-col gap-2">
            <button id="tool_zoom_in" class="w-10 h-10 rounded-xl glass border border-border hover:border-brand transition flex items-center justify-center" title="زوم +">
              <i class="fa-solid fa-magnifying-glass-plus"></i>
            </button>
            <button id="tool_zoom_out" class="w-10 h-10 rounded-xl glass border border-border hover:border-brand transition flex items-center justify-center" title="زوم -">
              <i class="fa-solid fa-magnifying-glass-minus"></i>
            </button>
            <button id="tool_invert" class="w-10 h-10 rounded-xl glass border border-border hover:border-brand transition flex items-center justify-center" title="معکوس">
              <i class="fa-solid fa-circle-half-stroke"></i>
            </button>
            <button id="tool_reset" class="w-10 h-10 rounded-xl glass border border-border hover:border-brand transition flex items-center justify-center" title="ریست">
              <i class="fa-solid fa-rotate"></i>
            </button>
          </div>

          <div class="absolute bottom-3 right-3 z-10 glass border border-border rounded-xl px-3 py-2 text-[11px] muted">
            <i class="fa-solid fa-triangle-exclamation text-warn ml-1"></i>Not for clinical use
          </div>

          <div class="w-full h-full flex items-center justify-center p-3">
            <div class="w-full h-full relative">
              <img id="xray-img" alt="CXR" src="${escapeHtml(c.imageUrl)}" />
              <div id="heatmap" class="heatmap"></div>
            </div>
          </div>
        </div>

        <div class="mt-3 grid md:grid-cols-3 gap-3">
          ${smallCard("Mode", "fa-toggle-on", `
            <div class="flex bg-bg0 border border-border rounded-xl p-1">
              <button id="btn-mode-training" class="flex-1 px-3 py-2 rounded-lg text-sm">Training</button>
              <button id="btn-mode-exam" class="flex-1 px-3 py-2 rounded-lg text-sm">Exam</button>
            </div>
            <div class="text-xs muted mt-2">در Exam، AI قفل می‌شود (طبق پروتکل).</div>
          `)}

          ${smallCard("Timer", "fa-stopwatch", `
            <div class="flex items-center justify-between">
              <div class="text-2xl font-black" id="timer">00:00</div>
              <button id="btn-start" class="btn btn-mint">شروع</button>
            </div>
            <div class="text-xs muted mt-2">برای ثبت معتبر زمان، اول Start را بزن.</div>
          `)}

          ${smallCard("Progress", "fa-list-check", `
            <div class="text-sm muted leading-7">
              phase: <span class="mono">${escapeHtml(phase)}</span><br/>
              assignment order: <span class="mono">${assignment.order}</span><br/>
              status: <span class="mono">${assignment.status}</span>
            </div>
          `)}
        </div>
      </div>

      <div class="lg:col-span-5">
        <div class="border border-border rounded-2xl bg-panel/70 p-5 soft-shadow h-[70vh] flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="text-lg font-extrabold">فرم تفسیر ساختاریافته</div>
              <div class="text-xs muted">ABCDE + Dx + Confidence + AI (در صورت مجاز)</div>
            </div>
            <div class="text-xs muted">
              <span class="kbd">${escapeHtml(assignment.uiMode)}</span>
            </div>
          </div>

          <div class="scroll flex-1 overflow-y-auto pr-1 space-y-4">
            ${sectionQuality()}
            ${sectionABCDE()}
            ${sectionDx()}
            ${sectionAI(c)}
            ${sectionAfterAI()}
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3">
            <button id="btn-skip" class="btn"><i class="fa-solid fa-forward ml-2"></i>Skip (Mark DONE)</button>
            <button id="btn-submit" class="btn btn-primary"><i class="fa-solid fa-check ml-2"></i>ثبت پاسخ</button>
          </div>
          <div class="text-xs muted mt-2 leading-6">
            در گروه AI: ابتدا ثبت اولیه، سپس (اگر مجاز) AI را ببین و «بعد از AI» را هم ثبت کن.
          </div>
        </div>
      </div>
    </div>
  `;
}

/* Sections (reuse from earlier, expanded) */
function sectionQuality() {
  return `
    <div class="border border-border rounded-2xl bg-bg0/25 p-4">
      <div class="font-extrabold mb-2"><i class="fa-solid fa-camera muted ml-2"></i>RIP — کیفیت فنی</div>
      <div class="grid gap-2 text-sm muted">
        ${chk("q_rotation","Rotation: کلاویکل‌ها هم‌فاصله از مهره‌ها؟")}
        ${chk("q_inspiration","Inspiration: ۸–۱۰ دنده خلفی دیده می‌شود؟")}
        ${chk("q_penetration","Penetration: مهره‌ها پشت قلب دیده می‌شوند؟")}
        <div class="mt-2">
          <label class="text-xs muted">یادداشت کیفیت</label>
          <textarea id="q_note" class="textarea mt-1" rows="2" placeholder="مثلاً Underexposed / rotation خفیف..."></textarea>
        </div>
      </div>
    </div>
  `;
}
function chk(id, label) {
  return `
    <label class="flex items-center gap-2 px-3 py-2 rounded-xl bg-panel2/50 border border-border hover:border-brand transition cursor-pointer">
      <input id="${id}" type="checkbox" class="accent-mint">
      <span>${label}</span>
    </label>
  `;
}
function chk2(id, label) {
  return `
    <label class="flex items-center gap-2 px-3 py-2 rounded-xl bg-panel2/60 border border-border hover:border-brand transition cursor-pointer">
      <input id="${id}" type="checkbox" class="accent-mint">
      <span>${label}</span>
    </label>
  `;
}
function radio(name, val, label) {
  return `
    <label class="flex items-center gap-2 px-3 py-2 rounded-xl bg-panel2/60 border border-border hover:border-brand transition cursor-pointer">
      <input type="radio" name="${name}" value="${val}" class="accent-mint">
      <span>${label}</span>
    </label>
  `;
}

function sectionABCDE() {
  return `
    <div class="border border-border rounded-2xl bg-bg0/25 p-4">
      <div class="font-extrabold mb-2"><i class="fa-solid fa-list-check muted ml-2"></i>ABCDE — بررسی سیستماتیک</div>

      <div class="grid gap-3 text-sm muted">
        <div class="rounded-xl border border-border bg-panel/40 p-3">
          <div class="font-bold text-txt mb-2">A — Airway</div>
          <div class="grid gap-2">
            ${radio("airway","central","تراشه مرکزی")}
            ${radio("airway","deviated","انحراف تراشه")}
          </div>
        </div>

        <div class="rounded-xl border border-border bg-panel/40 p-3">
          <div class="font-bold text-txt mb-2">B — Breathing (Lungs/Pleura)</div>
          <div class="grid md:grid-cols-2 gap-2">
            ${chk2("f_consolidation","Consolidation / Infiltrate")}
            ${chk2("f_pneumothorax","Pneumothorax")}
            ${chk2("f_effusion","Pleural Effusion")}
            ${chk2("f_nodule","Nodule / Mass")}
            ${chk2("f_edema","Pulmonary Edema")}
            ${chk2("f_atelectasis","Atelectasis")}
          </div>
        </div>

        <div class="rounded-xl border border-border bg-panel/40 p-3">
          <div class="font-bold text-txt mb-2">C — Circulation</div>
          <div class="grid md:grid-cols-2 gap-2">
            ${chk2("f_cardiomegaly","Cardiomegaly (CTR>0.5)")}
            ${chk2("f_widened_mediastinum","Widened Mediastinum")}
          </div>
        </div>

        <div class="rounded-xl border border-border bg-panel/40 p-3">
          <div class="font-bold text-txt mb-2">D — Diaphragm</div>
          <div class="grid md:grid-cols-2 gap-2">
            ${chk2("f_free_air","Free air under diaphragm")}
            ${chk2("f_costophrenic_blunt","Blunted costophrenic angle")}
          </div>
        </div>

        <div class="rounded-xl border border-border bg-panel/40 p-3">
          <div class="font-bold text-txt mb-2">E — Everything else</div>
          <div class="grid md:grid-cols-2 gap-2">
            ${chk2("f_fracture","Rib fracture")}
            ${chk2("f_device","Lines / tubes present")}
          </div>
        </div>

        <div>
          <label class="text-xs muted">یادداشت آزاد</label>
          <textarea id="note_free" class="textarea mt-1" rows="3" placeholder="شرح: consolidation در RLL، silhouette sign ..."></textarea>
        </div>
      </div>
    </div>
  `;
}
<script>
/* ===========================
   CONTINUATION (from sectionDx onwards)
   Paste from HERE replacing your incomplete sectionDx and below.
=========================== */

function sectionDx() {
  return `
    <div class="border border-border rounded-2xl bg-bg0/25 p-4">
      <div class="font-extrabold mb-2"><i class="fa-solid fa-stethoscope muted ml-2"></i>جمع‌بندی تشخیصی</div>

      <div class="grid gap-3 text-sm">
        <div>
          <label class="text-xs muted">تشخیص اصلی (Primary Dx)</label>
          <select id="primaryDx" class="select mt-1">
            <option value="">انتخاب کنید…</option>
            <option value="normal">Normal</option>
            <option value="pneumonia">Pneumonia</option>
            <option value="pneumothorax">Pneumothorax</option>
            <option value="effusion">Pleural Effusion</option>
            <option value="chf">CHF / Congestion</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div>
          <label class="text-xs muted">سطح اطمینان (Confidence)</label>
          <div class="mt-1 grid grid-cols-3 gap-2">
            <button type="button" class="btn conf" data-conf="low">پایین</button>
            <button type="button" class="btn conf" data-conf="med">متوسط</button>
            <button type="button" class="btn conf" data-conf="high">بالا</button>
          </div>
          <input type="hidden" id="confidence" value="" />
        </div>

        <div class="dangerbox text-xs muted leading-7">
          <div class="font-extrabold text-danger mb-2"><i class="fa-solid fa-triangle-exclamation ml-2"></i>Red Flags</div>
          <div class="grid gap-2">
            ${chk2("rf_tension_ptx","Tension pneumothorax (shift/hemodynamic)")}
            ${chk2("rf_massive_effusion","Massive effusion / mediastinal shift")}
          </div>
        </div>
      </div>
    </div>
  `;
}

function sectionAI(c) {
  // panel content always exists, but locked by policy in initCaseWorkspace()
  const probs = c.ai?.probs || { pneumonia:.2, pneumothorax:.2, effusion:.2, cardiomegaly:.2, normal:.2 };
  return `
    <div class="border border-border rounded-2xl bg-bg0/25 p-4">
      <div class="font-extrabold mb-2"><i class="fa-solid fa-robot muted ml-2"></i>بازخورد AI (برای گروه مداخله)</div>

      <div id="ai-box" class="grid gap-3">
        <div id="ai-hint" class="text-xs muted leading-6"></div>

        <div class="grid grid-cols-2 gap-2">
          <button id="btn-ai-toggle" class="btn btn-mint"><i class="fa-solid fa-wand-magic-sparkles ml-2"></i>Grad-CAM</button>
          <button id="btn-ai-showprobs" class="btn"><i class="fa-solid fa-chart-simple ml-2"></i>Probabilities</button>
        </div>

        <div id="ai-probs" class="hidden grid md:grid-cols-2 gap-2 text-xs">
          ${probRow("Pneumonia", probs.pneumonia)}
          ${probRow("Pneumothorax", probs.pneumothorax)}
          ${probRow("Effusion", probs.effusion)}
          ${probRow("Cardiomegaly", probs.cardiomegaly)}
          ${probRow("Normal", probs.normal)}
        </div>

        <div class="warnbox text-xs muted leading-7">
          <div class="font-extrabold mb-1"><i class="fa-solid fa-flask ml-2"></i>یادآوری پژوهشی</div>
          <div>خروجی AI «مکمل قضاوت انسانی» است و طبق Phase/Mode قفل می‌شود.</div>
        </div>
      </div>
    </div>
  `;
}

function probRow(name, p) {
  const v = (Math.round((p||0)*100)/100).toFixed(2);
  return `
    <div class="rounded-xl border border-border bg-panel/60 p-2 flex items-center justify-between">
      <span class="muted">${escapeHtml(name)}</span>
      <span class="mono text-txt">${v}</span>
    </div>
  `;
}

function sectionAfterAI() {
  return `
    <div class="border border-border rounded-2xl bg-bg0/25 p-4">
      <div class="font-extrabold mb-2"><i class="fa-solid fa-pen-to-square muted ml-2"></i>بعد از دیدن AI (فقط گروه AI)</div>

      <div id="afterai-box" class="grid gap-3 opacity-50 pointer-events-none">
        <div class="text-xs muted leading-6" id="afterai-hint">
          ابتدا پاسخ اولیه را ثبت کنید؛ سپس (اگر مجاز باشد) AI فعال می‌شود و این بخش باز می‌شود.
        </div>

        <label class="flex items-center gap-2 px-3 py-2 rounded-xl border border-border bg-panel/50 cursor-pointer">
          <input id="changedAfterAI" type="checkbox" class="accent-mint" />
          <span class="text-sm">بعد از دیدن AI نظرم تغییر کرد</span>
        </label>

        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs muted">Primary Dx (after AI)</label>
            <select id="primaryDx_afterAI" class="select mt-1">
              <option value="">—</option>
              <option value="normal">Normal</option>
              <option value="pneumonia">Pneumonia</option>
              <option value="pneumothorax">Pneumothorax</option>
              <option value="effusion">Pleural Effusion</option>
              <option value="chf">CHF / Congestion</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div>
            <label class="text-xs muted">Confidence (after AI)</label>
            <div class="mt-1 grid grid-cols-3 gap-2">
              <button type="button" class="btn conf2" data-conf2="low">پایین</button>
              <button type="button" class="btn conf2" data-conf2="med">متوسط</button>
              <button type="button" class="btn conf2" data-conf2="high">بالا</button>
            </div>
            <input type="hidden" id="confidence_afterAI" value="" />
          </div>
        </div>

        <div class="text-xs muted leading-6">
          نکته: برای تحلیل، هر دو پاسخ «قبل» و «بعد» ذخیره می‌شوند (اگر بخش فعال باشد).
        </div>
      </div>
    </div>
  `;
}

/* -----------------------------
   Confidence button handlers
----------------------------- */
document.addEventListener("click", (e) => {
  const b1 = e.target.closest(".conf");
  if (b1) {
    const v = b1.dataset.conf;
    $("#confidence").value = v;
    $$(".conf").forEach(x => x.classList.remove("ring-2","ring-mint"));
    b1.classList.add("ring-2","ring-mint");
  }

  const b2 = e.target.closest(".conf2");
  if (b2) {
    const v = b2.dataset.conf2;
    $("#confidence_afterAI").value = v;
    $$(".conf2").forEach(x => x.classList.remove("ring-2","ring-mint"));
    b2.classList.add("ring-2","ring-mint");
  }
});

/* -----------------------------
   Viewer ops
----------------------------- */
function applyViewer() {
  const img = $("#xray-img");
  if (!img) return;
  const { zoom, invert, brightness, contrast } = state.viewer;
  img.style.transform = `scale(${zoom})`;
  img.style.filter = `invert(${invert?1:0}) brightness(${brightness}%) contrast(${contrast}%)`;
}

function setHeatmap(c, on) {
  const hm = $("#heatmap");
  if (!hm) return;
  hm.classList.toggle("on", !!on);
  if (!on) return;
  const h = c.ai?.heatmap || { x:50, y:50, r:30 };
  hm.style.background = `
    radial-gradient(circle at ${h.x}% ${h.y}%,
      rgba(255,0,0,.55) 0%,
      rgba(255,165,0,.30) ${h.r}%,
      rgba(255,255,0,.12) ${Math.min(70,h.r+18)}%,
      transparent ${Math.min(95,h.r+35)}%)
  `;
}

/* -----------------------------
   Timer
----------------------------- */
let timerInt = null;
function startTimer() {
  if (state.current.started) return;
  state.current.started = true;
  state.current.startedAtMs = nowMs();
  $("#btn-start").disabled = true;
  $("#btn-start").textContent = "در حال اجرا";
  tick();
  timerInt = setInterval(tick, 500);
}
function stopTimer() {
  if (timerInt) clearInterval(timerInt);
  timerInt = null;
  state.current.started = false;
  state.current.startedAtMs = null;
  const t = $("#timer");
  if (t) t.textContent = "00:00";
}
function tick() {
  const t = $("#timer");
  if (!t || !state.current.startedAtMs) return;
  const sec = Math.floor((nowMs() - state.current.startedAtMs)/1000);
  t.textContent = fmtTimeSec(sec);
}

/* -----------------------------
   Collect + Score + Save Attempt
----------------------------- */
function collectInitialForm() {
  const findings = [];
  const map = [
    ["f_consolidation","consolidation"],
    ["f_pneumothorax","pneumothorax"],
    ["f_effusion","effusion"],
    ["f_cardiomegaly","cardiomegaly"],
    ["f_edema","edema"],
    ["f_nodule","nodule"],
    ["f_atelectasis","atelectasis"],
    ["f_widened_mediastinum","widened_mediastinum"],
    ["f_free_air","free_air"],
    ["f_costophrenic_blunt","blunted_cp"],
    ["f_fracture","fracture"],
    ["f_device","device"]
  ];
  map.forEach(([id,val]) => { if ($("#"+id)?.checked) findings.push(val); });

  const airway = document.querySelector('input[name="airway"]:checked')?.value || "";
  const primaryDx = $("#primaryDx")?.value || "";
  const confidence = $("#confidence")?.value || "";

  return {
    quality: {
      rotation: $("#q_rotation")?.checked || false,
      inspiration: $("#q_inspiration")?.checked || false,
      penetration: $("#q_penetration")?.checked || false,
      note: $("#q_note")?.value || ""
    },
    airway,
    findings,
    primaryDx,
    confidence,
    redFlags: {
      tensionPtx: $("#rf_tension_ptx")?.checked || false,
      massiveEffusion: $("#rf_massive_effusion")?.checked || false
    },
    notes: { free: $("#note_free")?.value || "" }
  };
}

function collectAfterAIForm() {
  return {
    changedAfterAI: $("#changedAfterAI")?.checked || false,
    primaryDx_afterAI: $("#primaryDx_afterAI")?.value || "",
    confidence_afterAI: $("#confidence_afterAI")?.value || ""
  };
}

function jaccard(aArr, bArr) {
  const a = new Set(aArr || []);
  const b = new Set(bArr || []);
  const inter = [...a].filter(x => b.has(x)).length;
  const union = new Set([...a, ...b]).size || 1;
  return inter/union;
}

function scoreAttempt(caseObj, primaryDx, findings) {
  const truthDx = caseObj.truth?.primaryDx || "";
  const truthFind = caseObj.truth?.findings || [];
  const okDx = (primaryDx === truthDx);
  const wDx = state.protocol?.rules?.scoring?.dxWeight ?? 70;
  const wFi = state.protocol?.rules?.scoring?.findingsWeight ?? 30;
  const jac = jaccard(findings, truthFind);
  const score = Math.round((okDx ? wDx : 0) + (wFi * jac));
  return { score, correctDx: okDx, truthPrimaryDx: truthDx, truthFindings: truthFind };
}

/* -----------------------------
   Student workspace init + AI lock logic
----------------------------- */
function initCaseWorkspace(c, assignment, user, phase) {
  // init current state
  state.current.assignmentId = assignment.id;
  state.current.caseId = c.id;
  state.current.aiShown = false;

  // default mode from assignment
  let uiMode = assignment.uiMode || "training";
  setModeButtons(uiMode);

  // viewer tools
  $("#tool_zoom_in").onclick = () => { state.viewer.zoom = Math.min(3, state.viewer.zoom + 0.1); applyViewer(); };
  $("#tool_zoom_out").onclick = () => { state.viewer.zoom = Math.max(0.7, state.viewer.zoom - 0.1); applyViewer(); };
  $("#tool_invert").onclick = () => { state.viewer.invert = !state.viewer.invert; applyViewer(); };
  $("#tool_reset").onclick = () => { state.viewer = { zoom:1, invert:false, brightness:100, contrast:100 }; applyViewer(); };

  $("#btn-mode-training").onclick = () => { uiMode="training"; setModeButtons(uiMode); enforceAILocks(); };
  $("#btn-mode-exam").onclick = () => { uiMode="exam"; setModeButtons(uiMode); enforceAILocks(); };

  // timer
  $("#btn-start").onclick = () => startTimer();

  // AI buttons
  $("#btn-ai-showprobs").onclick = () => $("#ai-probs").classList.toggle("hidden");
  $("#btn-ai-toggle").onclick = () => {
    if (!enforceAILocks(true)) return;
    state.current.aiShown = !state.current.aiShown;
    setHeatmap(c, state.current.aiShown);
  };

  // submit flow
  let initialSubmitted = false;

  $("#btn-submit").onclick = async () => {
    if (!state.current.startedAtMs) return toast("برای ثبت زمان، اول Start را بزن.", "error");

    // initial submit
    if (!initialSubmitted) {
      const base = collectInitialForm();
      if (!base.primaryDx) return toast("تشخیص اصلی را انتخاب کنید.", "error");

      const durationSec = Math.floor((nowMs() - state.current.startedAtMs)/1000);

      const scored = scoreAttempt(c, base.primaryDx, base.findings);
      const attemptDraft = {
        id: "att-" + uuid(),
        createdAt: nowMs(),
        userId: user.id,
        username: user.username,
        role: user.role,
        group: user.group,
        protocolId: state.protocol?.id || "",
        phase,
        uiMode,
        assignmentId: assignment.id,
        caseId: c.id,
        startedAtMs: state.current.startedAtMs,
        durationSec,

        ...base,

        // AI info at initial moment
        aiAllowed: false,     // set by policy after we know initialSubmitted
        aiShown: false,

        // truth + score from initial
        truthPrimaryDx: scored.truthPrimaryDx,
        truthFindings: scored.truthFindings,
        score: scored.score,
        correctDx: scored.correctDx,

        // after-AI fields (to be filled)
        changedAfterAI: false,
        primaryDx_afterAI: "",
        confidence_afterAI: ""
      };

      // Save draft to memory
      state.current._draft = attemptDraft;
      initialSubmitted = true;

      toast("پاسخ اولیه ثبت شد.", "ok");

      // enforce AI after initial submit
      const allowedNow = canUseAI({ user, phase, uiMode, initialSubmitted:true });
      attemptDraft.aiAllowed = allowedNow;

      // unlock after-AI box only if allowed
      if (allowedNow) {
        $("#afterai-box").classList.remove("opacity-50","pointer-events-none");
        $("#afterai-hint").textContent = "AI فعال است. اگر نظرت تغییر کرد، این بخش را پر کن و دوباره «ثبت پاسخ» را بزن.";
        $("#ai-hint").innerHTML = `AI فعال است (گروه <span class="kbd">AI</span>). برای Grad-CAM روی دکمه بزن.`;
        $("#btn-submit").innerHTML = `<i class="fa-solid fa-check ml-2"></i>ثبت نهایی (After AI)`;
        enforceAILocks(); // update lock UI
      } else {
        // finalize right away (no after-AI stage)
        await finalizeAttemptAndClose(assignment, attemptDraft);
      }
      return;
    }

    // final submit (after AI)
    const draft = state.current._draft;
    if (!draft) return toast("Draft پیدا نشد. صفحه را رفرش نکن 🙂", "error");

    const after = collectAfterAIForm();
    draft.changedAfterAI = !!after.changedAfterAI;
    draft.primaryDx_afterAI = after.primaryDx_afterAI || "";
    draft.confidence_afterAI = after.confidence_afterAI || "";

    // Update aiShown
    draft.aiShown = !!state.current.aiShown;

    // If changedAfterAI is true but primaryDx_afterAI empty -> warn
    if (draft.changedAfterAI && !draft.primaryDx_afterAI) {
      return toast("اگر تغییر کردی، Dx بعد از AI را انتخاب کن.", "error");
    }

    // Re-score if changed and provided new Dx (use afterAI Dx as final)
    const finalDx = (draft.changedAfterAI && draft.primaryDx_afterAI) ? draft.primaryDx_afterAI : draft.primaryDx;
    const rescored = scoreAttempt(c, finalDx, draft.findings);
    draft.score = rescored.score;
    draft.correctDx = rescored.correctDx;

    await finalizeAttemptAndClose(assignment, draft);
  };

  $("#btn-skip").onclick = async () => {
    if (!confirm("این Assignment به DONE تبدیل شود بدون ثبت Attempt؟")) return;
    assignment.status = "DONE";
    await idbPut("assignments", assignment);
    await audit("SKIP_ASSIGNMENT_DONE", { assignmentId: assignment.id, caseId: assignment.caseId, username: user.username });
    toast("DONE شد.", "ok");
    stopTimer();
    render();
  };

  function setModeButtons(mode) {
    const a = $("#btn-mode-training");
    const b = $("#btn-mode-exam");
    if (mode === "training") {
      a.className = "flex-1 px-3 py-2 rounded-lg text-sm bg-brand text-white font-extrabold";
      b.className = "flex-1 px-3 py-2 rounded-lg text-sm muted";
    } else {
      b.className = "flex-1 px-3 py-2 rounded-lg text-sm bg-brand text-white font-extrabold";
      a.className = "flex-1 px-3 py-2 rounded-lg text-sm muted";
    }
    assignment.uiMode = mode; // reflect for this session UI (not persisted)
  }

  function enforceAILocks(showToast=false) {
    const box = $("#ai-box");
    const allowed = canUseAI({ user, phase, uiMode, initialSubmitted });
    if (box) {
      box.classList.toggle("opacity-50", !allowed);
      box.classList.toggle("pointer-events-none", !allowed);
    }
    const hint = $("#ai-hint");
    if (hint) {
      hint.textContent = allowed
        ? "AI فعال است. (در صورت نیاز Grad-CAM و Probabilities را باز کن.)"
        : "AI قفل است (Phase/Mode یا گروه کنترل یا هنوز پاسخ اولیه ثبت نشده).";
    }
    if (!allowed) {
      state.current.aiShown = false;
      setHeatmap(c, false);
      if (showToast) toast("AI در این مرحله/حالت مجاز نیست.", "error");
    }
    return allowed;
  }

  async function finalizeAttemptAndClose(assignment, attemptObj) {
    // persist attempt
    await idbPut("attempts", attemptObj);
    await audit("SUBMIT_ATTEMPT", { attemptId: attemptObj.id, username: attemptObj.username, caseId: attemptObj.caseId, phase: attemptObj.phase });

    // mark assignment done
    assignment.status = "DONE";
    await idbPut("assignments", assignment);
    await audit("MARK_ASSIGNMENT_DONE", { assignmentId: assignment.id, caseId: assignment.caseId, username: user.username });

    toast("ثبت شد و Assignment DONE شد.", "ok");
    stopTimer();
    state.current._draft = null;
    render();
  }

  // initial enforce
  enforceAILocks();
  applyViewer();
  setHeatmap(c, false);
}

/* -----------------------------
   Student: My Data modal
----------------------------- */
async function openMyDataModal(userId) {
  const all = (await idbByIndex("attempts", "userId", userId)).sort((a,b)=>b.createdAt-a.createdAt);
  const rows = all.slice(0, 500);

  modalOpen("تلاش‌های من (آخرین 500)", `
    <div class="grid gap-3">
      <div class="flex gap-2 justify-end">
        <button id="btn-myexport" class="btn"><i class="fa-solid fa-file-csv ml-2"></i>CSV من</button>
      </div>
      <div class="border border-border rounded-2xl bg-bg0/25">
        <div class="scroll max-h-[70vh] overflow-auto">
          ${rows.length ? rows.map(a => `
            <div class="p-3 border-b border-border">
              <div class="flex items-center justify-between">
                <div class="font-extrabold">${escapeHtml(a.caseId)} <span class="text-xs muted">(${a.phase} • ${a.uiMode})</span></div>
                <div class="text-xs muted">${new Date(a.createdAt).toLocaleString("fa-IR")}</div>
              </div>
              <div class="mt-2 grid md:grid-cols-4 gap-2 text-xs">
                <div class="bg-panel/60 border border-border rounded-xl p-2">Dx: <span class="mono">${escapeHtml(a.primaryDx||"")}</span></div>
                <div class="bg-panel/60 border border-border rounded-xl p-2">Truth: <span class="mono">${escapeHtml(a.truthPrimaryDx||"")}</span></div>
                <div class="bg-panel/60 border border-border rounded-xl p-2">Score: <span class="mono">${escapeHtml(String(a.score ?? "—"))}</span></div>
                <div class="bg-panel/60 border border-border rounded-xl p-2">AI: <span class="mono">${a.aiAllowed ? (a.aiShown ? "shown":"allowed") : "locked"}</span></div>
              </div>
              <div class="mt-2 flex gap-2">
                <button class="btn" data-act="viewattempt" data-aid="${a.id}"><i class="fa-solid fa-eye ml-2"></i>جزئیات</button>
              </div>
            </div>
          `).join("") : `<div class="p-6 text-sm muted">تلاشی ثبت نشده.</div>`}
        </div>
      </div>
    </div>
  `);

  $("#btn-myexport").onclick = async () => {
    // reuse exportAttemptsCSV but filtered
    const rows = (await idbByIndex("attempts", "userId", userId)).sort((a,b)=>b.createdAt-a.createdAt);
    if (!rows.length) return toast("داده‌ای نیست.", "warn");

    const flat = rows.map(a => ({
      id: a.id,
      createdAt: new Date(a.createdAt).toISOString(),
      username: a.username,
      group: a.group,
      phase: a.phase,
      uiMode: a.uiMode,
      caseId: a.caseId,
      durationSec: a.durationSec ?? "",
      primaryDx: a.primaryDx ?? "",
      confidence: a.confidence ?? "",
      findings: (a.findings||[]).join("|"),
      aiAllowed: a.aiAllowed ? 1:0,
      aiShown: a.aiShown ? 1:0,
      changedAfterAI: a.changedAfterAI ? 1:0,
      primaryDx_afterAI: a.primaryDx_afterAI ?? "",
      confidence_afterAI: a.confidence_afterAI ?? "",
      truthPrimaryDx: a.truthPrimaryDx ?? "",
      score: a.score ?? "",
      correctDx: a.correctDx ? 1:0
    }));
    const headers = Object.keys(flat[0]);
    const esc = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;
    const csv = [headers.join(","), ...flat.map(r => headers.map(h => esc(r[h])).join(","))].join("\n");

    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `radmentor_${state.session?.username || "me"}_attempts.csv`;
    a.click();
    URL.revokeObjectURL(url);

    await audit("EXPORT_MY_CSV", { userId, count: rows.length });
    toast("CSV دانلود شد.", "ok");
  };

  $("#modal-body").addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-act=viewattempt]");
    if (!btn) return;
    const a = await idbGet("attempts", btn.dataset.aid);
    if (!a) return;
    modalOpen("جزئیات Attempt", renderAttemptDetail(a));
  }, { once:true });
}

/* -----------------------------
   Router: render
----------------------------- */
async function render() {
  await refreshHeader();

  if (!state.session) return renderLogin();

  // load protocol each time (safe)
  const protos = await idbAll("protocols");
  state.protocol = protos.find(p=>p.active) || protos[0] || defaultProtocol();

  if (state.session.role === "ADMIN") return renderAdmin();
  return renderStudent();
}

/* -----------------------------
   Logout
----------------------------- */
$("#btn-logout").onclick = async () => {
  if (!state.session) return;
  await audit("LOGOUT", { username: state.session.username });
  state.session = null;
  clearSession();
  toast("خارج شدید.", "ok");
  render();
};

/* -----------------------------
   Boot
----------------------------- */
(async function boot() {
  db = await idbOpen();
  await seedIfNeeded();

  // load session
  const sess = loadSession();
  if (sess) {
    state.session = sess;
    // ensure protocol exists
    const protos = await idbAll("protocols");
    state.protocol = protos.find(p=>p.active) || protos[0] || defaultProtocol();
    if (!protos.length) await idbPut("protocols", state.protocol);
  }
  await refreshHeader();
  render();
})();
</script>
</body>
</html>
